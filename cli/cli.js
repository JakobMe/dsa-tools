#!/usr/bin/env node
var Program=require("commander"),Colors=require("colors"),MOD_MIN=0,SKILL_MIN=0,ATTR_MIN=0,ROLLS_MIN=1,ROLLS_ATTR=3,ROLLS_TO_CRIT=2,D_20=20,ROLL_SLIP=20,ROLL_CRIT=1,QUAL_MULTIPLY=2,QUAL_DIVIDE=3,QUAL_MAX=6,QUAL_MIN=0,QUAL_SUCCESS=1,_=function(){function n(n,r){return Math.floor(Math.random()*(r-n+1))+n}function r(n,r){var t=parseInt(n);return isNaN(t)&&(t=r),t}function t(t,i){for(var o=[],e=0;e<r(i,ROLLS_MIN);e++)o.push(n(1,t));return o}function i(n){var t=[];return n.split("/").forEach(function(n){t.push(r(n,ATTR_MIN))}),t}function o(n,r){for(var t=n.toString().length,i=r.toString().length,o=0;o<i-t;o++)n=" "+n;return n.toString()}function e(n){console.log("\t"+(n||""))}function _(n,r,t){e((o(n,r)+". ").grey.dim+t)}function L(n,r,t,i){var _=o("‼",r);t=t||!1,i=i||!1,_=t?_.red:i?_.green:_.grey.dim,e(_+"  "+n.grey.dim)}function s(n,r,t,i,o){return n=n.toString(),r===t?n.green:r===i?n.red:o===!0?n.grey:n}function u(n,r,t){var i=[];return n.forEach(function(n){i.push(s(n.toString(),n,r,t,!0))}),i.join("/".grey)}function a(n,r){return n.toString().yellow+"w"+r.toString()+" "}function l(n){return"("+n.join("/").magenta+") "}function c(n){return"["+n.toString().magenta+"] "}function m(n){var r=n.toString()+" ";return n<MOD_MIN?r.red:n>MOD_MIN?("+"+r).green:("±"+r).grey.dim}function M(n){return("×"+n.toString()).grey.dim}function I(n,r,t,i){var e=o("Σ",t||0)+(r?": ":" ");return e.grey.dim+o(n,i||0).cyan}function S(n,r,t){var i=r||t?" ‼":"";i=r?i.green:t?i.red:i.grey.dim;var e="\tQS "+o(n,QUAL_MAX);return e=n<QUAL_SUCCESS?e.grey.dim:e,e+i+"\t"}function p(n){var r=(-(D_20*ROLLS_ATTR)).toString(),t="\t"+o(n,r);return n<SKILL_MIN?t.red:t.green}function f(n,r){var t=0;return n.forEach(function(n){t+=n===r?1:0}),t}function g(n,r,t,i){var o=Math.ceil(n/QUAL_DIVIDE),e=r?QUAL_SUCCESS:QUAL_MIN,_=r&&i?QUAL_MULTIPLY:t?0:1,L=n===SKILL_MIN?QUAL_SUCCESS:o;return Math.max(Math.min(L*_,QUAL_MAX),e)}return{printLine:e,printList:_,printMsg:L,splitAttr:i,rollDice:t,countRolls:f,calcQuality:g,strQuality:S,strPoints:p,strRepeat:M,strRolls:u,strDice:a,strRoll:s,strAttr:l,strVal:c,strSum:I,strMod:m,toInt:r,indent:o}}(),Commands=function(){function n(n,r,t){r=_.toInt(r,ROLLS_MIN);var i=_.toInt(t.plus,MOD_MIN),o=_.toInt(t.minus,MOD_MIN),e=i-o,L=n*r+e;_.printLine(),_.printLine(_.strDice(r,n)+_.strMod(i-o)),_.printLine(),_.rollDice(n,r).forEach(function(t,i){e+=t;var o=_.strRoll(_.indent(t,L),t,ROLL_CRIT,n);_.printList(i+1,r,o)}),_.printLine(),(r>ROLLS_MIN||i>MOD_MIN||o>MOD_MIN)&&(_.printLine(_.strSum(e,!0,r,L)),_.printLine())}function r(n,r,e){n=_.splitAttr(n),r=_.toInt(r,SKILL_MIN);var L=_.toInt(e.plus,MOD_MIN),s=_.toInt(e.minus,MOD_MIN),u=_.toInt(e.sammel,ROLLS_MIN),a=u>ROLLS_MIN,l=L-s,c=!1,m=!1,M=!1,I=0,S=0;if(n.length!==ROLLS_ATTR)_.printLine(),_.printLine(o.red),_.printLine(i.grey),_.printLine();else{_.printLine(),_.printLine(_.strDice(ROLLS_ATTR,D_20)+_.strAttr(n)+_.strMod(l)+_.strVal(r)+_.strRepeat(u)),_.printLine();for(var p=0;p<u;p++){for(var f=[],g=r+0,R=0;R<n.length;R++){f[R]=_.rollDice(D_20,ROLLS_MIN)[0];var O=Math.max(ATTR_MIN,n[R]+l-I),A=Math.max(ATTR_MIN,f[R]-O);g-=A}var N=_.countRolls(f,ROLL_SLIP)>=ROLLS_TO_CRIT,d=_.countRolls(f,ROLL_CRIT)>=ROLLS_TO_CRIT,T=_.calcQuality(g,d,N,a),v=T<QUAL_SUCCESS;if(m=!!m||N,M=!!M||d,c=!!c||v,S=N?T:S+T,I=d?MOD_MIN:v?I+1:I,_.printList(p+1,u,_.strRolls(f,ROLL_CRIT,ROLL_SLIP)+_.strPoints(g)+_.strQuality(T,d,N)+_.strSum(S,!1,0,QUAL_MAX*u)),N)break}_.printLine(),t(u,M,c,m)}}function t(n,r,t,i){var o=!1,l=!1,c=n>ROLLS_MIN,m=!c&&t,M=!c&&!t;c||t||(l=a),!c&&t&&(l=u),c&&t&&(l=L),r&&(o=s),i&&(o=e),l&&_.printMsg(l,n,m,M),o&&_.printMsg(o,n,i,r),(o||l)&&_.printLine()}var i="(z.B. 11/13/12)",o="Probe im falschen Format!",e="Patzer (automatisch misslungen)",L="Nach misslungenen Proben Malus kumulativ +1",s="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",u="Erfolgsprobe misslungen",a="Erfolgsprobe bestanden";return{roll:n,skill:r}}();[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(r,t){Commands.roll(n,r,t)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,r,t){Commands.skill(n,r,t)}),Program.version("0.0.1").parse(process.argv);