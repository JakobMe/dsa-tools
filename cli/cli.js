#!/usr/bin/env node
var Fuzzy=require("fuzzysearch"),Program=require("commander"),Colors=require("colors"),Path=require("path"),Fs=require("fs"),MOD_MIN=0,SKILL_MIN=0,ATTR_MIN=0,ROLLS_MIN=1,ROLLS_ATTR=3,ROLLS_TO_CRIT=2,D_20=20,ROLL_SLIP=20,ROLL_CRIT=1,QUAL_MULTIPLY=2,QUAL_DIVIDE=3,QUAL_MAX=6,QUAL_MIN=0,QUAL_SUCCESS=1,SEARCH_MAX=10,_=function(){function n(n,r){return Math.floor(Math.random()*(r-n+1))+n}function r(n,r){var t=parseInt(n);return isNaN(t)&&(t=r),t}function t(t,e){for(var i=[],o=0;o<r(e,ROLLS_MIN);o++)i.push(n(1,t));return i}function e(n){var t=[];return n.split("/").forEach(function(n){t.push(r(n,ATTR_MIN))}),t}function i(n,r){for(var t=n.toString().length,e=r.toString().length,i=0;i<e-t;i++)n=" "+n;return n.toString()}function o(n){console.log("\t"+(n||""))}function _(n,r,t){o((i(n,r)+". ").grey.dim+t)}function a(n,r,t,e){var _=i("‼",r);t=t||!1,e=e||!1,_=t?_.red:e?_.green:_.grey.dim,o(_+"  "+n)}function s(n,r,t,e,i){return n=n.toString(),r===t?n.green:r===e?n.red:i===!0?n.grey:n}function u(n,r,t){var e=[];return n.forEach(function(n){e.push(s(n.toString(),n,r,t,!0))}),e.join("/".grey)}function L(n,r){return n.toString().yellow+"w"+r.toString()+" "}function c(n){return"("+n.join("/").magenta+") "}function f(n){return"["+n.toString().magenta+"] "}function l(n){var r=n.toString()+" ";return n<MOD_MIN?r.red:n>MOD_MIN?("+"+r).green:("±"+r).grey.dim}function g(n){return("×"+n.toString()).grey.dim}function m(n,r,t,e){var o=i("Σ",t||0)+(r?": ":" ");return o.grey.dim+i(n,e||0).cyan}function p(n,r,t){var e=r||t?" ‼":"";e=r?e.green:t?e.red:e.grey.dim;var o="\tQS "+i(n,QUAL_MAX);return o=n<QUAL_SUCCESS?o.grey.dim:o,o+e+"\t"}function M(n){var r=(-(D_20*ROLLS_ATTR)).toString(),t="\t"+i(n,r);return n<SKILL_MIN?t.red:t.green}function d(n){return("„"+n.toString()+"”").yellow+" — ".grey.dim}function S(n,r){var t=0;return n.forEach(function(n){t+=n===r?1:0}),t}function I(n,r,t,e){var i=Math.ceil(n/QUAL_DIVIDE),o=r?QUAL_SUCCESS:QUAL_MIN,_=r&&e?QUAL_MULTIPLY:t?0:1,a=n===SKILL_MIN?QUAL_SUCCESS:i;return Math.max(Math.min(a*_,QUAL_MAX),o)}return{printLine:o,printList:_,printMsg:a,splitAttr:e,rollDice:t,countRolls:S,calcQuality:I,strKeyword:d,strQuality:p,strPoints:M,strRepeat:g,strRolls:u,strDice:L,strRoll:s,strAttr:c,strVal:f,strSum:m,strMod:l,toInt:r,indent:i}}(),Commands=function(){function n(n,r,t){r=_.toInt(r,ROLLS_MIN);var e=_.toInt(t.plus,MOD_MIN),i=_.toInt(t.minus,MOD_MIN),o=e-i,a=n*r+o;_.printLine(),_.printLine(_.strDice(r,n)+_.strMod(e-i)),_.printLine(),_.rollDice(n,r).forEach(function(t,e){o+=t;var i=_.strRoll(_.indent(t,a),t,ROLL_CRIT,n);_.printList(e+1,r,i)}),_.printLine(),(r>ROLLS_MIN||e>MOD_MIN||i>MOD_MIN)&&(_.printLine(_.strSum(o,!0,r,a)),_.printLine())}function r(n,r,t){n=_.splitAttr(n),r=_.toInt(r,SKILL_MIN);var e=_.toInt(t.plus,MOD_MIN),s=_.toInt(t.minus,MOD_MIN),u=_.toInt(t.sammel,ROLLS_MIN),L=u>ROLLS_MIN,c=e-s,f=!1,l=!1,g=!1,m=0,p=0;if(n.length!==ROLLS_ATTR)_.printLine(),_.printLine(a.red),_.printLine(o.grey),_.printLine();else{_.printLine(),_.printLine(_.strDice(ROLLS_ATTR,D_20)+_.strAttr(n)+_.strMod(c)+_.strVal(r)+_.strRepeat(u)),_.printLine();for(var M=0;M<u;M++){for(var d=[],S=r+0,I=0;I<n.length;I++){d[I]=_.rollDice(D_20,ROLLS_MIN)[0];var h=Math.max(ATTR_MIN,n[I]+c-m),R=Math.max(ATTR_MIN,d[I]-h);S-=R}var v=_.countRolls(d,ROLL_SLIP)>=ROLLS_TO_CRIT,A=_.countRolls(d,ROLL_CRIT)>=ROLLS_TO_CRIT,O=_.calcQuality(S,A,v,L),N=O<QUAL_SUCCESS;if(l=!!l||v,g=!!g||A,f=!!f||N,p=v?O:p+O,m=A?MOD_MIN:N?m+1:m,_.printList(M+1,u,_.strRolls(d,ROLL_CRIT,ROLL_SLIP)+_.strPoints(S)+_.strQuality(O,A,v)+_.strSum(p,!1,0,QUAL_MAX*u)),v)break}_.printLine(),i(u,g,f,l)}}function t(n,r){var t=Path.join(__dirname+d);Fs.readdir(t,function(t,i){if(_.printLine(),t)console.log(t);else{var o=[],a=!1;i.forEach(function(r){r.startsWith(I)||o.push(r),n.toLowerCase()===r&&(a=r)}),a?e(a,r):(_.printMsg(p.red,o.length,!0),_.printMsg(M.grey.dim,o.length),_.printLine(),o.forEach(function(n,r){_.printList(r+1,o.length,n)}),_.printLine())}})}function e(n,r){var t=Path.join(__dirname+d+n);Fs.readdir(t,function(n,t){var e=_.strKeyword(r),i=r.toLowerCase(),o=!1,a=0,s=[];if(t.forEach(function(n){var r=Path.basename(n,S),t=r.toLowerCase();return i===t?void(o=r):void((Fuzzy(i,t)||Fuzzy(t,i))&&(s.push(r),a++))}),o){var u=_.strKeyword(o);_.printMsg(u+m.green,0,!1,!0)}else a>0?s.forEach(function(n,r){_.printMsg(e+g.cyan,a),_.printLine(),_.printList(r+1,s.length,n),r>=SEARCH_MAX-1}):_.printMsg(e+l.red,0,!0);_.printLine()})}function i(n,r,t,e){var i=!1,o=!1,a=n>ROLLS_MIN,l=!a&&t,g=!a&&!t;a||t||(o=f.green),!a&&t&&(o=c.red),a&&t&&(o=u.grey.dim),r&&(i=L.green),e&&(i=s.red),o&&_.printMsg(o,n,l,g),i&&_.printMsg(i,n,e,r),(i||o)&&_.printLine()}var o="(z.B. 11/13/12)",a="Probe im falschen Format!",s="Patzer (automatisch misslungen)",u="Nach misslungenen Proben Malus kumulativ +1",L="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",c="Erfolgsprobe misslungen",f="Erfolgsprobe bestanden",l="Kein passender Begriff gefunden.",g="Folgende Begriffe wurden gefunden:",m="Suchbegriff gefunden:",p="Thema existiert nicht, folgende sind verfügbar:",M="[dsa suche <thema> <begriff>]",d="/data/",S=".txt",I=".";return{find:t,roll:n,skill:r}}();[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(r,t){Commands.roll(n,r,t)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,r,t){Commands.skill(n,r,t)}),Program.command("suche <thema> <begriff>").description("Regel-Thema nach einem Begriff durchsuchen").action(function(n,r){Commands.find(n,r)}),Program.version("0.0.1").parse(process.argv);