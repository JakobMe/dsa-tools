#!/usr/bin/env node
var Fuzzy=require("fuzzysearch"),Program=require("commander"),Readline=require("readline"),Colors=require("colors"),Path=require("path"),Fs=require("fs"),MOD_MIN=0,SKILL_MIN=0,ATTR_MIN=0,ROLLS_MIN=1,ROLLS_ATTR=3,ROLLS_TO_CRIT=2,D_20=20,ROLL_SLIP=20,ROLL_CRIT=1,QUAL_MULTIPLY=2,QUAL_DIVIDE=3,QUAL_MAX=6,QUAL_MIN=0,QUAL_SUCCESS=1,DATA_PLACEHOLDER="$1",DATA_TITLE=/\[\[(.*?)\]\]/,DATA_ITALIC=/__(.*?)__/,DATA_BOLD=/\*\*(.*?)\*\*/,_=function(){function n(n,r){return Math.floor(Math.random()*(r-n+1))+n}function r(n,r){var t=parseInt(n);return isNaN(t)&&(t=r),t}function t(t,e){for(var i=[],o=0;o<r(e,ROLLS_MIN);o++)i.push(n(1,t));return i}function e(n){var t=[];return n.split("/").forEach(function(n){t.push(r(n,ATTR_MIN))}),t}function i(n,r){for(var t=n.toString().length,e=r.toString().length,i=0;i<e-t;i++)n=" "+n;return n.toString()}function o(n){console.log("\t"+(n||""))}function _(n,r,t){o((i(n,r)+". ").grey.dim+t)}function a(n,r,t,e){var _=i("‼",r);t=t||!1,e=e||!1,_=t?_.red:e?_.green:_.grey.dim,o(_+"  "+n)}function s(n,r,t,e,i){return n=n.toString(),r===t?n.green:r===e?n.red:i===!0?n.grey:n}function u(n,r,t){var e=[];return n.forEach(function(n){e.push(s(n.toString(),n,r,t,!0))}),e.join("/".grey)}function L(n,r){return n.toString().yellow+"w"+r.toString()+" "}function c(n){return"("+n.join("/").magenta+") "}function f(n){return"["+n.toString().magenta+"] "}function l(n){var r=n.toString()+" ";return n<MOD_MIN?r.red:n>MOD_MIN?("+"+r).green:("±"+r).grey.dim}function g(n){var r="×"+n.toString();return n>ROLLS_MIN?r.yellow:r.grey.dim}function p(n,r,t,e){var o=i("Σ",t||0)+(r?": ":" ");return o.grey.dim+i(n,e||0).cyan}function m(n,r,t){var e=r||t?" ‼":"";e=r?e.green:t?e.red:e.grey.dim;var o="\tQS "+i(n,QUAL_MAX);return o=n<QUAL_SUCCESS?o.grey.dim:o,o+e+"\t"}function d(n){var r=(-(D_20*ROLLS_ATTR)).toString(),t="\t"+i(n,r);return n<SKILL_MIN?t.red:t.green}function M(n){return("„"+n.toString()+"“").yellow+" — ".grey.dim}function I(n,r){var t=0;return n.forEach(function(n){t+=n===r?1:0}),t}function A(n,r,t,e){var i=Math.ceil(n/QUAL_DIVIDE),o=r?QUAL_SUCCESS:QUAL_MIN,_=r&&e?QUAL_MULTIPLY:t?0:1,a=n===SKILL_MIN?QUAL_SUCCESS:i;return Math.max(Math.min(a*_,QUAL_MAX),o)}function S(n){return n=n.replace(DATA_TITLE,DATA_PLACEHOLDER.green),n=n.replace(DATA_ITALIC,DATA_PLACEHOLDER.grey.dim),n=n.replace(DATA_BOLD,DATA_PLACEHOLDER.blue)}return{printLine:o,printList:_,printMsg:a,formatLine:S,splitAttr:e,rollDice:t,countRolls:I,calcQuality:A,strKeyword:M,strQuality:m,strPoints:d,strRepeat:g,strRolls:u,strDice:L,strRoll:s,strAttr:c,strVal:f,strSum:p,strMod:l,toInt:r,indent:i}}(),Commands=function(){function n(n,r,t){r=_.toInt(r,ROLLS_MIN);var e=_.toInt(t.plus,MOD_MIN),i=_.toInt(t.minus,MOD_MIN),o=e-i,a=n*r+o;_.printLine(),_.printLine(_.strDice(r,n)+_.strMod(e-i)),_.printLine(),_.rollDice(n,r).forEach(function(t,e){o+=t;var i=_.strRoll(_.indent(t,a),t,ROLL_CRIT,n);_.printList(e+1,r,i)}),_.printLine(),(r>ROLLS_MIN||e>MOD_MIN||i>MOD_MIN)&&(_.printLine(_.strSum(o,!0,r,a)),_.printLine())}function r(n,r,t){n=_.splitAttr(n),r=_.toInt(r,SKILL_MIN);var e=_.toInt(t.plus,MOD_MIN),i=_.toInt(t.minus,MOD_MIN),u=_.toInt(t.sammel,ROLLS_MIN),L=u>ROLLS_MIN,c=e-i,f=!1,l=!1,g=!1,p=0,m=0;if(n.length!==ROLLS_ATTR)_.printLine(),_.printMsg(s.red,0,!0),_.printMsg(a.grey.dim,0),_.printLine();else{_.printLine(),_.printLine(_.strDice(ROLLS_ATTR,D_20)+_.strAttr(n)+_.strMod(c)+_.strVal(r)+_.strRepeat(u)),_.printLine();for(var d=0;d<u;d++){for(var M=[],I=r+0,A=0;A<n.length;A++){M[A]=_.rollDice(D_20,ROLLS_MIN)[0];var S=Math.max(ATTR_MIN,n[A]+c-p),R=Math.max(ATTR_MIN,M[A]-S);I-=R}var h=_.countRolls(M,ROLL_SLIP)>=ROLLS_TO_CRIT,T=_.countRolls(M,ROLL_CRIT)>=ROLLS_TO_CRIT,O=_.calcQuality(I,T,h,L),D=O<QUAL_SUCCESS;if(l=!!l||h,g=!!g||T,f=!!f||D,m=h?O:m+O,p=T?MOD_MIN:D?p+1:p,_.printList(d+1,u,_.strRolls(M,ROLL_CRIT,ROLL_SLIP)+_.strPoints(I)+_.strQuality(O,T,h)+_.strSum(m,!1,0,QUAL_MAX*u)),h)break}_.printLine(),o(u,g,f,l)}}function t(n,r){r=r||"",n=n||"";var t=0===n.length;Fs.readdir(Path.join(__dirname+h),function(i,o){if(_.printLine(),i)_.printMsg(R.red,0,!0);else{var a=[],s=!1;o.forEach(function(r){r.startsWith(C)||a.push(r),n.toLowerCase()===r.toLowerCase()&&(s=r)});var u=a.length;s?e(s,r):(t?_.printMsg(A.cyan,u):_.printMsg(I.red,u,!0),_.printMsg(S.grey.dim,u),_.printLine(),a.forEach(function(n,r){_.printList(r+1,u,n)}),_.printLine())}})}function e(n,r){var t=0===r.length,e=Path.join(__dirname+h+n);Fs.readdir(e,function(o,a){var s=_.strKeyword(r),u=r.toLowerCase(),L=!1,c=0,f=[],l=M.grey.dim;l=l.replace(DATA_PLACEHOLDER,n),a.forEach(function(n){var r=Path.basename(n,T),t=r.toLowerCase();return u===t?void(L=r):void((Fuzzy(u,t)||Fuzzy(t,u))&&(f.push(r),c++))}),L?i(e,L):c>0?(t?_.printMsg(d.cyan,c):_.printMsg(s+m.cyan,c),_.printMsg(l,c),_.printLine(),f.forEach(function(n,r){_.printList(r+1,c,n)}),_.printLine()):(t?_.printMsg(p.red,0,!0):_.printMsg(s+g.red,0,!0),_.printMsg(l,c),_.printLine())})}function i(n,r){var t=n+E+r+T,e=Fs.createReadStream(Path.join(t)).on(v,function(){_.printMsg(R.red,0,!0),_.printLine()});Readline.createInterface({input:e}).on(O,function(n){_.printLine(_.formatLine(n))}).on(D,function(){_.printLine()})}function o(n,r,t,e){var i=!1,o=!1,a=n>ROLLS_MIN,s=!a&&t,g=!a&&!t;a||t||(o=l.green),!a&&t&&(o=f.red),a&&t&&(o=L.grey.dim),r&&(i=c.green),e&&(i=u.red),o&&_.printMsg(o,n,s,g),i&&_.printMsg(i,n,e,r),(i||o)&&_.printLine()}var a="(z.B. 11/13/12)",s="Probe im falschen Format!",u="Patzer (automatisch misslungen)",L="Nach misslungenen Proben Malus kumulativ +1",c="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",f="Erfolgsprobe misslungen",l="Erfolgsprobe bestanden",g="Kein passender Begriff gefunden.",p="Keine Begriffe verfügbar.",m="Folgende Begriffe wurden gefunden:",d="Folgende Begriffe sind verfügbar",M="(dsa suche $1 [begriff])",I="Thema existiert nicht, folgende sind verfügbar:",A="Folgende Themen sind verfügbar:",S="(dsa suche [thema] [begriff])",R="Es ist ein unbekannter Fehler aufgetreten.",h="/data/",T=".txt",O="line",D="close",v="error",E="/",C=".";return{find:t,roll:n,skill:r}}();[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(r,t){Commands.roll(n,r,t)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,r,t){Commands.skill(n,r,t)}),Program.command("suche [thema] [begriff]").description("Regel-Thema nach einem Begriff durchsuchen").action(function(n,r){Commands.find(n,r)}),Program.version("0.0.1").parse(process.argv);