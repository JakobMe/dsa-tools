#!/usr/bin/env node
"use strict";var Program=require("commander"),VERSION="1.0.0",DICE_20="w20",DICE_6="w6",DICE_20_VALUE=20,DICE_6_VALUE=6,ROLLS_MIN=1,ROLL_RESULT_MIN=1,ROLL_CRIT_THRESH=2,MOD_DEFAULT=0,SKILL_MIN=0,SKILL_REST_LENGTH=3,SKILL_LEVEL_THRESH=3,SKILL_LEVEL_LENGTH=2,ATTR_ROLLS=3,ATTR_MIN=8,ATTR_DELIMITER="/",CHAR_TAB="\t",CHAR_BREAK="\r",CHAR_NEWLINE="\n",CHAR_PLACEHOLDER="%s",CHAR_DOT=".",CHAR_SPACE=" ",CHAR_PLUS="+",CHAR_PLUSMINUS="±",CHAR_TIMES="×",CHAR_SUM="Σ",CHAR_COLON=":",CHAR_PAREN_LEFT="(",CHAR_PAREN_RIGHT=")",CHAR_BRACKET_LEFT="[",CHAR_BRACKET_RIGHT="]",CHAR_LEVEL="QS",TEXT_ERROR_ATTR="Wrong attribute format!",TEXT_HINT_ATTR="e.g. 11/13/12",TEXT_HINT_FLOP="Misslungen: Folgeproben kumulativ -1.",TEXT_HINT_FAILURE="Patzer: Sammelprobe misslungen.",TEXT_HINT_SUCCESS="Krit. Erfolg: QS × 2, Erschwernis abgebaut.",_=function(){function _(_,n){return Math.floor(Math.random()*(n-_+1))+_}function n(_,n){var R=parseInt(_);return isNaN(R)&&(R=n),R}function R(R,r){for(var E=[],t=0;t<n(r,1);t++)E.push(_(1,R));return E}function r(_,n){for(var R=_.toString().length,r=n.toString().length,E=0;E<r-R;E++)_=" "+_;return _.toString()}function E(_){console.log("\t"+(_||""))}function t(_,n,R){E((r(_,n)+". ").grey.dim+R)}function A(_,n,R,r){return _=_.toString(),n===R?_.green:n===r?_.red:_}function e(_,n){return _.toString().yellow+"w"+n.toString()+" "}function L(_){var n=_.toString();return _<0?n.red:_>0?("+"+n).green:("±"+n).grey.dim}function o(_,n,R,E){var t=r("Σ",R||0)+(n?": ":" ");return t.grey.dim+r(_,E||0).cyan}return{printLine:E,printList:t,rollDice:R,getDice:e,getRoll:A,getSum:o,getMod:L,toInt:n,indent:r}}(),Commands=function(){function n(n,R,r){R=_.toInt(R,1);var E=_.toInt(r.plus,0),t=_.toInt(r.minus,0),A=E-t,e=n*R+A;_.printLine(),_.printLine(_.getDice(R,n)+_.getMod(E-t)),_.printLine(),_.rollDice(n,R).forEach(function(r,E){A+=r;var t=_.getRoll(_.indent(r,e),r,1,n);_.printList(E+1,R,t)}),_.printLine(),(R>1||E>0||t>0)&&(_.printLine(_.getSum(A,!0,R,e)),_.printLine())}function R(n,R,r){R=_.toInt(R,SKILL_MIN);var E=_.toInt(r.plus,MOD_DEFAULT),t=_.toInt(r.minus,MOD_DEFAULT),A=_.toInt(r.sammel,ROLLS_MIN),e=E-t;if(n=n.split(ATTR_DELIMITER),n.length<ATTR_ROLLS)console.log(CHAR_NEWLINE+CHAR_TAB+TEXT_ERROR_ATTR.red),console.log(CHAR_TAB+TEXT_HINT_ATTR.grey+CHAR_NEWLINE);else{n.forEach(function(R,r){n[r]=_.toInt(R,ATTR_MIN)});var L=CHAR_PLACEHOLDER;L=e<0?L.red:e>0?(CHAR_PLUS+L).green:(CHAR_PLUSMINUS+L).grey.dim;var o=0,T=0,C=CHAR_PLACEHOLDER;C=A>ROLLS_MIN?C.cyan:C.grey.dim,console.log(CHAR_NEWLINE+CHAR_TAB+ATTR_ROLLS.toString().yellow+DICE_20+CHAR_SPACE+CHAR_PAREN_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_PAREN_RIGHT+CHAR_SPACE+L+CHAR_SPACE+CHAR_BRACKET_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_BRACKET_RIGHT+CHAR_SPACE+(CHAR_TIMES+CHAR_PLACEHOLDER).grey.dim+CHAR_NEWLINE,n.join(ATTR_DELIMITER),e,R,A);for(var i=0;i<A;i++){for(var H=R+0,I=[],S=[],a=0,g=0,l=0,m=CHAR_LEVEL+CHAR_SPACE+CHAR_PLACEHOLDER,u=0;u<n.length;u++){var s=n[u],c=_.rollDice(DICE_20_VALUE,ROLLS_MIN)[0];I.push(c),H-=Math.max(0,c-Math.max(0,s+e+o));var N=CHAR_PLACEHOLDER;c===DICE_20_VALUE?(g++,S.push(N.red)):c===ROLL_RESULT_MIN?(a++,S.push(N.green)):S.push(N.grey)}var p=0;0===H?p=1:H>0&&(p=Math.ceil(H/SKILL_LEVEL_THRESH)),l=p,T+=p;var O=CHAR_PLACEHOLDER;O=H>=0?O.green:O.red,a>=ROLL_CRIT_THRESH&&(p=Math.max(1,p),l+=p,T+=p,o=0),g>=ROLL_CRIT_THRESH&&(l=0,T=0),H<0&&o--,p<=0&&(m=m.dim.grey.dim),H=H.toString();for(var f=SKILL_REST_LENGTH-H.length,D=0;D<f;D++)H=CHAR_SPACE+H;if(console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+CHAR_SPACE+S[0]+ATTR_DELIMITER.grey+S[1]+ATTR_DELIMITER.grey+S[2]+CHAR_TAB+O+CHAR_TAB+m+CHAR_TAB+CHAR_SUM.grey.dim+CHAR_SPACE+C,i+1,I[0],I[1],I[2],H,l,T),g>=ROLL_CRIT_THRESH)break}A>ROLLS_MIN&&console.log((CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FLOP+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_SUCCESS+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FAILURE).grey.dim),console.log(CHAR_BREAK)}}return{roll:n,skill:R}}();[100,20,12,10,8,6,4,3,2].forEach(function(_){Program.command("w"+_+" [n]").description("nW"+_+" würfeln").option("-p, --plus <x>","Summe +x").option("-m, --minus <x>","Summe -x").action(function(n,R){Commands.roll(_,n,R)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").action(function(_,n,R){Commands.skill(_,n,R)}),Program.version("0.0.1").parse(process.argv);