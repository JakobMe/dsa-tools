#!/usr/bin/env node
var Program=require("commander"),Colors=require("colors"),Util={randomInt:function(e,n){return Math.floor(Math.random()*(n-e+1))+e},sortAlpha:function(e,n){return e.localeCompare(n)},toInt:function(e){var n=parseInt(e);return isNaN(n)?0:n}},Str=function(){function u(e,n){for(var r=e.toString(),t=e.toString(),o=(void 0===n?"":n).toString(),i=0;i<o.length-t.length;i++)r=" "+r;return r}function n(e,n,r){return n+e.toString()+r}function o(e,n,r,t){var o=e.toString();return n===r?o.green:n===t?o.red:o}function s(e){return e.toString()+"%"}function a(e,n,r,t){return e.replace(r,"").length+n.replace(r,"").length<=t}return{squeeze:a,shorten:function(e,n){return a(e,"...","",n)?e:e.substr(0,n-4)+"..."},linebreaks:function(e,t,o){var i=[];return e.split("\n").forEach(function(e){var r=[""],n=0;e.split(" ").forEach(function(e){a(e,r[n],t,o)||(r[++n]=""),r[n]+=e+" "}),r.forEach(function(e,n){r[n]=e.trim()}),i.push(r.join("\n"))}),i.join("\n")},percent:s,progressbar:function(e,n){var r=e/n,t=s(Math.round(100*r)),o=Math.round(15*r),i="=".repeat(o),a=" ".repeat(15-o);return Str.brackets(" "+i.cyan+a+" ")+t.magenta},indent:u,enclose:n,roll:o,rolls:function(e,n,r){var t=[];return e.forEach(function(e){t.push(o(e,e,n,r))}),t.join("/")},dice:function(e,n){return e.toString()+"w"+n.toString()+" "},attr:function(e){return n(e.join("/"),"(",") ")},brackets:function(e){return n(e,"[","] ")},mod:function(e){var n=e.toString()+" ";return e<0?n.red:0<e?("+"+n).green:("±"+n).grey.dim},times:function(e){var n="×"+e.toString();return n.grey.dim},sum:function(e,n,r,t){var o=u(e,t);return(u("Σ",r)+(n?": ":" ")).grey.dim+o.cyan},cost:function(e){return(e.toString()+" AP").green},quality:function(e,n,r,t,o){var i=n||r?" ‼":"";i=n?i.green:r?i.red:i.grey.dim;var a="\tQS "+u(e,o);return(a=e<t?a.grey.dim:a)+i+"\t"},points:function(e,n){var r="\t"+u(e,-1*n);return e<0?r.red:r.green},raise:function(e,n){var r=e.toString()+" -> "+n.toString();return Str.brackets(r).grey.dim},quote:function(e){return n(e,'"','"')}}}(),Log=function(){var r=require("terminal-kit").terminal;function t(e){r((e||"")+"\n")}function o(e){e="number"!=typeof e?1:e;for(var n=0;n<e;n++)t("")}function u(e,n,r){o(n),t(e),o(r)}function i(e,n,r,t,o,i){var a=Str.indent("‼",n||0);t=t||!1,u((a=(r=r||!1)?a.red:t?a.green:a.grey.dim)+"  "+e,o,i)}return{spaced:u,success:function(e,n,r,t){i(e.green,n,!1,!0,r,t)},empty:o,shout:i,error:function(e,n,r,t){i(e.red,n,!0,!1,r,t)},hint:function(e,n,r,t){i(e.toString().grey.dim,n,!1,!1,r,t)},line:t,list:function(r){r.forEach(function(e,n){t((Str.indent(n+1,r.length)+". ").grey.dim+e)})},back:function(e){for(var n=0;n<(e||1);n++)r.previousLine(1),r.eraseLine()}}}(),Data=function(){var e="/../web/data.json",n="/config.json",t=null,r=null,o=null,i=null;function a(){r=require("path"),t=require("jsonfile"),o=r.join(__dirname+e),i=r.join(__dirname+n)}return{config:function(r){a(),t.readFile(i,function(e,n){r(null!==e?{}:n)})},load:function(r){a(),t.readFile(o,function(e,n){r(null!==e?{}:n)})},save:function(e){a(),t.writeFile(o,e)}}}(),Update=function(){var t="Konfigurationsfehler!",c="Verbindungsfehler!",g="neue Begriffe gefunden",l="Thema existiert nicht, folgende sind verfügbar:",f="dsa aktualisiere [thema] [-e] [-s]",h="*",d="href",m="*:not(h1):not(strong):not(em):not(br):not(p):not(table):not(tr):not(td):not(tbody)",p=null,L=null,v=null,b=!1,S=!1,k=!1,w=0,y=0,$=0,x=0;function P(c){var r,t,o,e={rateLimit:0,maxConnections:_quick?10:1},a=[],i=[],n=new L(e),u=new L(e),l=k.protocol+k.domain;b.forEach(function(e){var s=e.name;c.hasOwnProperty(s)&&!S||(c[s]={}),e.urls.forEach(function(e){y++;var n=encodeURI(l+k.path+e+k.extension);i.push({uri:n,callback:function(e,r,n){if(w++,e)return n(),!1;var t,o,i=r.$(k.btn).filter(function(){return!c[s].hasOwnProperty(M(r.$(this).text().trim()))});x+=i.length,t=x+" "+g,o=Str.progressbar(w,y),Log.empty(1===w?2:0),Log.back(1===w?0:3),Log.success(Str.shorten(t,78),0,0,0),Log.shout(o,0,!1,!1,0,1),i.each(function(){var e=r.$(this),u=M(e.text().trim()),n=encodeURI(e.attr(d));a.push({uri:l+n,callback:function(e,n,r){if($++,e)return r(),!1;var t,o,i,a;c[s][u]=function(r,e){if(!e.length)return"";e.children().contents().filter(function(){var e=3===this.nodeType,n=0===r(this).text().trim().length;return n||e}).remove();for(;0<e.find(m).length;){var n=e.find(m).eq(0);n.replaceWith(n.html().trim())}return e.find(h).each(function(){var n=r(this);Object.keys(this.attribs).forEach(function(e){n.removeAttr(e)})}),v.decodeXML(e.html().trim())}(n.$,n.$(k.text)),t=u,o=$+"/"+x+" ",i=s+" "+Str.quote(t),a=Str.progressbar($,x),Log.empty(1===$?1:0),Log.back(1===$?0:3),Log.success(Str.shorten(o+i,78),0,0,0),Log.shout(a,0,!1,!1,0,1),Data.save(c),r()}})}),n()}})})}),(o=(r=[u,n]).length)===(t=[i,a]).length&&r.forEach(function(e,n){0===n&&e.queue(t[n]),e.on("drain",function(){n+1<o&&r[n+1].queue(t[n+1])})})}function M(e){return e.replace(/I-.*(I|V|X)|\(\*\)|\.\.\.|\*/g,"").trim()}return{start:function(u,s){Data.config(function(e){var n,r;r=function(){var n,r,t,o,i,a;p=require("dns"),L=require("crawler"),v=require("entities"),_quick=s.schnell||!1,S=s.erzwingen||!1,t=u||"",o=[],i=[],a=[],k.topics.forEach(function(e){o.push(e.name),a.push(e),e.name===t.toLowerCase()&&i.push(e)}),(b=t.length?i.length?i:(Log.error(l,o.length,1,0),Log.hint(f,o.length,0,1),Log.list(o),Log.empty(),!1):a)&&(n=function(e){e&&Data.load(P)},r=k.domain.replace("/",""),p.lookup(r,function(e){e?(Log.error(c,0,1,0),Log.hint(r,0,0,1),n(!1)):n(!0)}))},(n=e).hasOwnProperty("btn")&&n.hasOwnProperty("text")&&n.hasOwnProperty("topics")&&n.hasOwnProperty("domain")&&n.hasOwnProperty("protocol")?(k=n,r()):Log.error(t)})}}}(),Dice=function(){var X="Patzer (automatisch misslungen)",G="Nach misslungenen Proben Malus kumulativ +1",H="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",J="Erfolgsprobe misslungen",Y="Erfolgsprobe bestanden",Z=3,t=2,ee=20,ne=20,re=1,te=2,oe=3,ie=6,ae=0,ue=1;function se(e,n){for(var r=[],t=0;t<e;t++)r.push(Util.randomInt(1,n));return r}function ce(e,n){var r=0;return e.forEach(function(e){r+=e===n?1:0}),t<=r}function le(e,t,n,o,i){var a=n+0;return e.forEach(function(e,n){var r=Math.max(0,t[n]+o-i);a-=Math.max(0,e-r)}),a}return{roll:function(t,e,n){e=Math.max(Util.toInt(e),1);var r=Util.toInt(n.mod),o=1<e||r,i=[],a=0;se(e,t).forEach(function(e,n){a+=e;var r=Str.indent(e,t);i.push(Str.roll(r,e,re,t))}),Log.spaced(Str.dice(e,t)+Str.mod(r)),Log.list(i),Log.spaced(o?Str.sum(a+r,!0):"",o?1:0,o?1:0)},skill:function(e,n,r){var t,o,i,a,u,s,c,l,g,f,h,d,m,p,L,v=(t=[],e.split("/").forEach(function(e){t.push(Math.max(Util.toInt(e),0))}),t),b=Math.max(Util.toInt(n),0),S=Util.toInt(r.mod),k=r.wahrscheinlich||!1,w=k?0:Math.max(Util.toInt(r.sammel),1),y=Str.percent(function(e,n,r){for(var t=0,o=1;o<=ee;o++)for(var i=1;i<=ee;i++)for(var a=1;a<=ee;a++)if(ce([o,i,a],re))t++;else if(!ce([o,i,a],ne)){var u=le([o,i,a],e,n,r,0);t+=0<=u?1:0}return Math.round(1/parseFloat(Math.pow(ee,Z))*t*100*100)/100}(v,b,S)),$=1<w,x=!1,P=!1,M=!1,q=[],E=0,I=0;if(v.length!==Z)Log.error("Probe im falschen Format!",0,1,0),Log.hint("z.B. 11/13/12",0,0,1);else{for(var U=0;U<w;U++){var z=(h=b,d=S,m=E,p=se((f=v).length,ee),L=le(p,f,h,d,m),{results:p,points:L}),O=z.results,C=z.points,j=ce(O,ne),D=ce(O,re),N=(o=C,i=D,a=j,u=$,s=Math.ceil(o/oe),c=i?ue:ae,l=i&&u?te:a?0:1,g=0===o?ue:s,Math.max(Math.min(g*l,ie),c)),F=N<ue;if(P=!!P||j,M=!!M||D,x=!!x||F,I=j?N:I+N,E=D?0:F?E+1:E,q.push(Str.rolls(O,re,ee)+Str.points(C,Z*ee)+Str.quality(N,D,j,ue,ie)+Str.sum(I,!1,0,ie*w)),j)break}if(Log.spaced(Str.dice(Str.indent(Z,q.length),ee)+Str.attr(v).magenta+Str.mod(S)+Str.brackets(b).magenta+Str.times(w)+" "+(k?y.cyan:y.grey.dim)),k)return;Log.list(q),A=q.length,B=M,K=x,T=P,V=_=!1,W=!(R=1<A)&&K,Q=!R&&!K,R||K||(V=Y.green),!R&&K&&(V=J.red),R&&K&&(V=G.grey.dim),B&&(_=H.green),T&&(_=X.red),!V&&_&&Log.empty(),V&&Log.shout(V,A,W,Q,1,0),_&&Log.shout(_,A,T,B,0,1),_||Log.empty()}var A,B,K,T,_,V,R,W,Q}}}(),Cost=function(){var o="z.B. 'dsa ap b 12 -s 9'",i={a:{t:12,b:1},b:{t:12,b:2},c:{t:12,b:3},d:{t:12,b:4},e:{t:14,b:15}};return{calculate:function(e,n,r){var t=r.start||n-1;return e=e.toLowerCase(),i.hasOwnProperty(e)?isNaN(t)||isNaN(n)?(Log.error("Werte sind ungültig!",0,1,0),Log.hint(o,0,0,1),!1):void Log.shout(Str.brackets(e.toUpperCase()).magenta+Str.raise(t,n)+Str.cost(function(e,n,r,t){for(var o=0,i=n+1;i<=e;i++)o+=(a=i,u=r,s=t,(Math.max(a-u,0)+1)*s);var a,u,s;return o}(parseInt(n),parseInt(t),i[e].t,i[e].b))):(Log.error("Steigerungsspalte existiert nicht!",0,1,0),Log.hint(o,0,0,1),!1)}}}(),Search=function(){var v="Kein passender Begriff gefunden.",b="Keine Begriffe verfügbar.",S="Folgende Begriffe wurden gefunden:",k="Folgende Begriffe sind verfügbar",w="dsa suche $1 [begriff] [-u] [-r]",y="dsa aktualisiere $1 [-e] [-s]",$=null;return{find:function(s,c,e){($=require("didyoumean")).nullResultValue=!1,c=(c||"").toLowerCase(),s=(s||"").toLowerCase();var l=e.raten||!1,g=e.ungenau||!1;Data.load(function(e){var n,r,t=Object.keys(e).sort(Util.sortAlpha),o=(n=s,0<=(r=t).indexOf(n)?n:$(n,r)),i=0===s.length,a=t.length,u=i?"Folgende Themen sind verfügbar:".green:"Thema existiert nicht, folgende sind verfügbar:".red;a&&o?function(e,o,n,i,r){var t=0===o.length,a=Object.keys(e),u=!1,s=[],c=t?k:S,l=w.replace("$1",n),g=y.replace("$1",n);a.forEach(function(e){var n,r,t;o===e.toLowerCase()?u=e:(n=o,r=e,t=i?require("fuzzysearch"):function(){return!1},n=n.toLowerCase(),r=r.toLowerCase(),(-1!==n.indexOf(r)||t(n,r)||-1!==r.indexOf(n)||t(r,n))&&s.push(e))}),s.sort(Util.sortAlpha);var f,h,d,m,p=u||(f=o,h=s,d=r,$.threshold=null,$.thresholdAbsolute=100,!!d&&$(f,h)),L=s.length;p?Log.spaced((m=e[p],Str.linebreaks(m.replace(/<br\s*[\/]?>|<\/?p[^>]*>/gi,"\n"),/<[^>]*>/gi,80).replace(/<h1>([\s\S]*?)<\/h1>/gi,"$1\n".green).replace(/<strong>([\s\S]*?)<\/strong>/gi,"$1".magenta).replace(/<em>([\s\S]*?)<\/em>/gi,"$1".cyan).trim())):L?(Log.success(c,L),Log.list(s),Log.hint(l,L)):t&&!L?(Log.error(b,L,1,0),Log.hint(g,L,0,1)):(Log.error(v,L,1,0),Log.hint(l,L,0,1))}(e[o],c,o,g,l):a?(Log.shout(u,a,!i,i),Log.list(t),Log.hint("dsa suche [thema] [begriff] [-u] [-r]",a)):(Log.error("Keine Daten gefunden!",a,1,0),Log.hint("dsa aktualisiere [thema] [-e] [-s]",a,0,1))})}}}();!function(){function e(e,n){switch(n||(Log.line("  Examples:"),Log.empty()),e){case"dice":Log.line("    $ dsa w20 3 -m -2"),Log.line("    $ dsa w6 2 --mod 6");break;case"skill":Log.line("    $ dsa probe 13/16/14 6 -m -1"),Log.line("    $ dsa probe 14/13/15 9 -s 7 --mod 1"),Log.line("    $ dsa probe 12/13/11 4 --wahrscheinlich");break;case"cost":Log.line("    $ dsa ap e 15"),Log.line("    $ dsa ap b 14 -s 12"),Log.line("    $ dsa ap c 17 --start 0");break;case"update":Log.line("    $ dsa aktualisiere vorteil"),Log.line("    $ dsa aktualisiere kampf -s"),Log.line("    $ dsa aktualisiere --erzwingen");break;case"search":Log.line("    $ dsa suche"),Log.line("    $ dsa suche kultur"),Log.line("    $ dsa suche zauber ignifaxius"),Log.line("    $ dsa suche kampf wucht --raten"),Log.line('    $ dsa suche vorteil "verbessert leben" -ru'),Log.line('    $ dsa suche nachteil "schlechte energie" -u')}Log.empty()}[2,3,4,6,8,10,12,20,100].forEach(function(r){Program.command("w"+r+" [n]").description("N w"+r+" würfeln").option("-m, --mod <x>","Summenmodifikator").action(function(e,n){Dice.roll(r,e,n)}).on("--help",function(){e("dice")})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --mod <x>","Modifikator der Probe").option("-s, --sammel <n>","Sammelprobe mit N Versuchen").option("-w, --wahrscheinlich","Nur die Wahrscheinlichkeit anzeigen").action(function(e,n,r){Dice.skill(e,n,r)}).on("--help",function(){e("skill")}),Program.command("ap <spalte> <wert>").description("Steigerungskosten berechnen").option("-s, --start <x>","Startwert").action(function(e,n,r){Cost.calculate(e,n,r)}).on("--help",function(){e("cost")}),Program.command("suche [thema] [begriff]").description("In einem Thema nach Begriff suchen").option("-u, --ungenau","Ungenaue Suche durchführen").option("-r, --raten","Suchergebnis raten").action(function(e,n,r){Search.find(e,n,r)}).on("--help",function(){e("search")}),Program.command("aktualisiere [thema]").description("Daten aktualisieren").option("-e, --erzwingen","Aktualisierung erzwingen").option("-s, --schnell","Mehr Verbindungen erlauben").action(function(e,n){Update.start(e,n)}).on("--help",function(){e("update")}),Program.version("0.0.1").description("Kommandozeilen-Tools für 'Das Schwarze Auge'").on("--help",function(){e("dice"),e("skill",!0),e("cost",!0),e("update",!0),e("search",!0)}).parse(process.argv),Program.args.length||Program.help()}();