#!/usr/bin/env node
var Program=require("commander"),Colors=require("colors"),Terminal=require("terminal-kit").terminal,MOD_MIN=0,SKILL_MIN=0,ATTR_MIN=0,ROLLS_MIN=1,ROLLS_ATTR=3,ROLLS_TO_CRIT=2,D_20=20,ROLL_SLIP=20,ROLL_CRIT=1,QUAL_MULTIPLY=2,QUAL_DIVIDE=3,QUAL_MAX=6,QUAL_MIN=0,QUAL_SUCCESS=1,C_T="++",C_B="==",C_P="__",C_I="--",REGEX_REPLACE="$1",REGEX_H=/\+\+(.*?)\+\+/g,REGEX_B=/==(.*?)==/g,REGEX_I=/--(.*?)--/g,REGEX_P=/__/g,REGEX_HASH=/#(?!#)/g,REGEX_LVL=/ I-.*(I|V|X)/,REGEX_STAR=/ \(\*\)/,REGEX_DOTS=/ \.\.\./,F=function(){function n(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n,t){var r=parseInt(n);return isNaN(r)&&(r=t),r}function r(r,e){for(var i=[],o=0;o<t(e,ROLLS_MIN);o++)i.push(n(1,r));return i}function e(n){var r=[];return n.split("/").forEach(function(n){r.push(t(n,ATTR_MIN))}),r}function i(n,t){for(var r=n.toString().length,e=t.toString().length,i=0;i<e-r;i++)n=" "+n;return n.toString()}function o(n){Terminal((n||"")+"\n")}function a(n){for(var t=0;t<(n||1);t++)Terminal.previousLine(1),Terminal.eraseLine()}function u(n){for(var t=0;t<(n||1);t++)o("")}function s(n,t,r){o((i(n,t)+". ").grey.dim+r)}function c(n,t,r,e){var a=i("‼",t);r=r||!1,e=e||!1,a=r?a.red:e?a.green:a.grey.dim,o(a+"  "+n)}function f(n,t,r,e,i){return n=n.toString(),t===r?n.green:t===e?n.red:i===!0?n.grey:n}function l(n,t,r){var e=[];return n.forEach(function(n){e.push(f(n.toString(),n,t,r,!0))}),e.join("/".grey)}function p(n,t){return n.toString().yellow+"w"+t.toString()+" "}function g(n){return"("+n.join("/").magenta+") "}function m(n){return"["+n.toString().magenta+"] "}function d(n){var t=n.toString()+" ";return n<MOD_MIN?t.red:n>MOD_MIN?("+"+t).green:("±"+t).grey.dim}function E(n){var t="×"+n.toString();return n>ROLLS_MIN?t.yellow:t.grey.dim}function h(n,t,r,e){var o=i("Σ",r||0)+(t?": ":" ");return o.grey.dim+i(n,e||0).cyan}function F(n,t,r){var e=t||r?" ‼":"";e=t?e.green:r?e.red:e.grey.dim;var o="\tQS "+i(n,QUAL_MAX);return o=n<QUAL_SUCCESS?o.grey.dim:o,o+e+"\t"}function _(n){var t=(-(D_20*ROLLS_ATTR)).toString(),r="\t"+i(n,t);return n<SKILL_MIN?r.red:r.green}function L(n){return"„"+n.toString()+"“"}function R(n){return L(n).yellow+" — ".grey.dim}function M(n,t){var r=0;return n.forEach(function(n){r+=n===t?1:0}),r}function y(n,t,r,e){var i=Math.ceil(n/QUAL_DIVIDE),o=t?QUAL_SUCCESS:QUAL_MIN,a=t&&e?QUAL_MULTIPLY:r?0:1,u=n===SKILL_MIN?QUAL_SUCCESS:i;return Math.max(Math.min(u*a,QUAL_MAX),o)}function I(n){return n=n.replace(REGEX_P,"\n"),n=n.replace(REGEX_H,REGEX_REPLACE.green),n=n.replace(REGEX_B,REGEX_REPLACE.blue),n=n.replace(REGEX_I,REGEX_REPLACE.yellow)}function v(n,t,r){return t+n+r}function S(n,t){return n.localeCompare(t)}return{printEmpty:u,printLine:o,printList:s,printMsg:c,printUp:a,formatOutput:I,splitAttr:e,rollDice:r,countRolls:M,calcQuality:y,strQuote:L,strKeyword:R,strQuality:F,strPoints:_,strRepeat:E,strRolls:l,strDice:p,strRoll:f,strAttr:g,strVal:m,strSum:h,strMod:d,toInt:t,indent:i,enclose:v,sortAlpha:S}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),s=u.join(__dirname+i),c=u.join(__dirname+o)}function t(t){n(),a.readFile(s,function(n,r){t(null!==n?{}:r)})}function r(t){n();a.writeFile(s,t)}function e(t){n(),a.readFile(c,function(n,r){t(null!==n?{}:r)})}var i="/data.json",o="/config.json",a=null,u=null,s=null,c=null;return{load:t,save:r,config:e}}(),Update=function(){function n(n,t){Data.config(function(e){x=require("dns"),G=require("crawler"),B=e.config,k=t.force,Q=c(n||""),Q!==!1&&f(r)})}function t(n){F.printEmpty(2),o();var t={maxConnections:L,rateLimit:R},r=0,a=[],u=[],s=[],c=new G(t),f=new G(t);Q.forEach(function(t,e){var o=t.name,c="undefined"==typeof n[o]||k;c&&(n[o]={}),Data.save(n),a[e]=[],t.urls.forEach(function(t,c){a[e][c]=0,s.push({uri:v+t+S,callback:function(t,s,f){if(!t){var g=s.$,m=g(A).filter(function(){var t=l(g(this).text().trim());return t=n[o][t],"undefined"==typeof t}),d=m.length;r=d>r?d:r,a[e][c]=d,m.each(function(t){var r=g(this).text().trim();r=l(r);var s=g(this).attr(N);s=encodeURI(s),u.push({uri:I+s,callback:function(u,s,f){u||(n[o][r]=p(s.$,s.$(O)),Data.save(n),i(t,e,c,a,o,r),f())}})}),f()}}})})}),e([f,c],[s,u])}function r(n){n&&Data.load(t)}function e(n,t){var r=n.length;r===t.length&&n.forEach(function(e,i){0===i&&e.queue(t[i]),e.on(C,function(){if(0===i){var e=t[i+1].length;0===e?s():a(e)}i+1<r&&n[i+1].queue(t[i+1]),i===r-1&&u(t[i].length)})})}function i(n,t,r,e,i,o){var a=0,u=1+n;e.forEach(function(n,e){n.forEach(function(n,i){u+=e===t&&i<r||e<t?n:0,a+=n})});var s=i+" "+F.strQuote(o);F.printUp(),F.printList(u,a,s.grey.dim)}function o(){var n=0;j=setInterval(function(){n=n>=M?0:n+1,F.printUp(),F.printLine(".".repeat(n).green)},500)}function a(n){clearInterval(j);var t=m.replace(REGEX_REPLACE,n);F.printUp(),F.printMsg(t.green,n,!1,!0),F.printEmpty()}function u(n){F.printUp(),F.printMsg(d.green,n,!1,!0),F.printEmpty()}function s(){clearInterval(j),F.printUp(),F.printMsg(E.green,0,!1,!0),F.printEmpty()}function c(n){var t=[],r=[];if(B.forEach(function(e){r.push(e),e.name===n.toLowerCase()&&t.push(e)}),0===n.length)return r;if(0===t.length){var e=r.length;return F.printEmpty(),F.printMsg(h.red,e,!0),F.printMsg(_.grey.dim,e),F.printEmpty(),r.forEach(function(n,t){F.printList(t+1,e,n.name)}),F.printEmpty(),!1}return t}function f(n){x.lookup(y,function(t){t?(F.printEmpty(),F.printMsg(g.red,0,!0),F.printMsg(y.grey.dim,0),F.printEmpty(),n(!1)):n(!0)})}function l(n){return n=n.replace(REGEX_LVL,""),n=n.replace(REGEX_STAR,""),n=n.replace(REGEX_DOTS,"")}function p(n,t){function r(){return 3===this.nodeType}function e(){return 0===n(this).text().trim().length}if(0===t.length)return"";t.contents().filter(r).remove(),t.children().filter(e).remove(),t.html(t.html().split(P).join(X)),t.find(T).each(function(){n(this).replaceWith(F.enclose(n(this).text(),C_T,C_T+C_P))}),t.find(D).each(function(){n(this).replaceWith(F.enclose(n(this).text(),C_B,C_B))}),t.find(U).each(function(){n(this).replaceWith(F.enclose(n(this).text(),C_I,C_I))}),t.find(w).each(function(){n(this).replaceWith(C_P)}),t.find(b).each(function(){n(this).replaceWith(F.enclose(n(this).text(),C_P,C_P))});var i=t.text().trim();return i=i.replace(REGEX_HASH,""),i.substr(0,i.length-C_P.length)}var g="Verbindungsfehler!",m="Update: $1 neue Begriffe gefunden",d="Update abgeschlossen",E="Begriffe sind auf dem aktuellen Stand",h="Thema existiert nicht, folgende sind verfügbar:",_="(dsa update [thema] [-f, --force])",L=1,R=0,M=10,y="ulisses-regelwiki.de",I="http://www.ulisses-regelwiki.de/",v="http://www.ulisses-regelwiki.de/index.php/",S=".html",C="drain",A="td > a",O="#main .ce_text",T="h1",D="strong",U="em",b="p",w="br",N="href",P="<br>",X="<br/>",x=null,G=null,Q=!1,k=!1,B=null,j=null;return{start:n}}(),Commands=function(){function n(n,t,r){t=F.toInt(t,ROLLS_MIN);var e=F.toInt(r.plus,MOD_MIN),i=F.toInt(r.minus,MOD_MIN),o=e-i,a=n*t+o;F.printEmpty(),F.printLine(F.strDice(t,n)+F.strMod(e-i)),F.printEmpty(),F.rollDice(n,t).forEach(function(r,e){o+=r;var i=F.strRoll(F.indent(r,a),r,ROLL_CRIT,n);F.printList(e+1,t,i)}),F.printEmpty(),(t>ROLLS_MIN||e>MOD_MIN||i>MOD_MIN)&&(F.printLine(F.strSum(o,!0,t,a)),F.printEmpty())}function t(n,t,r){n=F.splitAttr(n),t=F.toInt(t,SKILL_MIN);var e=F.toInt(r.plus,MOD_MIN),i=F.toInt(r.minus,MOD_MIN),s=F.toInt(r.sammel,ROLLS_MIN),c=s>ROLLS_MIN,f=e-i,l=!1,p=!1,g=!1,m=0,d=0;if(n.length!==ROLLS_ATTR)F.printEmpty(),F.printMsg(u.red,0,!0),F.printMsg(a.grey.dim,0),F.printEmpty();else{F.printEmpty(),F.printLine(F.strDice(ROLLS_ATTR,D_20)+F.strAttr(n)+F.strMod(f)+F.strVal(t)+F.strRepeat(s)),F.printEmpty();for(var E=0;E<s;E++){for(var h=[],_=t+0,L=0;L<n.length;L++){h[L]=F.rollDice(D_20,ROLLS_MIN)[0];var R=Math.max(ATTR_MIN,n[L]+f-m),M=Math.max(ATTR_MIN,h[L]-R);_-=M}var y=F.countRolls(h,ROLL_SLIP)>=ROLLS_TO_CRIT,I=F.countRolls(h,ROLL_CRIT)>=ROLLS_TO_CRIT,v=F.calcQuality(_,I,y,c),S=v<QUAL_SUCCESS;if(p=!!p||y,g=!!g||I,l=!!l||S,d=y?v:d+v,m=I?MOD_MIN:S?m+1:m,F.printList(E+1,s,F.strRolls(h,ROLL_CRIT,ROLL_SLIP)+F.strPoints(_)+F.strQuality(v,I,y)+F.strSum(d,!1,0,QUAL_MAX*s)),y)break}F.printEmpty(),o(s,g,l,p)}}function r(n,t){t=t||"",n=n||"";var r=0===n.length;Data.load(function(i){if(F.printEmpty(),Object.keys(i).length>0){var o=[],a=!1;Object.keys(i).forEach(function(t){o.push(t),n.toLowerCase()===t.toLowerCase()&&(a=t)}),o.sort(F.sortAlpha);var u=o.length;a?e(i[a],t,a):(r?F.printMsg(L.cyan,u):F.printMsg(_.red,u,!0),F.printEmpty(),o.forEach(function(n,t){F.printList(t+1,u,n)}),F.printEmpty(),F.printMsg(R.grey.dim,u),F.printEmpty())}else F.printMsg(M.red,0,!0),F.printMsg(y.grey.dim,0),F.printEmpty()})}function e(n,t,r){var e=0===t.length,o=F.strKeyword(t),a=t.toLowerCase(),u=!1,s=0,c=[],f=h.grey.dim,l=I.grey.dim;f=f.replace(REGEX_REPLACE,r),l=l.replace(REGEX_REPLACE,r),Object.keys(n).forEach(function(n){var t=n.toLowerCase();return a===t?void(u=n):void(t.indexOf(a)!==-1&&(c.push(n),s++))}),c.sort(F.sortAlpha),u?i(n[u]):s>0?(e?F.printMsg(E.cyan,s):F.printMsg(o+d.cyan,s),F.printEmpty(),c.forEach(function(n,t){F.printList(t+1,s,n)}),F.printEmpty(),F.printMsg(f,s),F.printEmpty()):(e?(F.printMsg(m.red,0,!0),F.printMsg(l,s)):(F.printMsg(o+g.red,0,!0),F.printMsg(f,s)),F.printEmpty())}function i(n){F.printLine(F.formatOutput(n)),F.printEmpty()}function o(n,t,r,e){var i=!1,o=!1,a=n>ROLLS_MIN,u=!a&&r,g=!a&&!r;a||r||(o=p.green),!a&&r&&(o=l.red),a&&r&&(o=c.grey.dim),t&&(i=f.green),e&&(i=s.red),o&&F.printMsg(o,n,u,g),i&&F.printMsg(i,n,e,t),(i||o)&&F.printEmpty()}var a="(z.B. 11/13/12)",u="Probe im falschen Format!",s="Patzer (automatisch misslungen)",c="Nach misslungenen Proben Malus kumulativ +1",f="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",l="Erfolgsprobe misslungen",p="Erfolgsprobe bestanden",g="Kein passender Begriff gefunden.",m="Keine Begriffe verfügbar.",d="Folgende Begriffe wurden gefunden:",E="Folgende Begriffe sind verfügbar",h="(dsa suche $1 [begriff])",_="Thema existiert nicht, folgende sind verfügbar:",L="Folgende Themen sind verfügbar:",R="(dsa suche [thema] [begriff])",M="Keine Daten gefunden!",y="(dsa update [thema] [-f, --force])",I="(dsa update $1 [-f, --force])";return{find:r,roll:n,skill:t}}();[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(t,r){Commands.roll(n,t,r)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,t,r){Commands.skill(n,t,r)}),Program.command("suche [thema] [begriff]").description("Regel-Thema nach einem Begriff durchsuchen").action(function(n,t){Commands.find(n,t)}),Program.command("update [thema]").description("Regeln aktualisieren").option("-f, --force","Aktualisierung erzwingen").action(function(n,t){Update.start(n,t)}),Program.version("0.0.1").parse(process.argv);