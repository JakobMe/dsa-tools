#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{TITLE:"++",BOLD:"==",PARA:"__",ITALIC:"--",NL:"\n",TAB:"\t",SPACE:" ",BULLET:". ",ALERT:"‼",QUOTE_LEFT:'"',QUOTE_RIGHT:'"',BRACK_LEFT:"[",BRACK_RIGHT:"]",PAREN_LEFT:"(",PAREN_RIGHT:")",FILL:"=",BLANK:" ",QUAL:"QS",SUM:"Σ",COLON:":",TIMES:"×",PLUS:"+",MINUS:"-",PLUSMINUS:"±",DELIMITER:"/",DICE:"d",PERCENT:"%"},REGEX:{PH:"$1",TITLE:/\+\+(.*?)\+\+/g,BOLD:/==(.*?)==/g,ITALIC:/--(.*?)--/g,PARA:/__/g,IGNORE:/\+\+|==|--|__/g,HASH:/#(?!#)/g,LVL:/ I-.*(I|V|X)/,STAR:/ \(\*\)/,DOTS:/ \.\.\./}}}(),Util=function(){function n(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n){var t=parseInt(n);return isNaN(t)?0:t}function r(n,t){return n.localeCompare(t)}return{randomInt:n,sortAlpha:r,toInt:t}}(),Str=function(){function n(n,t){for(var r=n.toString(),e=n.toString(),o=("undefined"==typeof t?"":t).toString(),i=0;i<o.length-e.length;i++)r=G.STR.SPACE+r;return r}function t(n,t,r){return t+n.toString()+r}function r(n,t,r,e){var o=n.toString();return t===r?o.green:t===e?o.red:o}function e(n,t,e){var o=[];return n.forEach(function(n){o.push(r(n,n,t,e))}),o.join(G.STR.DELIMITER)}function o(n,t){return n.toString()+G.STR.DICE+t.toString()+G.STR.SPACE}function i(n){return t(n.join(G.STR.DELIMITER),G.STR.PAREN_LEFT,G.STR.PAREN_RIGHT+G.STR.SPACE)}function a(n){return t(n,G.STR.BRACK_LEFT,G.STR.BRACK_RIGHT+G.STR.SPACE)}function u(n){var t=n.toString()+G.STR.SPACE;return n<0?t.red:n>0?(G.STR.PLUS+t).green:(G.STR.PLUSMINUS+t).grey.dim}function c(n){var t=G.STR.TIMES+n.toString();return n>1?t.grey.dim:t.grey.dim}function f(t,r,e,o){var i=n(t,o),a=n(G.STR.SUM,e),u=r?G.STR.COLON+G.STR.SPACE:G.STR.SPACE;return(a+u).grey.dim+i.cyan}function s(t,r,e,o,i){var a=r||e?G.STR.SPACE+G.STR.ALERT:"";a=r?a.green:e?a.red:a.grey.dim;var u=G.STR.TAB+G.STR.QUAL+G.STR.SPACE+n(t,i);return u=t<o?u.grey.dim:u,u+a+G.STR.TAB}function l(t,r){var e=G.STR.TAB+n(t,r*-1);return t<0?e.red:e.green}function g(n){return t(n,G.STR.QUOTE_LEFT,G.STR.QUOTE_RIGHT)}function h(n){return n.toString()+G.STR.PERCENT}function S(n,t,r){var e=n/t,o=h(Math.round(100*e)),i=Math.round(e*r),a=G.STR.SPACE+G.STR.FILL.repeat(i),u=G.STR.BLANK.repeat(r-i)+G.STR.SPACE;return Str.brackets(a.cyan+u)+o.magenta}return{percent:h,progressbar:S,indent:n,enclose:t,roll:r,rolls:e,dice:o,attr:i,brackets:a,mod:u,times:c,sum:f,quality:s,points:l,quote:g}}(),Log=function(){function n(n){f((n||"")+G.STR.NL)}function t(n){for(var t=0;t<(n||1);t++)f.previousLine(1),f.eraseLine()}function r(t){t="number"!=typeof t?1:t;for(var r=0;r<t;r++)n("")}function e(t,e,o){r(e),n(t),r(o)}function o(t){t.forEach(function(r,e){n((Str.indent(e+1,t.length)+G.STR.BULLET).grey.dim+r)})}function i(n,t,r,o,i,a){var u=G.STR.SPACE.repeat(G.STR.BULLET.length),c=Str.indent(G.STR.ALERT,t||0);r=r||!1,o=o||!1,c=r?c.red:o?c.green:c.grey.dim,e(c+u+n,i,a)}function a(n,t,r,e){i(n.red,t,!0,!1,r,e)}function u(n,t,r,e){i(n.toString().grey.dim,t,!1,!1,r,e)}function c(n,t,r,e){i(n.green,t,!1,!0,r,e)}var f=require("terminal-kit").terminal;return{spaced:e,success:c,empty:r,shout:i,error:a,hint:u,line:n,list:o,back:t}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),f=u.join(__dirname+i)}function t(t){n(),a.readFile(c,function(n,r){t(null!==n?{}:r)})}function r(t){n(),a.writeFile(c,t)}function e(t){n(),a.readFile(f,function(n,r){t(null!==n?{}:r)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,f=null;return{config:e,load:t,save:r}}(),Update=function(){function n(n,t){Data.config(function(e){x=require("dns"),D=require("crawler"),O=e.config,N=t.force||!1,B=a(n||""),B!==!1&&u(r)})}function t(n){var t={maxConnections:S,rateLimit:d},r=[],a=[],u=[],s=new D(t),l=new D(t);B.forEach(function(t,e){var s=t.name,l="undefined"==typeof n[s]||N;l&&(n[s]={}),Data.save(n),r[e]=[],t.urls.forEach(function(t,l){r[e][l]=0,u.push({uri:R+t+m,callback:function(t,u,g){if(!t){var h=u.$,S=h(v).filter(function(){var t=c(h(this).text().trim());return t=n[s][t],"undefined"==typeof t});r[e][l]=S.length,o(e,l,r),S.each(function(t){var o=h(this).text().trim();o=c(o);var u=h(this).attr(U);u=encodeURI(u),a.push({uri:E+u,callback:function(a,u,c){a||(n[s][o]=f(u.$,u.$(A)),Data.save(n),i(t,e,l,r,s,o),c())}})}),g()}}})})}),e([l,s],[u,a])}function r(n){n&&Data.load(t)}function e(n,t){var r=n.length;r===t.length&&n.forEach(function(e,o){0===o&&e.queue(t[o]),e.on(L,function(){o+1<r&&n[o+1].queue(t[o+1])})})}function o(n,t,r){var e=0,o=0,i=1+t;r.forEach(function(t,r){e+=t.length,i+=r<n?t.length:0,t.forEach(function(n,t){o+=n})});var a=o+G.STR.SPACE+l,u=Str.progressbar(i,e,T);Log.empty(1===i?2:0),Log.back(1===i?0:3),Log.success(a,0,0,0),Log.shout(u,0,!1,!1,0,1)}function i(n,t,r,e,o,i){var a=0,u=1+n;e.forEach(function(n,e){n.forEach(function(n,o){a+=n,u+=e===t&&o<r||e<t?n:0})});var c=u+G.STR.DELIMITER+a+G.STR.SPACE,f=o+G.STR.SPACE+Str.quote(i),s=Str.progressbar(u,a,T);Log.empty(1===u?1:0),Log.back(1===u?0:3),Log.success(c+f,0,0,0),Log.shout(s,0,!1,!1,0,1)}function a(n){var t=[],r=[],e=[];return O.forEach(function(o){t.push(o.name),e.push(o),o.name===n.toLowerCase()&&r.push(o)}),n.length?r.length?r:(Log.error(g,t.length,1,0),Log.hint(h,t.length,0,1),Log.list(t),Log.empty(),!1):e}function u(n){x.lookup(p,function(t){t?(Log.error(s,0,1,0),Log.hint(p,0,0,1),n(!1)):n(!0)})}function c(n){return n=n.replace(G.REGEX.LVL,""),n=n.replace(G.REGEX.STAR,""),n=n.replace(G.REGEX.DOTS,"")}function f(n,t){function r(){return 3===this.nodeType}function e(){return!n(this).text().trim().length}if(!t.length)return"";t.contents().filter(r).remove(),t.children().filter(e).remove(),t.html(t.html().split(M).join(k)),t.find(I).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.TITLE,G.STR.TITLE+G.STR.PARA))}),t.find(P).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.BOLD,G.STR.BOLD))}),t.find(C).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.ITALIC,G.STR.ITALIC))}),t.find(y).each(function(){n(this).replaceWith(G.STR.PARA)}),t.find(b).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.PARA,G.STR.PARA))});var o=t.text().trim();return o=o.replace(G.REGEX.HASH,""),o.substr(0,o.length-G.STR.PARA.length)}var s="Verbindungsfehler!",l="neue Begriffe gefunden",g="Thema existiert nicht, folgende sind verfügbar:",h="(dsa update [topic] [-f])",S=1,d=0,T=15,p="ulisses-regelwiki.de",E="http://www.ulisses-regelwiki.de/",R="http://www.ulisses-regelwiki.de/index.php/",m=".html",L="drain",v="td > a",A="#main .ce_text",I="h1",P="strong",C="em",b="p",y="br",U="href",M="<br>",k="<br/>",x=null,D=null,B=!1,N=!1,O=null;return{start:n}}(),Dice=function(){function n(n,t,r){t=Math.max(Util.toInt(t),R);var e=Util.toInt(r.mod),i=t>R||e,a=[],u=0;o(t,n).forEach(function(t,r){u+=t;var e=Str.indent(t,n);a.push(Str.roll(e,t,m,n))}),Log.spaced(Str.dice(t,n)+Str.mod(e)),Log.list(a),Log.spaced(i?Str.sum(u+e,!0):"",i?1:0)}function t(n,t,o){t=Math.max(Util.toInt(t),0),n=e(n);var f=Util.toInt(o.mod),g=o.probability||!1,h=Math.max(Util.toInt(o.repeat),R);h=g?0:h;var S=u(n,t,f);S=Str.percent(S);var d=h>R,T=!1,E=!1,v=!1,A=[],P=0,b=0;if(n.length!==p)Log.error(l,0,1,0),Log.hint(s,0,0,1);else{for(var y=0;y<h;y++){var U=i(n,t,f,P),M=U.results,k=U.points,x=c(M,L),D=c(M,m),B=a(k,D,x,d),N=B<C;if(E=!!E||x,v=!!v||D,T=!!T||N,b=x?B:b+B,P=D?0:N?P+1:P,A.push(Str.rolls(M,m,L)+Str.points(k,p*L)+Str.quality(B,D,x,C,I)+Str.sum(b,!1,0,I*h)),x)break}if(Log.spaced(Str.dice(Str.indent(p,A.length),L)+Str.attr(n).magenta+Str.mod(f)+Str.brackets(t).magenta+Str.times(h)+G.STR.SPACE+(g?S.cyan:S.grey.dim)),g)return;Log.list(A),r(A.length,v,T,E)}}function r(n,t,r,e){var o=!1,i=!1,a=n>R,u=!a&&r,c=!a&&!r;a||r||(i=T.green),!a&&r&&(i=d.red),a&&r&&(i=h.grey.dim),t&&(o=S.green),e&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,e,t,0,1),o||Log.empty()}function e(n){var t=[];return n.split(G.STR.DELIMITER).forEach(function(n){t.push(Math.max(Util.toInt(n),0))}),t}function o(n,t){for(var r=[],e=0;e<n;e++)r.push(Util.randomInt(1,t));return r}function i(n,t,r,e){var i=o(n.length,L),a=f(i,n,t,r,e);return{results:i,points:a}}function a(n,t,r,e){var o=Math.ceil(n/A),i=t?C:P,a=t&&e?v:r?0:1,u=0===n?C:o;return Math.max(Math.min(u*a,I),i)}function u(n,t,r){for(var e=0,o=1;o<=L;o++)for(var i=1;i<=L;i++)for(var a=1;a<=L;a++)if(c([o,i,a],m))e++;else if(!c([o,i,a],L)){var u=f([o,i,a],n,t,r,0);e+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(L,3))*e*100*100)/100}function c(n,t){var r=0;return n.forEach(function(n){r+=n===t?1:0}),r>=E}function f(n,t,r,e,o){var i=r+0;return n.forEach(function(n,r){i-=Math.max(0,n-(t[r]+e-o))}),i}var s="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",S="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",d="Erfolgsprobe misslungen",T="Erfolgsprobe bestanden",p=3,E=2,R=1,m=1,L=20,v=2,A=3,I=6,P=0,C=1;return{roll:n,skill:t}}(),Search=function(){function n(n,r,o){m=require("didyoumean"),m.nullResultValue=!1,r=(r||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.guess||!1,a=o.fuzzy||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=e(n,u),f=0===n.length,s=u.length,l=f?S.green:h.red;s&&c?t(o[c],r,c,a,i):s?(Log.shout(l,s,!f,f),Log.list(u),Log.hint(d,s)):(Log.error(T,s,1,0),Log.hint(p,s,0,1))})}function t(n,t,e,a,u){var h=0===t.length,S=Object.keys(n),d=!1,T=[],p=h?l:s,R=g.replace(G.REGEX.PH,e),m=E.replace(G.REGEX.PH,e);S.forEach(function(n){t===n.toLowerCase()?d=n:r(t,n,a)&&T.push(n)}),T.sort(Util.sortAlpha);var L=d?d:o(t,T,u),v=T.length;L?Log.spaced(i(n[L])):v?(Log.success(p,v),Log.list(T),Log.hint(R,v)):h&&!v?(Log.error(f,v,1,0),Log.hint(m,v,0,1)):(Log.error(c,v,1,0),Log.hint(R,v,0,1))}function r(n,t,r){var e=r?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),t=t.toLowerCase(),n.indexOf(t)!==-1||e(n,t)||t.indexOf(n)!==-1||e(t,n)}function e(n,t){return t.indexOf(n)>=0?n:m(n,t)}function o(n,t,r){return m.threshold=null,m.thresholdAbsolute=100,!!r&&m(n,t)}function i(n){return n=a(n),n=n.replace(G.REGEX.PARA,G.STR.NL),n=n.replace(G.REGEX.TITLE,G.REGEX.PH.green),n=n.replace(G.REGEX.BOLD,G.REGEX.PH.magenta),n=n.replace(G.REGEX.ITALIC,G.REGEX.PH.cyan)}function a(n){var t=[];return n.split(G.STR.PARA).forEach(function(n){var r=[""],e=0;n.split(G.STR.SPACE).forEach(function(n){u(n,r[e])||(r[++e]=""),r[e]+=n+G.STR.SPACE}),r.forEach(function(n,t){r[t]=n.trim()}),t.push(r.join(G.STR.NL))}),t.join(G.STR.PARA)}function u(n,t){var r=n.replace(G.REGEX.IGNORE,""),e=t.replace(G.REGEX.IGNORE,"");return r.length+e.length<R}var c="Kein passender Begriff gefunden.",f="Keine Begriffe verfügbar.",s="Folgende Begriffe wurden gefunden:",l="Folgende Begriffe sind verfügbar",g="(dsa search $1 [phrase] [-f] [-g])",h="Thema existiert nicht, folgende sind verfügbar:",S="Folgende Themen sind verfügbar:",d="(dsa search [topic] [phrase] [-f] [-g])",T="Keine Daten gefunden!",p="(dsa update [topic] [-f])",E="(dsa update $1 [-f])",R=80,m=null;return{find:n}}();!function(){Program.version("0.0.1").description("CLI tools for The Dark Eye"),[3,4,6,8,10,12,20,100].forEach(function(n){Program.command("d"+n+" [n]").description("roll d"+n+" n times").option("-m, --mod <x>","modify sum by x").action(function(t,r){Dice.roll(n,t,r)})}),Program.command("skill <attributes> <value>").description("make skill check").option("-m, --mod <x>","modify check by x").option("-r, --repeat <n>","repeat check n times").option("-p, --probability","show probability of success").action(function(n,t,r){Dice.skill(n,t,r)}),Program.command("search [topic] [phrase]").description("search for phrase in topic").option("-f, --fuzzy","use fuzzy search").option("-g, --guess","guess correct result").action(function(n,t,r){Search.find(n,t,r)}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(n,t){Update.start(n,t)}),Program.parse(process.argv),Program.args.length||Program.help()}();