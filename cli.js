#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),Terminal=require("terminal-kit").terminal,G=function(){return{MOD_MIN:0,SKILL_MIN:0,ATTR_MIN:0,ROLLS_MIN:1,ROLLS_ATTR:3,ROLLS_TO_CRIT:2,D_20:20,ROLL_SLIP:20,ROLL_CRIT:1,QUAL_MULTIPLY:2,QUAL_DIVIDE:3,QUAL_MAX:6,QUAL_MIN:0,QUAL_SUCCESS:1,CODE_T:"++",CODE_B:"==",CODE_P:"__",CODE_I:"--",REGEX_REPLACE:"$1",REGEX_H:/\+\+(.*?)\+\+/g,REGEX_B:/==(.*?)==/g,REGEX_I:/--(.*?)--/g,REGEX_P:/__/g,REGEX_HASH:/#(?!#)/g,REGEX_LVL:/ I-.*(I|V|X)/,REGEX_STAR:/ \(\*\)/,REGEX_DOTS:/ \.\.\./}}(),F=function(){function n(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n,t){var r=parseInt(n);return isNaN(r)&&(r=t),r}function r(r,e){for(var i=[],o=0;o<t(e,G.ROLLS_MIN);o++)i.push(n(1,r));return i}function e(n){var r=[];return n.split("/").forEach(function(n){r.push(t(n,G.ATTR_MIN))}),r}function i(n,t){for(var r=n.toString().length,e=t.toString().length,i=0;i<e-r;i++)n=" "+n;return n.toString()}function o(n){Terminal((n||"")+"\n")}function a(n){for(var t=0;t<(n||1);t++)Terminal.previousLine(1),Terminal.eraseLine()}function u(n){for(var t=0;t<(n||1);t++)o("")}function c(n,t,r){o((i(n,t)+". ").grey.dim+r)}function s(n,t,r,e){var a=i("‼",t);r=r||!1,e=e||!1,a=r?a.red:e?a.green:a.grey.dim,o(a+"  "+n)}function f(n,t,r,e,i){return n=n.toString(),t===r?n.green:t===e?n.red:i===!0?n.grey:n}function l(n,t,r){var e=[];return n.forEach(function(n){e.push(f(n.toString(),n,t,r,!0))}),e.join("/".grey)}function p(n,t){return n.toString().yellow+"w"+t.toString()+" "}function g(n){return"("+n.join("/").magenta+") "}function m(n){return"["+n.toString().magenta+"] "}function E(n){var t=n.toString()+" ";return n<G.MOD_MIN?t.red:n>G.MOD_MIN?("+"+t).green:("±"+t).grey.dim}function h(n){var t="×"+n.toString();return n>G.ROLLS_MIN?t.yellow:t.grey.dim}function d(n,t,r,e){var o=i("Σ",r||0)+(t?": ":" ");return o.grey.dim+i(n,e||0).cyan}function F(n,t,r){var e=t||r?" ‼":"";e=t?e.green:r?e.red:e.grey.dim;var o="\tQS "+i(n,G.QUAL_MAX);return o=n<G.QUAL_SUCCESS?o.grey.dim:o,o+e+"\t"}function L(n){var t=(-(G.D_20*G.ROLLS_ATTR)).toString(),r="\t"+i(n,t);return n<G.SKILL_MIN?r.red:r.green}function _(n){return"„"+n.toString()+"“"}function R(n){return _(n).yellow+" — ".grey.dim}function M(n,t){var r=0;return n.forEach(function(n){r+=n===t?1:0}),r}function y(n,t,r,e){var i=Math.ceil(n/G.QUAL_DIVIDE),o=t?G.QUAL_SUCCESS:G.QUAL_MIN,a=t&&e?G.QUAL_MULTIPLY:r?0:1,u=n===G.SKILL_MIN?G.QUAL_SUCCESS:i;return Math.max(Math.min(u*a,G.QUAL_MAX),o)}function v(n){return n=n.replace(G.REGEX_P,"\n"),n=n.replace(G.REGEX_H,G.REGEX_REPLACE.green),n=n.replace(G.REGEX_B,G.REGEX_REPLACE.blue),n=n.replace(G.REGEX_I,G.REGEX_REPLACE.yellow)}function S(n,t,r){return t+n+r}function I(n,t){return n.localeCompare(t)}return{printEmpty:u,printLine:o,printList:c,printMsg:s,printUp:a,formatOutput:v,splitAttr:e,rollDice:r,countRolls:M,calcQuality:y,strQuote:_,strKeyword:R,strQuality:F,strPoints:L,strRepeat:h,strRolls:l,strDice:p,strRoll:f,strAttr:g,strVal:m,strSum:d,strMod:E,toInt:t,indent:i,enclose:S,sortAlpha:I}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+i),s=u.join(__dirname+o)}function t(t){n(),a.readFile(c,function(n,r){t(null!==n?{}:r)})}function r(t){n();a.writeFile(c,t)}function e(t){n(),a.readFile(s,function(n,r){t(null!==n?{}:r)})}var i="/data.json",o="/config.json",a=null,u=null,c=null,s=null;return{load:t,save:r,config:e}}(),Update=function(){function n(n,t){Data.config(function(e){Q=require("dns"),k=require("crawler"),q=e.config,j=t.force,B=s(n||""),B!==!1&&f(r)})}function t(n){F.printEmpty(2),o();var t={maxConnections:_,rateLimit:R},r=0,a=[],u=[],c=[],s=new k(t),f=new k(t);B.forEach(function(t,e){var o=t.name,s="undefined"==typeof n[o]||j;s&&(n[o]={}),Data.save(n),a[e]=[],t.urls.forEach(function(t,s){a[e][s]=0,c.push({uri:I+t+O,callback:function(t,c,f){if(!t){var g=c.$,m=g(C).filter(function(){var t=l(g(this).text().trim());return t=n[o][t],"undefined"==typeof t}),E=m.length;r=E>r?E:r,a[e][s]=E,m.each(function(t){var r=g(this).text().trim();r=l(r);var c=g(this).attr(P);c=encodeURI(c),u.push({uri:S+c,callback:function(u,c,f){u||(n[o][r]=p(c.$,c.$(A)),Data.save(n),i(t,e,s,a,o,r),f())}})}),f()}}})})}),e([f,s],[c,u])}function r(n){n&&Data.load(t)}function e(n,t){var r=n.length;r===t.length&&n.forEach(function(e,i){0===i&&e.queue(t[i]),e.on(D,function(){if(0===i){var e=t[i+1].length;0===e?c():a(e)}i+1<r&&n[i+1].queue(t[i+1]),i===r-1&&u(t[i].length)})})}function i(n,t,r,e,i,o){var a=0,u=1+n;e.forEach(function(n,e){n.forEach(function(n,i){u+=e===t&&i<r||e<t?n:0,a+=n})});var c=i+" "+F.strQuote(o);F.printUp(),F.printList(u,a,c.grey.dim)}function o(){var n=0;z=setInterval(function(){n=n>=M?0:n+1,F.printUp(),F.printLine(".".repeat(n).green)},y)}function a(n){clearInterval(z);var t=m.replace(G.REGEX_REPLACE,n);F.printUp(),F.printMsg(t.green,n,!1,!0),F.printEmpty()}function u(n){F.printUp(),F.printMsg(E.green,n,!1,!0),F.printEmpty()}function c(){clearInterval(z),F.printUp(),F.printMsg(h.green,0,!1,!0),F.printEmpty()}function s(n){var t=[],r=[];if(q.forEach(function(e){r.push(e),e.name===n.toLowerCase()&&t.push(e)}),0===n.length)return r;if(0===t.length){var e=r.length;return F.printEmpty(),F.printMsg(d.red,e,!0),F.printMsg(L.grey.dim,e),F.printEmpty(),r.forEach(function(n,t){F.printList(t+1,e,n.name)}),F.printEmpty(),!1}return t}function f(n){Q.lookup(v,function(t){t?(F.printEmpty(),F.printMsg(g.red,0,!0),F.printMsg(v.grey.dim,0),F.printEmpty(),n(!1)):n(!0)})}function l(n){return n=n.replace(G.REGEX_LVL,""),n=n.replace(G.REGEX_STAR,""),n=n.replace(G.REGEX_DOTS,"")}function p(n,t){function r(){return 3===this.nodeType}function e(){return 0===n(this).text().trim().length}if(0===t.length)return"";t.contents().filter(r).remove(),t.children().filter(e).remove(),t.html(t.html().split(X).join(x)),t.find(T).each(function(){n(this).replaceWith(F.enclose(n(this).text(),G.CODE_T,G.CODE_T+G.CODE_P))}),t.find(b).each(function(){n(this).replaceWith(F.enclose(n(this).text(),G.CODE_B,G.CODE_B))}),t.find(w).each(function(){n(this).replaceWith(F.enclose(n(this).text(),G.CODE_I,G.CODE_I))}),t.find(N).each(function(){n(this).replaceWith(G.CODE_P)}),t.find(U).each(function(){n(this).replaceWith(F.enclose(n(this).text(),G.CODE_P,G.CODE_P))});var i=t.text().trim();return i=i.replace(G.REGEX_HASH,""),i.substr(0,i.length-G.CODE_P.length)}var g="Verbindungsfehler!",m="Update: $1 neue Begriffe gefunden",E="Update abgeschlossen",h="Begriffe sind auf dem aktuellen Stand",d="Thema existiert nicht, folgende sind verfügbar:",L="(dsa update [thema] [-f])",_=1,R=0,M=3,y=300,v="ulisses-regelwiki.de",S="http://www.ulisses-regelwiki.de/",I="http://www.ulisses-regelwiki.de/index.php/",O=".html",D="drain",C="td > a",A="#main .ce_text",T="h1",b="strong",w="em",U="p",N="br",P="href",X="<br>",x="<br/>",Q=null,k=null,B=!1,j=!1,q=null,z=null;return{start:n}}(),Dice=function(){function n(n,t,r){t=F.toInt(t,G.ROLLS_MIN);var e=F.toInt(r.plus,G.MOD_MIN),i=F.toInt(r.minus,G.MOD_MIN),o=e-i,a=n*t+o;F.printEmpty(),F.printLine(F.strDice(t,n)+F.strMod(e-i)),F.printEmpty(),F.rollDice(n,t).forEach(function(r,e){o+=r;var i=F.strRoll(F.indent(r,a),r,G.ROLL_CRIT,n);F.printList(e+1,t,i)}),F.printEmpty(),(t>G.ROLLS_MIN||e>G.MOD_MIN||i>G.MOD_MIN)&&(F.printLine(F.strSum(o,!0,t,a)),F.printEmpty())}function t(n,t,o){n=F.splitAttr(n),t=F.toInt(t,G.SKILL_MIN);var a=F.toInt(o.plus,G.MOD_MIN),u=F.toInt(o.minus,G.MOD_MIN),c=F.toInt(o.sammel,G.ROLLS_MIN),s=c>G.ROLLS_MIN,f=a-u,l=!1,p=!1,g=!1,m=0,E=0;if(n.length!==G.ROLLS_ATTR)F.printEmpty(),F.printMsg(i.red,0,!0),F.printMsg(e.grey.dim,0),F.printEmpty();else{F.printEmpty(),F.printLine(F.strDice(G.ROLLS_ATTR,G.D_20)+F.strAttr(n)+F.strMod(f)+F.strVal(t)+F.strRepeat(c)),F.printEmpty();for(var h=0;h<c;h++){for(var d=[],L=t+0,_=0;_<n.length;_++){d[_]=F.rollDice(G.D_20,G.ROLLS_MIN)[0];var R=Math.max(G.ATTR_MIN,n[_]+f-m),M=Math.max(G.ATTR_MIN,d[_]-R);L-=M}var y=F.countRolls(d,G.ROLL_SLIP)>=G.ROLLS_TO_CRIT,v=F.countRolls(d,G.ROLL_CRIT)>=G.ROLLS_TO_CRIT,S=F.calcQuality(L,v,y,s),I=S<G.QUAL_SUCCESS;if(p=!!p||y,g=!!g||v,l=!!l||I,E=y?S:E+S,m=v?G.MOD_MIN:I?m+1:m,F.printList(h+1,c,F.strRolls(d,G.ROLL_CRIT,G.ROLL_SLIP)+F.strPoints(L)+F.strQuality(S,v,y)+F.strSum(E,!1,0,G.QUAL_MAX*c)),y)break}F.printEmpty(),r(c,g,l,p)}}function r(n,t,r,e){var i=!1,f=!1,l=n>G.ROLLS_MIN,p=!l&&r,g=!l&&!r;l||r||(f=s.green),!l&&r&&(f=c.red),l&&r&&(f=a.grey.dim),t&&(i=u.green),e&&(i=o.red),f&&F.printMsg(f,n,p,g),i&&F.printMsg(i,n,e,t),(i||f)&&F.printEmpty()}var e="(z.B. 11/13/12)",i="Probe im falschen Format!",o="Patzer (automatisch misslungen)",a="Nach misslungenen Proben Malus kumulativ +1",u="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",c="Erfolgsprobe misslungen",s="Erfolgsprobe bestanden";return{roll:n,skill:t}}(),Search=function(){function n(n,r,e){h=require("didyoumean"),h.nullResultValue=!1,r=r||"",n=n||"";var i=e.beste||!1,o=e.fuzzy||!1,a=0===n.length;Data.load(function(e){if(F.printEmpty(),Object.keys(e).length>0){var u=[],c=!1;Object.keys(e).forEach(function(t){u.push(t);var r=n.toLowerCase(),e=t.toLowerCase();r===e&&(c=t)}),u.sort(F.sortAlpha);var s=u.length;c=c?c:h(n,u),c?t(e[c],r,c,o,i):(a?F.printMsg(l.cyan,s):F.printMsg(f.red,s,!0),F.printEmpty(),u.forEach(function(n,t){F.printList(t+1,s,n)}),F.printEmpty(),F.printMsg(p.grey.dim,s),F.printEmpty())}else F.printMsg(g.red,0,!0),F.printMsg(m.grey.dim,0),F.printEmpty()})}function t(n,t,f,l,p){var g=0===t.length,m=F.strKeyword(t),h=t.toLowerCase(),d=!1,L=0,_=[],R=s.grey.dim,M=E.grey.dim;R=R.replace(G.REGEX_REPLACE,f),M=M.replace(G.REGEX_REPLACE,f),Object.keys(n).forEach(function(n){var t=n.toLowerCase();return h===t?void(d=n):void(r(h,t,l)&&(_.push(n),L++))}),d=d?d:e(h,_,p),_.sort(F.sortAlpha),d?i(n[d]):L>0?(g?F.printMsg(c.cyan,L):F.printMsg(m+u.cyan,L),F.printEmpty(),_.forEach(function(n,t){F.printList(t+1,L,n)}),F.printEmpty(),F.printMsg(R,L),F.printEmpty()):g?(F.printMsg(a.red,0,!0),F.printMsg(M,L),F.printEmpty()):(F.printMsg(m+o.red,0,!0),F.printMsg(R,L),F.printEmpty())}function r(n,t,r){var e=r?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),t=t.toLowerCase(),n.indexOf(t)!==-1||e(n,t)||t.indexOf(n)!==-1||e(t,n)}function e(n,t,r){return h.threshold=null,h.thresholdAbsolute=100,!!r&&h(n,t)}function i(n){F.printLine(F.formatOutput(n)),F.printEmpty()}var o="Kein passender Begriff gefunden.",a="Keine Begriffe verfügbar.",u="Folgende Begriffe wurden gefunden:",c="Folgende Begriffe sind verfügbar",s="(dsa suche $1 [begriff] [-f] [-b])",f="Thema existiert nicht, folgende sind verfügbar:",l="Folgende Themen sind verfügbar:",p="(dsa suche [thema] [begriff] [-f] [-b])",g="Keine Daten gefunden!",m="(dsa update [thema] [-f])",E="(dsa update $1 [-f])",h=null;return{find:n}}();!function(){[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(t,r){Dice.roll(n,t,r)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erschwernis -x").option("-p, --plus <x>","Erleichterung +x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,t,r){Dice.skill(n,t,r)}),Program.command("suche [thema] [begriff]").description("Thema nach einem Begriff durchsuchen").option("-f, --fuzzy","Ungefähre Suche benutzen").option("-b, --beste","Bestes Suchergebnis anzeigen").action(function(n,t,r){Search.find(n,t,r)}),Program.command("update [thema]").description("Regeln aktualisieren").option("-f, --force","Aktualisierung erzwingen").action(function(n,t){Update.start(n,t)}),Program.version("0.0.1").parse(process.argv)}();