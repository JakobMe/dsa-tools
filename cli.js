#!/usr/bin/env node
var Program=require("commander"),Colors=require("colors"),MOD_MIN=0,SKILL_MIN=0,ATTR_MIN=0,ROLLS_MIN=1,ROLLS_ATTR=3,ROLLS_TO_CRIT=2,D_20=20,ROLL_SLIP=20,ROLL_CRIT=1,QUAL_MULTIPLY=2,QUAL_DIVIDE=3,QUAL_MAX=6,QUAL_MIN=0,QUAL_SUCCESS=1,C_T="##",C_B="==",C_P="__",REGEX_REPLACE="$1",REGEX_H=/##(.*?)##/g,REGEX_B=/==(.*?)==/g,REGEX_P=/__/g,_=function(){function n(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n,t){var e=parseInt(n);return isNaN(e)&&(e=t),e}function e(e,r){for(var i=[],o=0;o<t(r,ROLLS_MIN);o++)i.push(n(1,e));return i}function r(n){var e=[];return n.split("/").forEach(function(n){e.push(t(n,ATTR_MIN))}),e}function i(n,t){for(var e=n.toString().length,r=t.toString().length,i=0;i<r-e;i++)n=" "+n;return n.toString()}function o(n){console.log(n||"")}function a(n,t,e){o((i(n,t)+". ").grey.dim+e)}function u(n,t,e,r){var a=i("‼",t);e=e||!1,r=r||!1,a=e?a.red:r?a.green:a.grey.dim,o(a+"  "+n)}function s(n,t,e,r,i){return n=n.toString(),t===e?n.green:t===r?n.red:i===!0?n.grey:n}function _(n,t,e){var r=[];return n.forEach(function(n){r.push(s(n.toString(),n,t,e,!0))}),r.join("/".grey)}function c(n,t){return n.toString().yellow+"w"+t.toString()+" "}function f(n){return"("+n.join("/").magenta+") "}function l(n){return"["+n.toString().magenta+"] "}function g(n){var t=n.toString()+" ";return n<MOD_MIN?t.red:n>MOD_MIN?("+"+t).green:("±"+t).grey.dim}function p(n){var t="×"+n.toString();return n>ROLLS_MIN?t.yellow:t.grey.dim}function L(n,t,e,r){var o=i("Σ",e||0)+(t?": ":" ");return o.grey.dim+i(n,r||0).cyan}function d(n,t,e){var r=t||e?" ‼":"";r=t?r.green:e?r.red:r.grey.dim;var o="\tQS "+i(n,QUAL_MAX);return o=n<QUAL_SUCCESS?o.grey.dim:o,o+r+"\t"}function m(n){var t=(-(D_20*ROLLS_ATTR)).toString(),e="\t"+i(n,t);return n<SKILL_MIN?e.red:e.green}function h(n){return("„"+n.toString()+"“").yellow}function M(n){return h(n)+" — ".grey.dim}function R(n){return"✓ ".green+n}function S(n,t){var e=0;return n.forEach(function(n){e+=n===t?1:0}),e}function I(n,t,e,r){var i=Math.ceil(n/QUAL_DIVIDE),o=t?QUAL_SUCCESS:QUAL_MIN,a=t&&r?QUAL_MULTIPLY:e?0:1,u=n===SKILL_MIN?QUAL_SUCCESS:i;return Math.max(Math.min(u*a,QUAL_MAX),o)}function v(n){return n=n.red,n=n.replace(REGEX_P,"\n"),n=n.replace(REGEX_H,REGEX_REPLACE.green),n=n.replace(REGEX_B,REGEX_REPLACE.blue)}function E(n,t,e){return t+n+e}return{printLine:o,printList:a,printMsg:u,formatOutput:v,splitAttr:r,rollDice:e,countRolls:S,calcQuality:I,strQuote:h,strSuccess:R,strKeyword:M,strQuality:d,strPoints:m,strRepeat:p,strRolls:_,strDice:c,strRoll:s,strAttr:f,strVal:l,strSum:L,strMod:g,toInt:t,indent:i,enclose:E}}(),Data=function(){function n(){o=require("path"),i=require("jsonfile"),a=o.join(__dirname+r)}function t(t){n(),i.readFile(a,function(n,e){t(null!==n?{}:e)})}function e(t){n(),i.writeFile(a,t)}var r="/data.json",i=null,o=null,a=null;return{load:t,save:e}}(),Update=function(){function n(n,t){D=require("dns"),P=require("crawler"),x=t.force,U=o(n||""),U!==!1&&a(e)}function t(n){var t={maxConnections:m,rateLimit:h},e=0,o=0,a=[],s=[],_=new P(t),c=new P(t);U.forEach(function(t,r){var _=t.name,c="undefined"==typeof n[_]||x;c&&(n[_]={}),t.urls.forEach(function(t){s.push({uri:S+t+I,callback:function(t,s,c){if(!t){var f=s.$,l=f(E).filter(function(){var t=n[_][f(this).text().trim()];return"undefined"==typeof t}),g=l.length;o+=g,e=g>e?g:e,l.each(function(t){var e=f(this).text().trim(),s=f(this).attr(N);s=encodeURI(s),a.push({uri:R+s,callback:function(a,s,c){a||(n[_][e]=u(s.$,s.$(C)),i(t,r,o,_,e),c())}})}),c()}}})})}),r([c,_],[s,a],function(){Data.save(n)})}function e(n){n&&Data.load(t)}function r(n,t,e){var r=n.length;r===t.length&&n.forEach(function(i,o){0===o&&i.queue(t[o]),i.on(v,function(){var i;0===o&&(i=t[o+1].length,_.printLine(),_.printMsg(f.green,i,!1,!0),0===i&&(_.printMsg(p.green,0,!1,!0),_.printLine())),o+1<r&&n[o+1].queue(t[o+1]),o===r-1&&(i=t[o].length,_.printLine(),_.printMsg(g.green,i,!1,!0),_.printLine(),e())})})}function i(n,t,e,r,i){if(0===n){if(0===t){var o=e.toString().grey;_.printMsg(l.grey.dim+o,e),_.printLine()}_.printMsg(c.cyan+_.strQuote(r),e),_.printLine()}_.printList(n+1,e,_.strSuccess(i.grey.dim))}function o(n){var t=[],e=[];if(Q.forEach(function(r){e.push(r),r.name===n.toLowerCase()&&t.push(r)}),0===n.length)return e;if(0===t.length){var r=e.length;return _.printLine(),_.printMsg(L.red,r,!0),_.printMsg(d.grey.dim,r),_.printLine(),e.forEach(function(n,t){_.printList(t+1,r,n.name)}),_.printLine(),!1}return t}function a(n){D.lookup(M,function(t){t?(_.printLine(),_.printMsg(s.red,0,!0),_.printMsg(M.grey.dim,0),_.printLine(),n(!1)):n(!0)})}function u(n,t){function e(){return 3===this.nodeType}function r(){return 0===n(this).text().trim().length}t.contents().filter(e).remove(),t.children().filter(r).remove(),t.html(t.html().split(b).join(w)),t.find(O).each(function(){n(this).replaceWith(_.enclose(n(this).text(),C_T,C_T+C_P))}),t.find(y).each(function(){n(this).replaceWith(_.enclose(n(this).text(),C_B,C_B))}),t.find(A).each(function(){n(this).replaceWith(C_P)}),t.find(T).each(function(){n(this).replaceWith(_.enclose(n(this).text(),C_P,C_P))});var i=t.text().trim();return i.substr(0,i.length-C_P.length)}var s="Verbindungsfehler!",c="Lade Thema ",f="Starte Update",l="Neue Begriffe: ",g="Update abgeschlossen",p="Begriffe sind auf dem aktuellen Stand",L="Thema existiert nicht, folgende sind verfügbar:",d="(dsa update [thema] [-f, --force])",m=1,h=0,M="ulisses-regelwiki.de",R="http://www.ulisses-regelwiki.de/",S="http://www.ulisses-regelwiki.de/index.php/",I=".html",v="drain",E="td > a",C="#main .ce_text",O="h1",y="strong",T="p",A="br",N="href",b="<br>",w="<br/>",D=null,P=null,U=!1,x=!1,Q=[{name:"vorteil",urls:["vorteile"]}];return{start:n}}(),Commands=function(){function n(n,t,e){t=_.toInt(t,ROLLS_MIN);var r=_.toInt(e.plus,MOD_MIN),i=_.toInt(e.minus,MOD_MIN),o=r-i,a=n*t+o;_.printLine(),_.printLine(_.strDice(t,n)+_.strMod(r-i)),_.printLine(),_.rollDice(n,t).forEach(function(e,r){o+=e;var i=_.strRoll(_.indent(e,a),e,ROLL_CRIT,n);_.printList(r+1,t,i)}),_.printLine(),(t>ROLLS_MIN||r>MOD_MIN||i>MOD_MIN)&&(_.printLine(_.strSum(o,!0,t,a)),_.printLine())}function t(n,t,e){n=_.splitAttr(n),t=_.toInt(t,SKILL_MIN);var r=_.toInt(e.plus,MOD_MIN),i=_.toInt(e.minus,MOD_MIN),s=_.toInt(e.sammel,ROLLS_MIN),c=s>ROLLS_MIN,f=r-i,l=!1,g=!1,p=!1,L=0,d=0;if(n.length!==ROLLS_ATTR)_.printLine(),_.printMsg(u.red,0,!0),_.printMsg(a.grey.dim,0),_.printLine();else{_.printLine(),_.printLine(_.strDice(ROLLS_ATTR,D_20)+_.strAttr(n)+_.strMod(f)+_.strVal(t)+_.strRepeat(s)),_.printLine();for(var m=0;m<s;m++){for(var h=[],M=t+0,R=0;R<n.length;R++){h[R]=_.rollDice(D_20,ROLLS_MIN)[0];var S=Math.max(ATTR_MIN,n[R]+f-L),I=Math.max(ATTR_MIN,h[R]-S);M-=I}var v=_.countRolls(h,ROLL_SLIP)>=ROLLS_TO_CRIT,E=_.countRolls(h,ROLL_CRIT)>=ROLLS_TO_CRIT,C=_.calcQuality(M,E,v,c),O=C<QUAL_SUCCESS;if(g=!!g||v,p=!!p||E,l=!!l||O,d=v?C:d+C,L=E?MOD_MIN:O?L+1:L,_.printList(m+1,s,_.strRolls(h,ROLL_CRIT,ROLL_SLIP)+_.strPoints(M)+_.strQuality(C,E,v)+_.strSum(d,!1,0,QUAL_MAX*s)),v)break}_.printLine(),o(s,p,l,g)}}function e(n,t){t=t||"",n=n||"";var e=0===n.length;Data.load(function(i){if(_.printLine(),Object.keys(i).length>0){var o=[],a=!1;Object.keys(i).forEach(function(t){o.push(t),n.toLowerCase()===t.toLowerCase()&&(a=t)});var u=o.length;a?r(i[a],t,a):(e?_.printMsg(R.cyan,u):_.printMsg(M.red,u,!0),_.printLine(),o.forEach(function(n,t){_.printList(t+1,u,n)}),_.printLine(),_.printMsg(S.grey.dim,u),_.printLine())}else _.printMsg(I.red,0,!0),_.printMsg(v.grey.dim,0),_.printLine()})}function r(n,t,e){var r=0===t.length,o=_.strKeyword(t),a=t.toLowerCase(),u=!1,s=0,c=[],f=h.grey.dim;f=f.replace(REGEX_REPLACE,e),Object.keys(n).forEach(function(n){var t=n.toLowerCase();return a===t?void(u=n):void(t.indexOf(a)!==-1&&(c.push(n),s++))}),u?i(n[u]):s>0?(r?_.printMsg(m.cyan,s):_.printMsg(o+d.cyan,s),_.printLine(),c.forEach(function(n,t){_.printList(t+1,s,n)}),_.printLine(),_.printMsg(f,s),_.printLine()):(r?_.printMsg(L.red,0,!0):_.printMsg(o+p.red,0,!0),_.printMsg(f,s),_.printLine())}function i(n){_.printLine(_.formatOutput(n)),_.printLine()}function o(n,t,e,r){var i=!1,o=!1,a=n>ROLLS_MIN,u=!a&&e,p=!a&&!e;a||e||(o=g.green),!a&&e&&(o=l.red),a&&e&&(o=c.grey.dim),t&&(i=f.green),r&&(i=s.red),o&&_.printMsg(o,n,u,p),i&&_.printMsg(i,n,r,t),(i||o)&&_.printLine()}var a="(z.B. 11/13/12)",u="Probe im falschen Format!",s="Patzer (automatisch misslungen)",c="Nach misslungenen Proben Malus kumulativ +1",f="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",l="Erfolgsprobe misslungen",g="Erfolgsprobe bestanden",p="Kein passender Begriff gefunden.",L="Keine Begriffe verfügbar.",d="Folgende Begriffe wurden gefunden:",m="Folgende Begriffe sind verfügbar",h="(dsa suche $1 [begriff])",M="Thema existiert nicht, folgende sind verfügbar:",R="Folgende Themen sind verfügbar:",S="(dsa suche [thema] [begriff])",I="Keine Daten gefunden!",v="(dsa update [thema] [-f, --force])";return{find:e,roll:n,skill:t}}();[100,20,12,10,8,6,4,3,2].forEach(function(n){Program.command("w"+n+" [n]").description("nW"+n+" würfeln").option("-m, --minus <x>","Summe -x").option("-p, --plus <x>","Summe +x").action(function(t,e){Commands.roll(n,t,e)})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --minus <x>","Erleichterung +x").option("-p, --plus <x>","Erschwernis -x").option("-s, --sammel <n>","Sammelprobe mit n Versuchen").action(function(n,t,e){Commands.skill(n,t,e)}),Program.command("suche [thema] [begriff]").description("Regel-Thema nach einem Begriff durchsuchen").action(function(n,t){Commands.find(n,t)}),Program.command("update [thema]").description("Regeln aktualisieren").option("-f, --force","Aktualisierung erzwingen").action(function(n,t){Update.start(n,t)}),Program.version("0.0.1").parse(process.argv);