#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{PH:"$1",HEAD_L:"{{",HEAD_R:"}}",BOLD_L:"[[",BOLD_R:"]]",ITAL_L:"((",ITAL_R:"))",BULLET:". ",DELIMITER:"/"},REGEX:{HEAD:/\{\{([\s\S]*?)\}\}/g,BOLD:/\[\[([\s\S]*?)\]\]/g,ITAL:/\(\(([\s\S]*?)\)\)/g,IGNORE:/\[\[|\]\]|\{\{|\}\}|\(\(|\)\)/g,REMOVE:/I-.*(I|V|X)|\(\*\)|\.\.\.|\*/g}}}(),Util=function(){function n(n,e){return Math.floor(Math.random()*(e-n+1))+n}function e(n){var e=parseInt(n);return isNaN(e)?0:e}function r(n,e){return n.localeCompare(e)}return{randomInt:n,sortAlpha:r,toInt:e}}(),Str=function(){function n(n,e){for(var r=n.toString(),t=n.toString(),o=("undefined"==typeof e?"":e).toString(),i=0;i<o.length-t.length;i++)r=" "+r;return r}function e(n,e,r){return e+n.toString()+r}function r(n,e,r,t){var o=n.toString();return e===r?o.green:e===t?o.red:o}function t(n,e,t){var o=[];return n.forEach(function(n){o.push(r(n,n,e,t))}),o.join(G.STR.DELIMITER)}function o(n,e){return n.toString()+"d"+e.toString()+" "}function i(n){return e(n.join(G.STR.DELIMITER),"(",") ")}function a(n){return e(n,"[","] ")}function u(n){var e=n.toString()+" ";return n<0?e.red:n>0?("+"+e).green:("±"+e).grey.dim}function c(n){var e="×"+n.toString();return n>1?e.grey.dim:e.grey.dim}function s(e,r,t,o){var i=n(e,o),a=n("Σ",t),u=r?": ":" ";return(a+u).grey.dim+i.cyan}function l(e,r,t,o,i){var a=r||t?" ‼":"";a=r?a.green:t?a.red:a.grey.dim;var u="\tQS "+n(e,i);return u=e<o?u.grey.dim:u,u+a+"\t"}function f(e,r){var t="\t"+n(e,r*-1);return e<0?t.red:t.green}function g(n){return e(n,'"','"')}function h(n){return n.toString()+"%"}function d(n,e){var r=n/e,t=h(Math.round(100*r)),o=Math.round(15*r),i="=".repeat(o),a=" ".repeat(15-o);return Str.brackets(" "+i.cyan+a+" ")+t.magenta}return{percent:h,progressbar:d,indent:n,enclose:e,roll:r,rolls:t,dice:o,attr:i,brackets:a,mod:u,times:c,sum:s,quality:l,points:f,quote:g}}(),Log=function(){function n(n){s((n||"")+"\n")}function e(n){for(var e=0;e<(n||1);e++)s.previousLine(1),s.eraseLine()}function r(e){e="number"!=typeof e?1:e;for(var r=0;r<e;r++)n("")}function t(e,t,o){r(t),n(e),r(o)}function o(e){e.forEach(function(r,t){n((Str.indent(t+1,e.length)+G.STR.BULLET).grey.dim+r)})}function i(n,e,r,o,i,a){var u=" ".repeat(G.STR.BULLET.length),c=Str.indent("‼",e||0);r=r||!1,o=o||!1,c=r?c.red:o?c.green:c.grey.dim,t(c+u+n,i,a)}function a(n,e,r,t){i(n.red,e,!0,!1,r,t)}function u(n,e,r,t){i(n.toString().grey.dim,e,!1,!1,r,t)}function c(n,e,r,t){i(n.green,e,!1,!0,r,t)}var s=require("terminal-kit").terminal;return{spaced:t,success:c,empty:r,shout:i,error:a,hint:u,line:n,list:o,back:e}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),s=u.join(__dirname+i)}function e(e){n(),a.readFile(c,function(n,r){e(null!==n?{}:r)})}function r(e){n(),a.writeFile(c,e)}function t(e){n(),a.readFile(s,function(n,r){e(null!==n?{}:r)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,s=null;return{config:t,load:e,save:r}}(),Update=function(){function n(n,i){Data.config(function(a){e(a,function(){y=require("dns"),w=require("crawler"),D=a,_quick=i.schnell||!1,I=i.erzwingen||!1,T=r(n||""),T&&t(function(n){n&&Data.load(o)})})})}function e(n,e){n.hasOwnProperty("btn")&&n.hasOwnProperty("text")&&n.hasOwnProperty("topics")&&n.hasOwnProperty("domain")&&n.hasOwnProperty("protocol")?e():Log.error(h)}function r(n){var e=[],r=[],t=[];return D.topics.forEach(function(o){e.push(o.name),t.push(o),o.name===n.toLowerCase()&&r.push(o)}),n.length?r.length?r:(Log.error(p,e.length,1,0),Log.hint(L,e.length,0,1),Log.list(e),Log.empty(),!1):t}function t(n){var e=D.domain.replace("/","");y.lookup(e,function(r){r?(Log.error(d,0,1,0),Log.hint(e,0,0,1),n(!1)):n(!0)})}function o(n){var e={rateLimit:0,maxConnections:_quick?10:1},r=[],t=[],o=new w(e),l=new w(e),f=D.protocol+D.domain;T.forEach(function(e){var o=e.name;n.hasOwnProperty(o)&&!I||(n[o]={}),e.urls.forEach(function(e){M++,t.push({uri:f+e,callback:function(e,t,i){if(P++,e)return i(),!1;var l=t.$(D.btn).filter(function(){return!n[o].hasOwnProperty(c(t.$(this).text().trim()))});O+=l.length,a(),l.each(function(){var e=t.$(this),i=c(e.text().trim()),a=encodeURI(e.attr(k));r.push({uri:f+a,callback:function(e,r,t){return x++,e?(t(),!1):(n[o][i]=s(r.$,r.$(D.text)),u(o,i),Data.save(n),void t())}})}),i()}})})}),i([l,o],[t,r])}function i(n,e){var r=n.length;r===e.length&&n.forEach(function(t,o){0===o&&t.queue(e[o]),t.on("drain",function(){o+1<r&&n[o+1].queue(e[o+1])})})}function a(){var n=O+" "+m,e=Str.progressbar(P,M);Log.empty(1===P?2:0),Log.back(1===P?0:3),Log.success(n,0,0,0),Log.shout(e,0,!1,!1,0,1)}function u(n,e){var r=x+"/"+O+" ",t=n+" "+Str.quote(e),o=Str.progressbar(x,O);Log.empty(1===x?1:0),Log.back(1===x?0:3),Log.success(r+t,0,0,0),Log.shout(o,0,!1,!1,0,1)}function c(n){return n.replace(G.REGEX.REMOVE,"").trim()}function s(n,e){return e.length?(g(n,e),l(n,e,R,"\n"),f(n,e,S,G.STR.BOLD_L,G.STR.BOLD_R),f(n,e,E,G.STR.ITAL_L,G.STR.ITAL_R),f(n,e,v,G.STR.HEAD_L,G.STR.HEAD_R,"\n"),f(n,e,b,"\n","\n"),e.text().trim()):""}function l(n,e,r,t){e.find(r).replaceWith(t)}function f(n,e,r,t,o,i){e.find(r).each(function(){var e=n(this);e.replaceWith(Str.enclose(e.text(),t,o+(i||"")))})}function g(n,e){e.contents().filter(function(){var e=3===this.nodeType,r=0===n(this).text().trim().length;return r||e}).remove()}var h="Konfigurationsfehler!",d="Verbindungsfehler!",m="neue Begriffe gefunden",p="Thema existiert nicht, folgende sind verfügbar:",L="(dsa aktualisiere [thema] [-e])",v="h1",S="strong",E="em",b="p",R="br",k="href",y=null,w=null,T=!1,I=!1,D=!1,P=0,M=0,x=0,O=0;return{start:n}}(),Dice=function(){function n(n,e,r){e=Math.max(Util.toInt(e),1);var t=Util.toInt(r.mod),i=e>1||t,a=[],u=0;o(e,n).forEach(function(e,r){u+=e;var t=Str.indent(e,n);a.push(Str.roll(t,e,b,n))}),Log.spaced(Str.dice(e,n)+Str.mod(t)),Log.list(a),Log.spaced(i?Str.sum(u+t,!0):"",i?1:0)}function e(n,e,o){e=Math.max(Util.toInt(e),0),n=t(n);var s=Util.toInt(o.mod),g=o.wahrscheinlich||!1,h=Math.max(Util.toInt(o.sammel),1);h=g?0:h;var d=u(n,e,s);d=Str.percent(d);var m=h>1,p=!1,v=!1,R=!1,k=[],w=0,G=0;if(n.length!==L)Log.error(f,0,1,0),Log.hint(l,0,0,1);else{for(var I=0;I<h;I++){var D=i(n,e,s,w),P=D.results,M=D.points,x=c(P,E),O=c(P,b),$=a(M,O,x,m),A=$<T;if(v=!!v||x,R=!!R||O,p=!!p||A,G=x?$:G+$,w=O?0:A?w+1:w,k.push(Str.rolls(P,b,S)+Str.points(M,L*S)+Str.quality($,O,x,T,y)+Str.sum(G,!1,0,y*h)),x)break}if(Log.spaced(Str.dice(Str.indent(L,k.length),S)+Str.attr(n).magenta+Str.mod(s)+Str.brackets(e).magenta+Str.times(h)+" "+(g?d.cyan:d.grey.dim)),g)return;Log.list(k),r(k.length,R,p,v)}}function r(n,e,r,t){var o=!1,i=!1,a=n>1,u=!a&&r,c=!a&&!r;a||r||(i=p.green),!a&&r&&(i=m.red),a&&r&&(i=h.grey.dim),e&&(o=d.green),t&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,t,e,0,1),o||Log.empty()}function t(n){var e=[];return n.split(G.STR.DELIMITER).forEach(function(n){e.push(Math.max(Util.toInt(n),0))}),e}function o(n,e){for(var r=[],t=0;t<n;t++)r.push(Util.randomInt(1,e));return r}function i(n,e,r,t){var i=o(n.length,S),a=s(i,n,e,r,t);return{results:i,points:a}}function a(n,e,r,t){var o=Math.ceil(n/k),i=e?T:w,a=e&&t?R:r?0:1,u=0===n?T:o;return Math.max(Math.min(u*a,y),i)}function u(n,e,r){for(var t=0,o=1;o<=S;o++)for(var i=1;i<=S;i++)for(var a=1;a<=S;a++)if(c([o,i,a],b))t++;else if(!c([o,i,a],b)){var u=s([o,i,a],n,e,r,0);t+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(S,L))*t*100*100)/100}function c(n,e){var r=0;return n.forEach(function(n){r+=n===e?1:0}),r>=v}function s(n,e,r,t,o){var i=r+0;return n.forEach(function(n,r){i-=Math.max(0,n-(e[r]+t-o))}),i}var l="(z.B. 11/13/12)",f="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",m="Erfolgsprobe misslungen",p="Erfolgsprobe bestanden",L=3,v=2,S=20,E=20,b=1,R=2,k=3,y=6,w=0,T=1;return{roll:n,skill:e}}(),Search=function(){function n(n,r,o){E=require("didyoumean"),E.nullResultValue=!1,r=(r||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.raten||!1,a=o.ungenau||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=t(n,u),s=0===n.length,l=u.length,f=s?d.green:h.red;l&&c?e(o[c],r,c,a,i):l?(Log.shout(f,l,!s,s),Log.list(u),Log.hint(m,l)):(Log.error(p,l,1,0),Log.hint(L,l,0,1))})}function e(n,e,t,a,u){var h=0===e.length,d=Object.keys(n),m=!1,p=[],L=h?f:l,S=g.replace(G.STR.PH,t),E=v.replace(G.STR.PH,t);d.forEach(function(n){e===n.toLowerCase()?m=n:r(e,n,a)&&p.push(n)}),p.sort(Util.sortAlpha);var b=m?m:o(e,p,u),R=p.length;b?Log.spaced(i(n[b])):R?(Log.success(L,R),Log.list(p),Log.hint(S,R)):h&&!R?(Log.error(s,R,1,0),Log.hint(E,R,0,1)):(Log.error(c,R,1,0),Log.hint(S,R,0,1))}function r(n,e,r){var t=r?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),e=e.toLowerCase(),n.indexOf(e)!==-1||t(n,e)||e.indexOf(n)!==-1||t(e,n)}function t(n,e){return e.indexOf(n)>=0?n:E(n,e)}function o(n,e,r){return E.threshold=null,E.thresholdAbsolute=100,!!r&&E(n,e)}function i(n){return n=a(n),n=n.replace(G.REGEX.HEAD,G.STR.PH.green),n=n.replace(G.REGEX.BOLD,G.STR.PH.magenta),n=n.replace(G.REGEX.ITAL,G.STR.PH.cyan)}function a(n){var e=[];return n.split("\n").forEach(function(n){var r=[""],t=0;n.split(" ").forEach(function(n){u(n,r[t])||(r[++t]=""),r[t]+=n+" "}),r.forEach(function(n,e){r[e]=n.trim()}),e.push(r.join("\n"))}),e.join("\n")}function u(n,e){var r=n.replace(G.REGEX.IGNORE,""),t=e.replace(G.REGEX.IGNORE,"");return r.length+t.length<=S}var c="Kein passender Begriff gefunden.",s="Keine Begriffe verfügbar.",l="Folgende Begriffe wurden gefunden:",f="Folgende Begriffe sind verfügbar",g="(dsa suche $1 [begriff] [-u] [-r])",h="Thema existiert nicht, folgende sind verfügbar:",d="Folgende Themen sind verfügbar:",m="(dsa suche [thema] [begriff] [-u] [-r])",p="Keine Daten gefunden!",L="(dsa aktualisiere [thema] [-e])",v="(dsa aktualisiere $1 [-e])",S=80,E=null;return{find:n}}();!function(){function n(n,e){switch(e||(Log.line("  Examples:"),Log.empty()),n){case"dice":Log.line("    $ dsa w20 3 -m -2"),Log.line("    $ dsa w6 2 --mod 6");break;case"skill":Log.line("    $ dsa probe 13/16/14 6 -m -1"),Log.line("    $ dsa probe 14/13/15 9 -s 7 --mod 1"),Log.line("    $ dsa probe 12/13/11 4 --wahrscheinlich");break;case"update":Log.line("    $ dsa aktualisiere vorteil"),Log.line("    $ dsa aktualisiere kampf -s"),Log.line("    $ dsa aktualisiere --erzwingen");break;case"search":Log.line("    $ dsa suche"),Log.line("    $ dsa suche kultur"),Log.line("    $ dsa suche zauber ignifaxius"),Log.line("    $ dsa suche kampf wucht --raten"),Log.line('    $ dsa suche vorteil "verbessert leben" -ru'),Log.line('    $ dsa suche nachteil "schlechte energie" -u')}Log.empty()}[3,4,6,8,10,12,20,100].forEach(function(e){Program.command("w"+e+" [n]").description("N w"+e+" würfeln").option("-m, --mod <x>","Summenmodifikator").action(function(n,r){Dice.roll(e,n,r)}).on("--help",function(){n("dice")})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --mod <x>","Modifikator der Probe").option("-s, --sammel <n>","Sammelprobe mit N Versuchen").option("-w, --wahrscheinlich","Nur die Wahrscheinlichkeit anzeigen").action(function(n,e,r){Dice.skill(n,e,r)}).on("--help",function(){n("skill")}),Program.command("suche [thema] [begriff]").description("In einem Thema nach Begriff suchen").option("-u, --ungenau","Ungenaue Suche durchführen").option("-r, --raten","Suchergebnis raten").action(function(n,e,r){Search.find(n,e,r)}).on("--help",function(){n("search")}),Program.command("aktualisiere [thema]").description("Daten aktualisieren").option("-e, --erzwingen","Aktualisierung erzwingen").option("-s, --schnell","Mehr Verbindungen erlauben").action(function(n,e){Update.start(n,e)}).on("--help",function(){n("update")}),Program.version("0.0.1").description("Kommandozeilen-Tools für 'Das Schwarze Auge'").on("--help",function(){n("dice"),n("skill",!0),n("update",!0),n("search",!0)}).parse(process.argv),Program.args.length||Program.help()}();