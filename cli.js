#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{PH:"$1",HEAD_L:"{{",HEAD_R:"}}",BOLD_L:"[[",BOLD_R:"]]",ITAL_L:"((",ITAL_R:"))",BULLET:". ",DELIMITER:"/"},REGEX:{HEAD:/\{\{([\s\S]*?)\}\}/g,BOLD:/\[\[([\s\S]*?)\]\]/g,ITAL:/\(\(([\s\S]*?)\)\)/g,IGNORE:/\[\[|\]\]|\{\{|\}\}|\(\(|\)\)/g,REMOVE:/I-.*(I|V|X)|\(\*\)|\.\.\.|\*/g}}}(),Util=function(){function n(n,e){return Math.floor(Math.random()*(e-n+1))+n}function e(n){var e=parseInt(n);return isNaN(e)?0:e}function r(n,e){return n.localeCompare(e)}return{randomInt:n,sortAlpha:r,toInt:e}}(),Str=function(){function n(n,e){for(var r=n.toString(),t=n.toString(),o=("undefined"==typeof e?"":e).toString(),i=0;i<o.length-t.length;i++)r=" "+r;return r}function e(n,e,r){return e+n.toString()+r}function r(n,e,r,t){var o=n.toString();return e===r?o.green:e===t?o.red:o}function t(n,e,t){var o=[];return n.forEach(function(n){o.push(r(n,n,e,t))}),o.join(G.STR.DELIMITER)}function o(n,e){return n.toString()+"d"+e.toString()+" "}function i(n){return e(n.join(G.STR.DELIMITER),"(",") ")}function a(n){return e(n,"[","] ")}function u(n){var e=n.toString()+" ";return n<0?e.red:n>0?("+"+e).green:("±"+e).grey.dim}function c(n){var e="×"+n.toString();return n>1?e.grey.dim:e.grey.dim}function s(e,r,t,o){var i=n(e,o),a=n("Σ",t),u=r?": ":" ";return(a+u).grey.dim+i.cyan}function f(e,r,t,o,i){var a=r||t?" ‼":"";a=r?a.green:t?a.red:a.grey.dim;var u="\tQS "+n(e,i);return u=e<o?u.grey.dim:u,u+a+"\t"}function l(e,r){var t="\t"+n(e,r*-1);return e<0?t.red:t.green}function g(n){return e(n,'"','"')}function h(n){return n.toString()+"%"}function d(n,e){var r=n/e,t=h(Math.round(100*r)),o=Math.round(15*r),i="=".repeat(o),a=" ".repeat(15-o);return Str.brackets(" "+i.cyan+a+" ")+t.magenta}return{percent:h,progressbar:d,indent:n,enclose:e,roll:r,rolls:t,dice:o,attr:i,brackets:a,mod:u,times:c,sum:s,quality:f,points:l,quote:g}}(),Log=function(){function n(n){s((n||"")+"\n")}function e(n){for(var e=0;e<(n||1);e++)s.previousLine(1),s.eraseLine()}function r(e){e="number"!=typeof e?1:e;for(var r=0;r<e;r++)n("")}function t(e,t,o){r(t),n(e),r(o)}function o(e){e.forEach(function(r,t){n((Str.indent(t+1,e.length)+G.STR.BULLET).grey.dim+r)})}function i(n,e,r,o,i,a){var u=" ".repeat(G.STR.BULLET.length),c=Str.indent("‼",e||0);r=r||!1,o=o||!1,c=r?c.red:o?c.green:c.grey.dim,t(c+u+n,i,a)}function a(n,e,r,t){i(n.red,e,!0,!1,r,t)}function u(n,e,r,t){i(n.toString().grey.dim,e,!1,!1,r,t)}function c(n,e,r,t){i(n.green,e,!1,!0,r,t)}var s=require("terminal-kit").terminal;return{spaced:t,success:c,empty:r,shout:i,error:a,hint:u,line:n,list:o,back:e}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),s=u.join(__dirname+i)}function e(e){n(),a.readFile(c,function(n,r){e(null!==n?{}:r)})}function r(e){n(),a.writeFile(c,e)}function t(e){n(),a.readFile(s,function(n,r){e(null!==n?{}:r)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,s=null;return{config:t,load:e,save:r}}(),Update=function(){function n(n,i){Data.config(function(a){e(a,function(){T=require("dns"),w=require("crawler"),x=a,D=i.erzwingen||!1,I=r(n||""),I&&t(o)})})}function e(n,e){n.hasOwnProperty("btn")&&n.hasOwnProperty("text")&&n.hasOwnProperty("topics")&&n.hasOwnProperty("domain")&&n.hasOwnProperty("protocol")?e():Log.error(d)}function r(n){var e=[],r=[],t=[];return x.topics.forEach(function(o){e.push(o.name),t.push(o),o.name===n.toLowerCase()&&r.push(o)}),n.length?r.length?r:(Log.error(L,e.length,1,0),Log.hint(v,e.length,0,1),Log.list(e),Log.empty(),!1):t}function t(n){var e=x.domain.replace("/","");T.lookup(e,function(r){r?(Log.error(m,0,1,0),Log.hint(e,0,0,1),n(!1)):n(!0)})}function o(n){n&&Data.load(i)}function i(n){var e={maxConnections:1,rateLimit:0},r=[],t=[],o=[],i=new w(e),l=new w(e);I.forEach(function(e,i){var a=e.name,l="undefined"==typeof n[a]||D;l&&(n[a]={}),Data.save(n),r[i]=[],e.urls.forEach(function(e,l){r[i][l]=0,o.push({uri:x.protocol+x.domain+e,callback:function(e,o,g){if(!e){var h=o.$,d=h(x.btn).filter(function(){var e=s(h(this).text().trim());return e=n[a][e],"undefined"==typeof e});r[i][l]=d.length,u(i,l,r),d.each(function(e){var o=h(this).text().trim();o=s(o);var u=h(this).attr(k);u=encodeURI(u),t.push({uri:x.protocol+x.domain+u,callback:function(t,u,s){t||(n[a][o]=f(u.$,u.$(x.text)),Data.save(n),c(e,i,l,r,a,o),s())}})}),g()}}})})}),a([l,i],[o,t])}function a(n,e){var r=n.length;r===e.length&&n.forEach(function(t,o){0===o&&t.queue(e[o]),t.on("drain",function(){o+1<r&&n[o+1].queue(e[o+1])})})}function u(n,e,r){var t=0,o=0,i=1+e;r.forEach(function(e,r){t+=e.length,i+=r<n?e.length:0,e.forEach(function(n,e){o+=n})});var a=o+" "+p,u=Str.progressbar(i,t);Log.empty(1===i?2:0),Log.back(1===i?0:3),Log.success(a,0,0,0),Log.shout(u,0,!1,!1,0,1)}function c(n,e,r,t,o,i){var a=0,u=1+n;t.forEach(function(n,t){n.forEach(function(n,o){a+=n,u+=t===e&&o<r||t<e?n:0})});var c=u+"/"+a+" ",s=o+" "+Str.quote(i),f=Str.progressbar(u,a);Log.empty(1===u?1:0),Log.back(1===u?0:3),Log.success(c+s,0,0,0),Log.shout(f,0,!1,!1,0,1)}function s(n){return n.replace(G.REGEX.REMOVE,"").trim()}function f(n,e){return e.length?(h(n,e),l(n,e,y,"\n"),g(n,e,E,G.STR.BOLD_L,G.STR.BOLD_R),g(n,e,b,G.STR.ITAL_L,G.STR.ITAL_R),g(n,e,S,G.STR.HEAD_L,G.STR.HEAD_R,"\n"),g(n,e,R,"\n","\n"),e.text().trim()):""}function l(n,e,r,t){e.find(r).replaceWith(t)}function g(n,e,r,t,o,i){e.find(r).each(function(){var e=n(this);e.replaceWith(Str.enclose(e.text(),t,o+(i||"")))})}function h(n,e){e.contents().filter(function(){var e=3===this.nodeType,r=0===n(this).text().trim().length;return r||e}).remove()}var d="Konfigurationsfehler!",m="Verbindungsfehler!",p="neue Begriffe gefunden",L="Thema existiert nicht, folgende sind verfügbar:",v="(dsa aktualisiere [thema] [-e])",S="h1",E="strong",b="em",R="p",y="br",k="href",T=null,w=null,I=!1,D=!1,x=!1;return{start:n}}(),Dice=function(){function n(n,e,r){e=Math.max(Util.toInt(e),1);var t=Util.toInt(r.mod),i=e>1||t,a=[],u=0;o(e,n).forEach(function(e,r){u+=e;var t=Str.indent(e,n);a.push(Str.roll(t,e,b,n))}),Log.spaced(Str.dice(e,n)+Str.mod(t)),Log.list(a),Log.spaced(i?Str.sum(u+t,!0):"",i?1:0)}function e(n,e,o){e=Math.max(Util.toInt(e),0),n=t(n);var s=Util.toInt(o.mod),g=o.wahrscheinlich||!1,h=Math.max(Util.toInt(o.sammel),1);h=g?0:h;var d=u(n,e,s);d=Str.percent(d);var m=h>1,p=!1,v=!1,R=!1,y=[],T=0,G=0;if(n.length!==L)Log.error(l,0,1,0),Log.hint(f,0,0,1);else{for(var I=0;I<h;I++){var D=i(n,e,s,T),x=D.results,M=D.points,P=c(x,E),O=c(x,b),$=a(M,O,P,m),A=$<w;if(v=!!v||P,R=!!R||O,p=!!p||A,G=P?$:G+$,T=O?0:A?T+1:T,y.push(Str.rolls(x,b,S)+Str.points(M,L*S)+Str.quality($,O,P,w,k)+Str.sum(G,!1,0,k*h)),P)break}if(Log.spaced(Str.dice(Str.indent(L,y.length),S)+Str.attr(n).magenta+Str.mod(s)+Str.brackets(e).magenta+Str.times(h)+" "+(g?d.cyan:d.grey.dim)),g)return;Log.list(y),r(y.length,R,p,v)}}function r(n,e,r,t){var o=!1,i=!1,a=n>1,u=!a&&r,c=!a&&!r;a||r||(i=p.green),!a&&r&&(i=m.red),a&&r&&(i=h.grey.dim),e&&(o=d.green),t&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,t,e,0,1),o||Log.empty()}function t(n){var e=[];return n.split(G.STR.DELIMITER).forEach(function(n){e.push(Math.max(Util.toInt(n),0))}),e}function o(n,e){for(var r=[],t=0;t<n;t++)r.push(Util.randomInt(1,e));return r}function i(n,e,r,t){var i=o(n.length,S),a=s(i,n,e,r,t);return{results:i,points:a}}function a(n,e,r,t){var o=Math.ceil(n/y),i=e?w:T,a=e&&t?R:r?0:1,u=0===n?w:o;return Math.max(Math.min(u*a,k),i)}function u(n,e,r){for(var t=0,o=1;o<=S;o++)for(var i=1;i<=S;i++)for(var a=1;a<=S;a++)if(c([o,i,a],b))t++;else if(!c([o,i,a],b)){var u=s([o,i,a],n,e,r,0);t+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(S,L))*t*100*100)/100}function c(n,e){var r=0;return n.forEach(function(n){r+=n===e?1:0}),r>=v}function s(n,e,r,t,o){var i=r+0;return n.forEach(function(n,r){i-=Math.max(0,n-(e[r]+t-o))}),i}var f="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",m="Erfolgsprobe misslungen",p="Erfolgsprobe bestanden",L=3,v=2,S=20,E=20,b=1,R=2,y=3,k=6,T=0,w=1;return{roll:n,skill:e}}(),Search=function(){function n(n,r,o){E=require("didyoumean"),E.nullResultValue=!1,r=(r||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.raten||!1,a=o.ungenau||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=t(n,u),s=0===n.length,f=u.length,l=s?d.green:h.red;f&&c?e(o[c],r,c,a,i):f?(Log.shout(l,f,!s,s),Log.list(u),Log.hint(m,f)):(Log.error(p,f,1,0),Log.hint(L,f,0,1))})}function e(n,e,t,a,u){var h=0===e.length,d=Object.keys(n),m=!1,p=[],L=h?l:f,S=g.replace(G.STR.PH,t),E=v.replace(G.STR.PH,t);d.forEach(function(n){e===n.toLowerCase()?m=n:r(e,n,a)&&p.push(n)}),p.sort(Util.sortAlpha);var b=m?m:o(e,p,u),R=p.length;b?Log.spaced(i(n[b])):R?(Log.success(L,R),Log.list(p),Log.hint(S,R)):h&&!R?(Log.error(s,R,1,0),Log.hint(E,R,0,1)):(Log.error(c,R,1,0),Log.hint(S,R,0,1))}function r(n,e,r){var t=r?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),e=e.toLowerCase(),n.indexOf(e)!==-1||t(n,e)||e.indexOf(n)!==-1||t(e,n)}function t(n,e){return e.indexOf(n)>=0?n:E(n,e)}function o(n,e,r){return E.threshold=null,E.thresholdAbsolute=100,!!r&&E(n,e)}function i(n){return n=a(n),n=n.replace(G.REGEX.HEAD,G.STR.PH.green),n=n.replace(G.REGEX.BOLD,G.STR.PH.magenta),n=n.replace(G.REGEX.ITAL,G.STR.PH.cyan)}function a(n){var e=[];return n.split("\n").forEach(function(n){var r=[""],t=0;n.split(" ").forEach(function(n){u(n,r[t])||(r[++t]=""),r[t]+=n+" "}),r.forEach(function(n,e){r[e]=n.trim()}),e.push(r.join("\n"))}),e.join("\n")}function u(n,e){var r=n.replace(G.REGEX.IGNORE,""),t=e.replace(G.REGEX.IGNORE,"");return r.length+t.length<=S}var c="Kein passender Begriff gefunden.",s="Keine Begriffe verfügbar.",f="Folgende Begriffe wurden gefunden:",l="Folgende Begriffe sind verfügbar",g="(dsa suche $1 [begriff] [-u] [-r])",h="Thema existiert nicht, folgende sind verfügbar:",d="Folgende Themen sind verfügbar:",m="(dsa suche [thema] [begriff] [-u] [-r])",p="Keine Daten gefunden!",L="(dsa aktualisiere [thema] [-e])",v="(dsa aktualisiere $1 [-e])",S=80,E=null;return{find:n}}();!function(){function n(n,e){switch(e||(Log.line("  Examples:"),Log.empty()),n){case"dice":Log.line("    $ dsa w20 3 -m -2"),Log.line("    $ dsa w6 2 --mod 6");break;case"skill":Log.line("    $ dsa probe 13/16/14 6 -m -1"),Log.line("    $ dsa probe 14/13/15 9 -s 7 --mod 1"),Log.line("    $ dsa probe 12/13/11 4 --wahrscheinlich");break;case"update":Log.line("    $ dsa aktualisiere --erzwingen"),Log.line("    $ dsa aktualisiere vorteil");break;case"search":Log.line("    $ dsa suche"),Log.line("    $ dsa suche kultur"),Log.line("    $ dsa suche zauber ignifaxius"),Log.line("    $ dsa suche kampf wucht --raten"),Log.line('    $ dsa suche vorteil "verbessert leben" -ru'),Log.line('    $ dsa suche nachteil "schlechte energie" -u')}Log.empty()}[3,4,6,8,10,12,20,100].forEach(function(e){Program.command("w"+e+" [n]").description("N w"+e+" würfeln").option("-m, --mod <x>","Summenmodifikator").action(function(n,r){Dice.roll(e,n,r)}).on("--help",function(){n("dice")})}),Program.command("probe <probe> <fw>").description("Fertigkeitsprobe würfeln").option("-m, --mod <x>","Modifikator der Probe").option("-s, --sammel <n>","Sammelprobe mit N Versuchen").option("-w, --wahrscheinlich","Nur die Wahrscheinlichkeit anzeigen").action(function(n,e,r){Dice.skill(n,e,r)}).on("--help",function(){n("skill")}),Program.command("suche [thema] [begriff]").description("In einem Thema nach Begriff suchen").option("-u, --ungenau","Ungenaue Suche durchführen").option("-r, --raten","Suchergebnis raten").action(function(n,e,r){Search.find(n,e,r)}).on("--help",function(){n("search")}),Program.command("aktualisiere [thema]").description("Daten aktualisieren").option("-e, --erzwingen","Aktualisierung erzwingen").action(function(n,e){Update.start(n,e)}).on("--help",function(){n("update")}),Program.version("0.0.1").description("Kommandozeilen-Tools für 'Das Schwarze Auge'").on("--help",function(){n("dice"),n("skill",!0),n("update",!0),n("search",!0)}).parse(process.argv),Program.args.length||Program.help()}();