#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{TITLE:"++",BOLD:"==",PARA:"__",ITALIC:"--",NL:"\n",TAB:"\t",SPACE:" ",BULLET:". ",ALERT:"‼",QUOTE_LEFT:"„",QUOTE_RIGHT:"“",BRACK_LEFT:"[",BRACK_RIGHT:"]",PAREN_LEFT:"(",PAREN_RIGHT:")",HYPHEN:" — ",QUAL:"QS",SUM:"Σ",COLON:":",TIMES:"×",PLUS:"+",MINUS:"-",PLUSMINUS:"±",DELIMITER:"/",DICE:"d",TIC:".",PERCENT:"%",PROB:"P"},REGEX:{PH:"$1",TITLE:/\+\+(.*?)\+\+/g,BOLD:/==(.*?)==/g,ITALIC:/--(.*?)--/g,PARA:/__/g,HASH:/#(?!#)/g,LVL:/ I-.*(I|V|X)/,STAR:/ \(\*\)/,DOTS:/ \.\.\./}}}(),Util=function(){function n(n,e){return Math.floor(Math.random()*(e-n+1))+n}function e(n){var e=parseInt(n);return isNaN(e)?0:e}function t(n,e){return n.localeCompare(e)}return{randomInt:n,sortAlpha:t,toInt:e}}(),Str=function(){function n(n,e){for(var t=n.toString(),r=e.toString(),o=0;o<r.length-t.length;o++)n=G.STR.SPACE+n;return n}function e(n,e,t){return e+n.toString()+t}function t(n,e,t,r){return n=n.toString(),e===t?n.green:e===r?n.red:n}function r(n,e,r){var o=[];return n.forEach(function(n){o.push(t(n,n,e,r))}),o.join(G.STR.DELIMITER)}function o(n,e){return n.toString()+G.STR.DICE+e.toString()+G.STR.SPACE}function i(n){return e(n.join(G.STR.DELIMITER),G.STR.PAREN_LEFT,G.STR.PAREN_RIGHT+G.STR.SPACE)}function a(n){return e(n,G.STR.BRACK_LEFT,G.STR.BRACK_RIGHT+G.STR.SPACE)}function u(n){var e=n.toString()+G.STR.SPACE;return n<0?e.red:n>0?(G.STR.PLUS+e).green:(G.STR.PLUSMINUS+e).grey.dim}function c(n){var e=G.STR.TIMES+n.toString();return n>1?e:e.grey.dim}function f(e,t,r,o){var i=n(G.STR.SUM,r||0),a=t?G.STR.COLON+G.STR.SPACE:G.STR.SPACE;return(i+a).grey.dim+n(e,o||0)}function s(e,t,r,o,i){var a=t||r?G.STR.SPACE+G.STR.ALERT:"";a=t?a.green:r?a.red:a.grey.dim;var u=G.STR.TAB+G.STR.QUAL+G.STR.SPACE+n(e,i);return u=e<o?u.grey.dim:u,u+a+G.STR.TAB}function l(e,t){var r=G.STR.TAB+n(e,t*-1);return e<0?r.red:r.green}function g(n){return e(n,G.STR.QUOTE_LEFT,G.STR.QUOTE_RIGHT)}function h(n){return g(n).yellow+G.STR.HYPHEN.grey.dim}function d(n){return G.STR.PROB+G.STR.SPACE+n.toString()+G.STR.PERCENT}return{probability:d,indent:n,enclose:e,roll:t,rolls:r,dice:o,attr:i,brackets:a,mod:u,times:c,sum:f,quality:s,points:l,quote:g,phrase:h}}(),Log=function(){function n(n){f((n||"")+G.STR.NL)}function e(n){for(var e=0;e<(n||1);e++)f.previousLine(1),f.eraseLine()}function t(e){e="number"!=typeof e?1:e;for(var t=0;t<e;t++)n("")}function r(e,r,o){t(r),n(e),t(o)}function o(e){e.forEach(function(t,r){n((Str.indent(r+1,e.length)+G.STR.BULLET).grey.dim+t)})}function i(n,e,t,o,i,a){var u=G.STR.SPACE.repeat(G.STR.BULLET.length),c=Str.indent(G.STR.ALERT,e||0);t=t||!1,o=o||!1,c=t?c.red:o?c.green:c.grey.dim,r(c+u+n,i,a)}function a(n,e,t,r){i(n.red,e,!0,!1,t,r)}function u(n,e,t,r){i(n.grey.dim,e,!1,!1,t,r)}function c(n,e,t,r){i(n.green,e,!1,!0,t,r)}var f=require("terminal-kit").terminal;return{spaced:r,success:c,empty:t,shout:i,error:a,hint:u,line:n,list:o,back:e}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),f=u.join(__dirname+i)}function e(e){n(),a.readFile(c,function(n,t){e(null!==n?{}:t)})}function t(e){n(),a.writeFile(c,e)}function r(e){n(),a.readFile(f,function(n,t){e(null!==n?{}:t)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,f=null;return{config:r,load:e,save:t}}(),Update=function(){function n(n,e){Data.config(function(r){_=require("dns"),N=require("crawler"),F=r.config,q=e.force||!1,X=f(n||""),X!==!1&&s(t)})}function e(n){i();var e={maxConnections:E,rateLimit:L},t=0,a=[],u=[],c=[],f=new N(e),s=new N(e);X.forEach(function(e,r){var i=e.name,f="undefined"==typeof n[i]||q;f&&(n[i]={}),Data.save(n),a[r]=[],e.urls.forEach(function(e,f){a[r][f]=0,c.push({uri:I+e+b,callback:function(e,c,s){if(!e){var h=c.$,d=h(C).filter(function(){var e=l(h(this).text().trim());return e=n[i][e],"undefined"==typeof e}),S=d.length;t=S>t?S:t,a[r][f]=S,d.each(function(e){var t=h(this).text().trim();t=l(t);var c=h(this).attr(D);c=encodeURI(c),u.push({uri:P+c,callback:function(u,c,s){u||(n[i][t]=g(c.$,c.$(U)),Data.save(n),o(e,r,f,a,i,t),s())}})}),s()}}})})}),r([s,f],[c,u])}function t(n){n&&Data.load(e)}function r(n,e){var t=n.length;t===e.length&&n.forEach(function(r,o){0===o&&r.queue(e[o]),r.on(y,function(){if(0===o){var r=e[o+1].length;r?a(r):c()}o+1<t&&n[o+1].queue(e[o+1]),o===t-1&&u(e[o].length)})})}function o(n,e,t,r,o,i){var a=1+n;r.forEach(function(n,r){n.forEach(function(n,o){a+=r===e&&o<t||r<e?n:0})}),Log.back();var u=o+G.STR.SPACE+Str.quote(i);Log.hint(a+G.STR.BULLET+u,0,0,0)}function i(){var n=0;Log.empty(2),j=setInterval(function(){n=n>=m?0:n+1,Log.back(),Log.line(G.STR.TIC.repeat(n).green)},v)}function a(n){clearInterval(j);var e=d.replace(G.REGEX.PH,n);Log.back(),Log.success(e,0,0)}function u(){Log.back(),Log.success(S,0,0)}function c(){clearInterval(j),Log.back(),Log.success(T,0,0)}function f(n){var e=[],t=[],r=[];return F.forEach(function(o){e.push(o.name),r.push(o),o.name===n.toLowerCase()&&t.push(o)}),n.length?t.length?t:(Log.error(p,e.length,1,0),Log.hint(R,e.length,0,1),Log.list(e),Log.empty(),!1):r}function s(n){_.lookup(A,function(e){e?(Log.error(h,0,1,0),Log.hint(A,0,0,1),n(!1)):n(!0)})}function l(n){return n=n.replace(G.REGEX.LVL,""),n=n.replace(G.REGEX.STAR,""),n=n.replace(G.REGEX.DOTS,"")}function g(n,e){function t(){return 3===this.nodeType}function r(){return!n(this).text().trim().length}if(!e.length)return"";e.contents().filter(t).remove(),e.children().filter(r).remove(),e.html(e.html().split(H).join(O)),e.find(k).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.TITLE,G.STR.TITLE+G.STR.PARA))}),e.find(x).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.BOLD,G.STR.BOLD))}),e.find(B).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.ITALIC,G.STR.ITALIC))}),e.find(w).each(function(){n(this).replaceWith(G.STR.PARA)}),e.find(M).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.PARA,G.STR.PARA))});var o=e.text().trim();return o=o.replace(G.REGEX.HASH,""),o.substr(0,o.length-G.STR.PARA.length)}var h="Verbindungsfehler!",d="Update: $1 neue Begriffe gefunden",S="Update abgeschlossen",T="Begriffe sind auf dem aktuellen Stand",p="Thema existiert nicht, folgende sind verfügbar:",R="(dsa update [topic] [-f])",E=1,L=0,m=3,v=300,A="ulisses-regelwiki.de",P="http://www.ulisses-regelwiki.de/",I="http://www.ulisses-regelwiki.de/index.php/",b=".html",y="drain",C="td > a",U="#main .ce_text",k="h1",x="strong",B="em",M="p",w="br",D="href",H="<br>",O="<br/>",_=null,N=null,X=!1,q=!1,F=null,j=null;return{start:n}}(),Dice=function(){function n(n,e,t){e=Math.max(Util.toInt(e),E);var r=Util.toInt(t.mod),i=e>E||r,a=[],u=0;o(e,n).forEach(function(e,t){u+=e;var r=Str.indent(e,n);a.push(Str.roll(r,e,L,n))}),Log.spaced(Str.dice(e,n)+Str.mod(r)),Log.list(a),Log.spaced(i?Str.sum(u+r,!0,e):"",i?1:0)}function e(n,e,o){e=Math.max(Util.toInt(e),0),n=r(n);var f=Util.toInt(o.mod),g=o.probability||!1,h=Math.max(Util.toInt(o.repeat),E);h=g?0:h;var d=u(n,e,f);d=Str.probability(d);var S=h>E,T=!1,R=!1,v=!1,A=[],I=0,y=0;if(n.length!==p)Log.error(l,0,1,0),Log.hint(s,0,0,1);else{for(var C=0;C<h;C++){var U=i(n,e,f,I),k=U.results,x=U.points,B=c(k,m),M=c(k,L),w=a(x,M,B,S),D=w<b;if(R=!!R||B,v=!!v||M,T=!!T||D,y=B?w:y+w,I=M?0:D?I+1:I,A.push(Str.rolls(k,L,m)+Str.points(x,p*m)+Str.quality(w,M,B,b,P)+Str.sum(y,!1,0,P*h)),B)break}if(Log.spaced(Str.dice(Str.indent(p,A.length),m)+Str.attr(n)+Str.mod(f)+Str.brackets(e)+Str.times(h)+G.STR.HYPHEN.grey.dim+(g?d.cyan:d.grey.dim)),g)return;Log.list(A),t(A.length,v,T,R)}}function t(n,e,t,r){var o=!1,i=!1,a=n>E,u=!a&&t,c=!a&&!t;a||t||(i=T.green),!a&&t&&(i=S.red),a&&t&&(i=h.grey.dim),e&&(o=d.green),r&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,r,e,0,1),o||Log.empty()}function r(n){var e=[];return n.split(G.STR.DELIMITER).forEach(function(n){e.push(Math.max(Util.toInt(n),0))}),e}function o(n,e){for(var t=[],r=0;r<n;r++)t.push(Util.randomInt(1,e));return t}function i(n,e,t,r){var i=o(n.length,m),a=f(i,n,e,t,r);return{results:i,points:a}}function a(n,e,t,r){var o=Math.ceil(n/A),i=e?b:I,a=e&&r?v:t?0:1,u=0===n?b:o;return Math.max(Math.min(u*a,P),i)}function u(n,e,t){for(var r=0,o=1;o<=m;o++)for(var i=1;i<=m;i++)for(var a=1;a<=m;a++)if(c([o,i,a],L))r++;else if(!c([o,i,a],m)){var u=f([o,i,a],n,e,t,0);r+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(m,3))*r*100*100)/100}function c(n,e){var t=0;return n.forEach(function(n){t+=n===e?1:0}),t>=R}function f(n,e,t,r,o){var i=t+0;return n.forEach(function(n,t){i-=Math.max(0,n-(e[t]+r-o))}),i}var s="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",S="Erfolgsprobe misslungen",T="Erfolgsprobe bestanden",p=3,R=2,E=1,L=1,m=20,v=2,A=3,P=6,I=0,b=1;return{roll:n,skill:e}}(),Search=function(){function n(n,t,o){p=require("didyoumean"),p.nullResultValue=!1,t=(t||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.guess||!1,a=o.fuzzy||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=r(n,u),f=0===n.length,s=u.length,T=f?g.green:l.red;s&&c?e(o[c],t,c,a,i):s?(Log.shout(T,s,!f,f),Log.list(u),Log.hint(h,s)):(Log.error(d,s,1,0),Log.hint(S,s,0,1))})}function e(n,e,r,l,g){var h=0===e.length,d=(Str.phrase(e),Object.keys(n)),S=!1,p=[],R=h?f:c,E=s.replace(G.REGEX.PH,r),L=T.replace(G.REGEX.PH,r);d.forEach(function(n){e===n.toLowerCase()?S=n:t(e,n,l)&&p.push(n)}),p.sort(Util.sortAlpha);var m=S?S:o(e,p,g),v=p.length;m?Log.spaced(i(n[m])):v?(Log.success(R,v),Log.list(p),Log.hint(E,v)):h&&!v?(Log.error(u,v,1,0),Log.hint(L,v,0,1)):(Log.error(a,v,1,0),Log.hint(E,v,0,1))}function t(n,e,t){var r=t?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),e=e.toLowerCase(),n.indexOf(e)!==-1||r(n,e)||e.indexOf(n)!==-1||r(e,n)}function r(n,e){return e.indexOf(n)>=0?n:p(n,e)}function o(n,e,t){return p.threshold=null,p.thresholdAbsolute=100,!!t&&p(n,e)}function i(n){return n=n.replace(G.REGEX.PARA,G.STR.NL),n=n.replace(G.REGEX.TITLE,G.REGEX.PH.green),n=n.replace(G.REGEX.BOLD,G.REGEX.PH.yellow),n=n.replace(G.REGEX.ITALIC,G.REGEX.PH.grey)}var a="Kein passender Begriff gefunden.",u="Keine Begriffe verfügbar.",c="Folgende Begriffe wurden gefunden:",f="Folgende Begriffe sind verfügbar",s="(dsa search $1 [phrase] [-f] [-g])",l="Thema existiert nicht, folgende sind verfügbar:",g="Folgende Themen sind verfügbar:",h="(dsa search [topic] [phrase] [-f] [-g])",d="Keine Daten gefunden!",S="(dsa update [topic] [-f])",T="(dsa update $1 [-f])",p=null;return{find:n}}();!function(){Program.version("0.0.1").description("CLI tools for The Dark Eye"),[3,4,6,8,10,12,20,100].forEach(function(n){Program.command("d"+n+" [n]").description("roll d"+n+" n times").option("-m, --mod <x>","modify sum by x").action(function(e,t){Dice.roll(n,e,t)})}),Program.command("skill <attributes> <value>").description("make skill check").option("-m, --mod <x>","modify check by x").option("-r, --repeat <n>","repeat check n times").option("-p, --probability","show probability of success").action(function(n,e,t){Dice.skill(n,e,t)}),Program.command("search [topic] [phrase]").description("search for phrase in topic").option("-f, --fuzzy","use fuzzy search").option("-g, --guess","guess correct result").action(function(n,e,t){Search.find(n,e,t)}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(n,e){Update.start(n,e)}),Program.parse(process.argv),Program.args.length||Program.help()}();