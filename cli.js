#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{PH:"$1",HEAD_L:"{{",HEAD_R:"}}",BOLD_L:"[[",BOLD_R:"]]",ITAL_L:"((",ITAL_R:"))",BULLET:". ",DELIMITER:"/"},REGEX:{HEAD:/\{\{([\s\S]*?)\}\}/g,BOLD:/\[\[([\s\S]*?)\]\]/g,ITAL:/\(\(([\s\S]*?)\)\)/g,IGNORE:/\[\[|\]\]|\{\{|\}\}|\(\(|\)\)/g,REMOVE:/I-.*(I|V|X)|\(\*\)|\.\.\.|\*/g}}}(),Util=function(){function n(n,r){return Math.floor(Math.random()*(r-n+1))+n}function r(n){var r=parseInt(n);return isNaN(r)?0:r}function e(n,r){return n.localeCompare(r)}return{randomInt:n,sortAlpha:e,toInt:r}}(),Str=function(){function n(n,r){for(var e=n.toString(),t=n.toString(),o=("undefined"==typeof r?"":r).toString(),i=0;i<o.length-t.length;i++)e=" "+e;return e}function r(n,r,e){return r+n.toString()+e}function e(n,r,e,t){var o=n.toString();return r===e?o.green:r===t?o.red:o}function t(n,r,t){var o=[];return n.forEach(function(n){o.push(e(n,n,r,t))}),o.join(G.STR.DELIMITER)}function o(n,r){return n.toString()+"d"+r.toString()+" "}function i(n){return r(n.join(G.STR.DELIMITER),"(",") ")}function a(n){return r(n,"[","] ")}function u(n){var r=n.toString()+" ";return n<0?r.red:n>0?("+"+r).green:("±"+r).grey.dim}function c(n){var r="×"+n.toString();return n>1?r.grey.dim:r.grey.dim}function s(r,e,t,o){var i=n(r,o),a=n("Σ",t),u=e?": ":" ";return(a+u).grey.dim+i.cyan}function f(r,e,t,o,i){var a=e||t?" ‼":"";a=e?a.green:t?a.red:a.grey.dim;var u="\tQS "+n(r,i);return u=r<o?u.grey.dim:u,u+a+"\t"}function l(r,e){var t="\t"+n(r,e*-1);return r<0?t.red:t.green}function g(n){return r(n,'"','"')}function h(n){return n.toString()+"%"}function d(n,r){var e=n/r,t=h(Math.round(100*e)),o=Math.round(15*e),i="=".repeat(o),a=" ".repeat(15-o);return Str.brackets(" "+i.cyan+a+" ")+t.magenta}return{percent:h,progressbar:d,indent:n,enclose:r,roll:e,rolls:t,dice:o,attr:i,brackets:a,mod:u,times:c,sum:s,quality:f,points:l,quote:g}}(),Log=function(){function n(n){s((n||"")+"\n")}function r(n){for(var r=0;r<(n||1);r++)s.previousLine(1),s.eraseLine()}function e(r){r="number"!=typeof r?1:r;for(var e=0;e<r;e++)n("")}function t(r,t,o){e(t),n(r),e(o)}function o(r){r.forEach(function(e,t){n((Str.indent(t+1,r.length)+G.STR.BULLET).grey.dim+e)})}function i(n,r,e,o,i,a){var u=" ".repeat(G.STR.BULLET.length),c=Str.indent("‼",r||0);e=e||!1,o=o||!1,c=e?c.red:o?c.green:c.grey.dim,t(c+u+n,i,a)}function a(n,r,e,t){i(n.red,r,!0,!1,e,t)}function u(n,r,e,t){i(n.toString().grey.dim,r,!1,!1,e,t)}function c(n,r,e,t){i(n.green,r,!1,!0,e,t)}var s=require("terminal-kit").terminal;return{spaced:t,success:c,empty:e,shout:i,error:a,hint:u,line:n,list:o,back:r}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),s=u.join(__dirname+i)}function r(r){n(),a.readFile(c,function(n,e){r(null!==n?{}:e)})}function e(r){n(),a.writeFile(c,r)}function t(r){n(),a.readFile(s,function(n,e){r(null!==n?{}:e)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,s=null;return{config:t,load:r,save:e}}(),Update=function(){function n(n,i){Data.config(function(a){r(a,function(){k=require("dns"),I=require("crawler"),P=a,x=i.force||!1,D=e(n||""),D&&t(o)})})}function r(n,r){n.hasOwnProperty("btn")&&n.hasOwnProperty("text")&&n.hasOwnProperty("topics")&&n.hasOwnProperty("domain")&&n.hasOwnProperty("protocol")?r():Log.error(d)}function e(n){var r=[],e=[],t=[];return P.topics.forEach(function(o){r.push(o.name),t.push(o),o.name===n.toLowerCase()&&e.push(o)}),n.length?e.length?e:(Log.error(L,r.length,1,0),Log.hint(v,r.length,0,1),Log.list(r),Log.empty(),!1):t}function t(n){var r=P.domain.replace("/","");k.lookup(r,function(e){e?(Log.error(p,0,1,0),Log.hint(r,0,0,1),n(!1)):n(!0)})}function o(n){n&&Data.load(i)}function i(n){var r={maxConnections:1,rateLimit:0},e=[],t=[],o=[],i=new I(r),l=new I(r);D.forEach(function(r,i){var a=r.name,l="undefined"==typeof n[a]||x;l&&(n[a]={}),Data.save(n),e[i]=[],r.urls.forEach(function(r,l){e[i][l]=0,o.push({uri:P.protocol+P.domain+r,callback:function(r,o,g){if(!r){var h=o.$,d=h(P.btn).filter(function(){var r=s(h(this).text().trim());return r=n[a][r],"undefined"==typeof r});e[i][l]=d.length,u(i,l,e),d.each(function(r){var o=h(this).text().trim();o=s(o);var u=h(this).attr(T);u=encodeURI(u),t.push({uri:P.protocol+P.domain+u,callback:function(t,u,s){t||(n[a][o]=f(u.$,u.$(P.text)),Data.save(n),c(r,i,l,e,a,o),s())}})}),g()}}})})}),a([l,i],[o,t])}function a(n,r){var e=n.length;e===r.length&&n.forEach(function(t,o){0===o&&t.queue(r[o]),t.on("drain",function(){o+1<e&&n[o+1].queue(r[o+1])})})}function u(n,r,e){var t=0,o=0,i=1+r;e.forEach(function(r,e){t+=r.length,i+=e<n?r.length:0,r.forEach(function(n,r){o+=n})});var a=o+" "+m,u=Str.progressbar(i,t);Log.empty(1===i?2:0),Log.back(1===i?0:3),Log.success(a,0,0,0),Log.shout(u,0,!1,!1,0,1)}function c(n,r,e,t,o,i){var a=0,u=1+n;t.forEach(function(n,t){n.forEach(function(n,o){a+=n,u+=t===r&&o<e||t<r?n:0})});var c=u+"/"+a+" ",s=o+" "+Str.quote(i),f=Str.progressbar(u,a);Log.empty(1===u?1:0),Log.back(1===u?0:3),Log.success(c+s,0,0,0),Log.shout(f,0,!1,!1,0,1)}function s(n){return n.replace(G.REGEX.REMOVE,"").trim()}function f(n,r){return r.length?(h(n,r),l(n,r,R,"\n"),g(n,r,S,G.STR.BOLD_L,G.STR.BOLD_R),g(n,r,y,G.STR.ITAL_L,G.STR.ITAL_R),g(n,r,E,G.STR.HEAD_L,G.STR.HEAD_R,"\n"),g(n,r,b,"\n","\n"),r.text().trim()):""}function l(n,r,e,t){r.find(e).replaceWith(t)}function g(n,r,e,t,o,i){r.find(e).each(function(){var r=n(this);r.replaceWith(Str.enclose(r.text(),t,o+(i||"")))})}function h(n,r){r.contents().filter(function(){var r=3===this.nodeType,e=0===n(this).text().trim().length;return e||r}).remove()}var d="Konfigurationsfehler!",p="Verbindungsfehler!",m="neue Begriffe gefunden",L="Thema existiert nicht, folgende sind verfügbar:",v="(dsa update [topic] [-f])",E="h1",S="strong",y="em",b="p",R="br",T="href",k=null,I=null,D=!1,x=!1,P=!1;return{start:n}}(),Dice=function(){function n(n,r,e){r=Math.max(Util.toInt(r),1);var t=Util.toInt(e.mod),i=r>1||t,a=[],u=0;o(r,n).forEach(function(r,e){u+=r;var t=Str.indent(r,n);a.push(Str.roll(t,r,y,n))}),Log.spaced(Str.dice(r,n)+Str.mod(t)),Log.list(a),Log.spaced(i?Str.sum(u+t,!0):"",i?1:0)}function r(n,r,o){r=Math.max(Util.toInt(r),0),n=t(n);var s=Util.toInt(o.mod),g=o.probability||!1,h=Math.max(Util.toInt(o.repeat),1);h=g?0:h;var d=u(n,r,s);d=Str.percent(d);var p=h>1,m=!1,v=!1,b=!1,R=[],k=0,G=0;if(n.length!==L)Log.error(l,0,1,0),Log.hint(f,0,0,1);else{for(var D=0;D<h;D++){var x=i(n,r,s,k),P=x.results,M=x.points,O=c(P,S),w=c(P,y),$=a(M,w,O,p),A=$<I;if(v=!!v||O,b=!!b||w,m=!!m||A,G=O?$:G+$,k=w?0:A?k+1:k,R.push(Str.rolls(P,y,E)+Str.points(M,L*E)+Str.quality($,w,O,I,T)+Str.sum(G,!1,0,T*h)),O)break}if(Log.spaced(Str.dice(Str.indent(L,R.length),E)+Str.attr(n).magenta+Str.mod(s)+Str.brackets(r).magenta+Str.times(h)+" "+(g?d.cyan:d.grey.dim)),g)return;Log.list(R),e(R.length,b,m,v)}}function e(n,r,e,t){var o=!1,i=!1,a=n>1,u=!a&&e,c=!a&&!e;a||e||(i=m.green),!a&&e&&(i=p.red),a&&e&&(i=h.grey.dim),r&&(o=d.green),t&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,t,r,0,1),o||Log.empty()}function t(n){var r=[];return n.split(G.STR.DELIMITER).forEach(function(n){r.push(Math.max(Util.toInt(n),0))}),r}function o(n,r){for(var e=[],t=0;t<n;t++)e.push(Util.randomInt(1,r));return e}function i(n,r,e,t){var i=o(n.length,E),a=s(i,n,r,e,t);return{results:i,points:a}}function a(n,r,e,t){var o=Math.ceil(n/R),i=r?I:k,a=r&&t?b:e?0:1,u=0===n?I:o;return Math.max(Math.min(u*a,T),i)}function u(n,r,e){for(var t=0,o=1;o<=E;o++)for(var i=1;i<=E;i++)for(var a=1;a<=E;a++)if(c([o,i,a],y))t++;else if(!c([o,i,a],y)){var u=s([o,i,a],n,r,e,0);t+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(E,L))*t*100*100)/100}function c(n,r){var e=0;return n.forEach(function(n){e+=n===r?1:0}),e>=v}function s(n,r,e,t,o){var i=e+0;return n.forEach(function(n,e){i-=Math.max(0,n-(r[e]+t-o))}),i}var f="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",p="Erfolgsprobe misslungen",m="Erfolgsprobe bestanden",L=3,v=2,E=20,S=20,y=1,b=2,R=3,T=6,k=0,I=1;return{roll:n,skill:r}}(),Search=function(){function n(n,e,o){S=require("didyoumean"),S.nullResultValue=!1,e=(e||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.guess||!1,a=o.fuzzy||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=t(n,u),s=0===n.length,f=u.length,l=s?d.green:h.red;f&&c?r(o[c],e,c,a,i):f?(Log.shout(l,f,!s,s),Log.list(u),Log.hint(p,f)):(Log.error(m,f,1,0),Log.hint(L,f,0,1))})}function r(n,r,t,a,u){var h=0===r.length,d=Object.keys(n),p=!1,m=[],L=h?l:f,E=g.replace(G.STR.PH,t),S=v.replace(G.STR.PH,t);d.forEach(function(n){r===n.toLowerCase()?p=n:e(r,n,a)&&m.push(n)}),m.sort(Util.sortAlpha);var y=p?p:o(r,m,u),b=m.length;y?Log.spaced(i(n[y])):b?(Log.success(L,b),Log.list(m),Log.hint(E,b)):h&&!b?(Log.error(s,b,1,0),Log.hint(S,b,0,1)):(Log.error(c,b,1,0),Log.hint(E,b,0,1))}function e(n,r,e){var t=e?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),r=r.toLowerCase(),n.indexOf(r)!==-1||t(n,r)||r.indexOf(n)!==-1||t(r,n)}function t(n,r){return r.indexOf(n)>=0?n:S(n,r)}function o(n,r,e){return S.threshold=null,S.thresholdAbsolute=100,!!e&&S(n,r)}function i(n){return n=a(n),n=n.replace(G.REGEX.HEAD,G.STR.PH.green),n=n.replace(G.REGEX.BOLD,G.STR.PH.magenta),n=n.replace(G.REGEX.ITAL,G.STR.PH.cyan)}function a(n){var r=[];return n.split("\n").forEach(function(n){var e=[""],t=0;n.split(" ").forEach(function(n){u(n,e[t])||(e[++t]=""),e[t]+=n+" "}),e.forEach(function(n,r){e[r]=n.trim()}),r.push(e.join("\n"))}),r.join("\n")}function u(n,r){var e=n.replace(G.REGEX.IGNORE,""),t=r.replace(G.REGEX.IGNORE,"");return e.length+t.length<=E}var c="Kein passender Begriff gefunden.",s="Keine Begriffe verfügbar.",f="Folgende Begriffe wurden gefunden:",l="Folgende Begriffe sind verfügbar",g="(dsa search $1 [phrase] [-f] [-g])",h="Thema existiert nicht, folgende sind verfügbar:",d="Folgende Themen sind verfügbar:",p="(dsa search [topic] [phrase] [-f] [-g])",m="Keine Daten gefunden!",L="(dsa update [topic] [-f])",v="(dsa update $1 [-f])",E=80,S=null;return{find:n}}();!function(){function n(n,r){switch(r||(Log.line("  Examples:"),Log.empty()),n){case"d":Log.line("    $ dsa d20 3"),Log.line("    $ dsa d6 2 --mod 6");break;case"skill":Log.line("    $ dsa skill 13/16/14 6 -m -1"),Log.line("    $ dsa skill 14/13/15 9 -r 7 --mod=1"),Log.line("    $ dsa skill 12/13/11 4 --probability");break;case"update":Log.line("    $ dsa update --force"),Log.line("    $ dsa update vorteil");break;case"search":Log.line("    $ dsa search"),Log.line("    $ dsa search kultur"),Log.line("    $ dsa search zauber ignifaxius"),Log.line("    $ dsa search kampf wucht --guess"),Log.line('    $ dsa search vorteil "verbessert leben" -fg'),Log.line('    $ dsa search nachteil "schlechte energie" -f')}Log.empty()}Program.version("0.0.1").description("command line tools for 'The Dark Eye'").on("--help",function(){n("d"),n("skill",!0),n("update",!0),n("search",!0)}),[3,4,6,8,10,12,20,100].forEach(function(r){Program.command("d"+r+" [n]").description("roll d"+r+" n times").option("-m, --mod <x>","modify sum by x").action(function(n,e){Dice.roll(r,n,e)}).on("--help",function(){n("d")})}),Program.command("skill <attributes> <value>").description("make skill check").option("-m, --mod <x>","modify check by x").option("-r, --repeat <n>","repeat check n times").option("-p, --probability","show probability of success").action(function(n,r,e){Dice.skill(n,r,e)}).on("--help",function(){n("skill")}),Program.command("search [topic] [phrase]").description("search for phrase in topic").option("-f, --fuzzy","use fuzzy search").option("-g, --guess","guess correct result").action(function(n,r,e){Search.find(n,r,e)}).on("--help",function(){n("search")}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(n,r){Update.start(n,r)}).on("--help",function(){n("update")}),Program.parse(process.argv),Program.args.length||Program.help()}();