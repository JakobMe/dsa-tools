#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{TITLE:"++",BOLD:"==",PARA:"__",ITALIC:"--",BULLET:". ",DELIMITER:"/"},REGEX:{PH:"$1",TITLE:/\+\+(.*?)\+\+/g,BOLD:/==(.*?)==/g,ITALIC:/--(.*?)--/g,PARA:/__/g,IGNORE:/\+\+|==|--|__/g,HASH:/#(?!#)/g,LVL:/ I-.*(I|V|X)/,STAR:/ \(\*\)/,DOTS:/ \.\.\./}}}(),Util=function(){function n(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n){var t=parseInt(n);return isNaN(t)?0:t}function r(n,t){return n.localeCompare(t)}return{randomInt:n,sortAlpha:r,toInt:t}}(),Str=function(){function n(n,t){for(var r=n.toString(),e=n.toString(),o=("undefined"==typeof t?"":t).toString(),i=0;i<o.length-e.length;i++)r=" "+r;return r}function t(n,t,r){return t+n.toString()+r}function r(n,t,r,e){var o=n.toString();return t===r?o.green:t===e?o.red:o}function e(n,t,e){var o=[];return n.forEach(function(n){o.push(r(n,n,t,e))}),o.join(G.STR.DELIMITER)}function o(n,t){return n.toString()+"d"+t.toString()+" "}function i(n){return t(n.join(G.STR.DELIMITER),"(",") ")}function a(n){return t(n,"[","] ")}function u(n){var t=n.toString()+" ";return n<0?t.red:n>0?("+"+t).green:("±"+t).grey.dim}function c(n){var t="×"+n.toString();return n>1?t.grey.dim:t.grey.dim}function f(t,r,e,o){var i=n(t,o),a=n("Σ",e),u=r?": ":" ";return(a+u).grey.dim+i.cyan}function s(t,r,e,o,i){var a=r||e?" ‼":"";a=r?a.green:e?a.red:a.grey.dim;var u="\tQS "+n(t,i);return u=t<o?u.grey.dim:u,u+a+"\t"}function l(t,r){var e="\t"+n(t,r*-1);return t<0?e.red:e.green}function g(n){return t(n,'"','"')}function h(n){return n.toString()+"%"}function d(n,t,r){var e=n/t,o=h(Math.round(100*e)),i=Math.round(e*r),a="=".repeat(i),u=" ".repeat(r-i);return Str.brackets(" "+a.cyan+u+" ")+o.magenta}return{percent:h,progressbar:d,indent:n,enclose:t,roll:r,rolls:e,dice:o,attr:i,brackets:a,mod:u,times:c,sum:f,quality:s,points:l,quote:g}}(),Log=function(){function n(n){f((n||"")+"\n")}function t(n){for(var t=0;t<(n||1);t++)f.previousLine(1),f.eraseLine()}function r(t){t="number"!=typeof t?1:t;for(var r=0;r<t;r++)n("")}function e(t,e,o){r(e),n(t),r(o)}function o(t){t.forEach(function(r,e){n((Str.indent(e+1,t.length)+G.STR.BULLET).grey.dim+r)})}function i(n,t,r,o,i,a){var u=" ".repeat(G.STR.BULLET.length),c=Str.indent("‼",t||0);r=r||!1,o=o||!1,c=r?c.red:o?c.green:c.grey.dim,e(c+u+n,i,a)}function a(n,t,r,e){i(n.red,t,!0,!1,r,e)}function u(n,t,r,e){i(n.toString().grey.dim,t,!1,!1,r,e)}function c(n,t,r,e){i(n.green,t,!1,!0,r,e)}var f=require("terminal-kit").terminal;return{spaced:e,success:c,empty:r,shout:i,error:a,hint:u,line:n,list:o,back:t}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),f=u.join(__dirname+i)}function t(t){n(),a.readFile(c,function(n,r){t(null!==n?{}:r)})}function r(t){n(),a.writeFile(c,t)}function e(t){n(),a.readFile(f,function(n,r){t(null!==n?{}:r)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,f=null;return{config:e,load:t,save:r}}(),Update=function(){function n(n,t){Data.config(function(e){M=require("dns"),X=require("crawler"),C=e.config,q=t.force||!1,U=a(n||""),U!==!1&&u(r)})}function t(n){var t={maxConnections:d,rateLimit:p},r=[],a=[],u=[],s=new X(t),l=new X(t);U.forEach(function(t,e){var s=t.name,l="undefined"==typeof n[s]||q;l&&(n[s]={}),Data.save(n),r[e]=[],t.urls.forEach(function(t,l){r[e][l]=0,u.push({uri:E+t+S,callback:function(t,u,g){if(!t){var h=u.$,d=h(T).filter(function(){var t=c(h(this).text().trim());return t=n[s][t],"undefined"==typeof t});r[e][l]=d.length,o(e,l,r),d.each(function(t){var o=h(this).text().trim();o=c(o);var u=h(this).attr(x);u=encodeURI(u),a.push({uri:v+u,callback:function(a,u,c){a||(n[s][o]=f(u.$,u.$(b)),Data.save(n),i(t,e,l,r,s,o),c())}})}),g()}}})})}),e([l,s],[u,a])}function r(n){n&&Data.load(t)}function e(n,t){var r=n.length;r===t.length&&n.forEach(function(e,o){0===o&&e.queue(t[o]),e.on(R,function(){o+1<r&&n[o+1].queue(t[o+1])})})}function o(n,t,r){var e=0,o=0,i=1+t;r.forEach(function(t,r){e+=t.length,i+=r<n?t.length:0,t.forEach(function(n,t){o+=n})});var a=o+" "+l,u=Str.progressbar(i,e,m);Log.empty(1===i?2:0),Log.back(1===i?0:3),Log.success(a,0,0,0),Log.shout(u,0,!1,!1,0,1)}function i(n,t,r,e,o,i){var a=0,u=1+n;e.forEach(function(n,e){n.forEach(function(n,o){a+=n,u+=e===t&&o<r||e<t?n:0})});var c=u+"/"+a+" ",f=o+" "+Str.quote(i),s=Str.progressbar(u,a,m);Log.empty(1===u?1:0),Log.back(1===u?0:3),Log.success(c+f,0,0,0),Log.shout(s,0,!1,!1,0,1)}function a(n){var t=[],r=[],e=[];return C.forEach(function(o){t.push(o.name),e.push(o),o.name===n.toLowerCase()&&r.push(o)}),n.length?r.length?r:(Log.error(g,t.length,1,0),Log.hint(h,t.length,0,1),Log.list(t),Log.empty(),!1):e}function u(n){M.lookup(L,function(t){t?(Log.error(s,0,1,0),Log.hint(L,0,0,1),n(!1)):n(!0)})}function c(n){return n=n.replace(G.REGEX.LVL,""),n=n.replace(G.REGEX.STAR,""),n=n.replace(G.REGEX.DOTS,"")}function f(n,t){function r(){return 3===this.nodeType}function e(){return!n(this).text().trim().length}if(!t.length)return"";t.contents().filter(r).remove(),t.children().filter(e).remove(),t.html(t.html().split(w).join(D)),t.find(y).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.TITLE,G.STR.TITLE+G.STR.PARA))}),t.find(I).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.BOLD,G.STR.BOLD))}),t.find(A).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.ITALIC,G.STR.ITALIC))}),t.find(k).each(function(){n(this).replaceWith(G.STR.PARA)}),t.find(P).each(function(){n(this).replaceWith(Str.enclose(n(this).text(),G.STR.PARA,G.STR.PARA))});var o=t.text().trim();return o=o.replace(G.REGEX.HASH,""),o.substr(0,o.length-G.STR.PARA.length)}var s="Verbindungsfehler!",l="neue Begriffe gefunden",g="Thema existiert nicht, folgende sind verfügbar:",h="(dsa update [topic] [-f])",d=1,p=0,m=15,L="ulisses-regelwiki.de",v="http://www.ulisses-regelwiki.de/",E="http://www.ulisses-regelwiki.de/index.php/",S=".html",R="drain",T="td > a",b="#main .ce_text",y="h1",I="strong",A="em",P="p",k="br",x="href",w="<br>",D="<br/>",M=null,X=null,U=!1,q=!1,C=null;return{start:n}}(),Dice=function(){function n(n,t,r){t=Math.max(Util.toInt(t),1);var e=Util.toInt(r.mod),i=t>1||e,a=[],u=0;o(t,n).forEach(function(t,r){u+=t;var e=Str.indent(t,n);a.push(Str.roll(e,t,R,n))}),Log.spaced(Str.dice(t,n)+Str.mod(e)),Log.list(a),Log.spaced(i?Str.sum(u+e,!0):"",i?1:0)}function t(n,t,o){t=Math.max(Util.toInt(t),0),n=e(n);var f=Util.toInt(o.mod),g=o.probability||!1,h=Math.max(Util.toInt(o.repeat),1);h=g?0:h;var d=u(n,t,f);d=Str.percent(d);var p=h>1,m=!1,v=!1,G=!1,T=[],b=0,I=0;if(n.length!==L)Log.error(l,0,1,0),Log.hint(s,0,0,1);else{for(var P=0;P<h;P++){var k=i(n,t,f,b),x=k.results,w=k.points,D=c(x,S),M=c(x,R),X=a(w,M,D,p),U=X<A;if(v=!!v||D,G=!!G||M,m=!!m||U,I=D?X:I+X,b=M?0:U?b+1:b,T.push(Str.rolls(x,R,E)+Str.points(w,L*E)+Str.quality(X,M,D,A,y)+Str.sum(I,!1,0,y*h)),D)break}if(Log.spaced(Str.dice(Str.indent(L,T.length),E)+Str.attr(n).magenta+Str.mod(f)+Str.brackets(t).magenta+Str.times(h)+" "+(g?d.cyan:d.grey.dim)),g)return;Log.list(T),r(T.length,G,m,v)}}function r(n,t,r,e){var o=!1,i=!1,a=n>1,u=!a&&r,c=!a&&!r;a||r||(i=m.green),!a&&r&&(i=p.red),a&&r&&(i=h.grey.dim),t&&(o=d.green),e&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,e,t,0,1),o||Log.empty()}function e(n){var t=[];return n.split(G.STR.DELIMITER).forEach(function(n){t.push(Math.max(Util.toInt(n),0))}),t}function o(n,t){for(var r=[],e=0;e<n;e++)r.push(Util.randomInt(1,t));return r}function i(n,t,r,e){var i=o(n.length,E),a=f(i,n,t,r,e);return{results:i,points:a}}function a(n,t,r,e){var o=Math.ceil(n/b),i=t?A:I,a=t&&e?T:r?0:1,u=0===n?A:o;return Math.max(Math.min(u*a,y),i)}function u(n,t,r){for(var e=0,o=1;o<=E;o++)for(var i=1;i<=E;i++)for(var a=1;a<=E;a++)if(c([o,i,a],R))e++;else if(!c([o,i,a],R)){var u=f([o,i,a],n,t,r,0);e+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(E,L))*e*100*100)/100}function c(n,t){var r=0;return n.forEach(function(n){r+=n===t?1:0}),r>=v}function f(n,t,r,e,o){var i=r+0;return n.forEach(function(n,r){i-=Math.max(0,n-(t[r]+e-o))}),i}var s="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",p="Erfolgsprobe misslungen",m="Erfolgsprobe bestanden",L=3,v=2,E=20,S=20,R=1,T=2,b=3,y=6,I=0,A=1;return{roll:n,skill:t}}(),Search=function(){function n(n,r,o){S=require("didyoumean"),S.nullResultValue=!1,r=(r||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.guess||!1,a=o.fuzzy||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=e(n,u),f=0===n.length,s=u.length,l=f?d.green:h.red;s&&c?t(o[c],r,c,a,i):s?(Log.shout(l,s,!f,f),Log.list(u),Log.hint(p,s)):(Log.error(m,s,1,0),Log.hint(L,s,0,1))})}function t(n,t,e,a,u){var h=0===t.length,d=Object.keys(n),p=!1,m=[],L=h?l:s,E=g.replace(G.REGEX.PH,e),S=v.replace(G.REGEX.PH,e);d.forEach(function(n){t===n.toLowerCase()?p=n:r(t,n,a)&&m.push(n)}),m.sort(Util.sortAlpha);var R=p?p:o(t,m,u),T=m.length;R?Log.spaced(i(n[R])):T?(Log.success(L,T),Log.list(m),Log.hint(E,T)):h&&!T?(Log.error(f,T,1,0),Log.hint(S,T,0,1)):(Log.error(c,T,1,0),Log.hint(E,T,0,1))}function r(n,t,r){var e=r?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),t=t.toLowerCase(),n.indexOf(t)!==-1||e(n,t)||t.indexOf(n)!==-1||e(t,n)}function e(n,t){return t.indexOf(n)>=0?n:S(n,t)}function o(n,t,r){return S.threshold=null,S.thresholdAbsolute=100,!!r&&S(n,t)}function i(n){return n=a(n),n=n.replace(G.REGEX.PARA,"\n"),n=n.replace(G.REGEX.TITLE,G.REGEX.PH.green),n=n.replace(G.REGEX.BOLD,G.REGEX.PH.magenta),n=n.replace(G.REGEX.ITALIC,G.REGEX.PH.cyan)}function a(n){var t=[];return n.split(G.STR.PARA).forEach(function(n){var r=[""],e=0;n.split(" ").forEach(function(n){u(n,r[e])||(r[++e]=""),r[e]+=n+" "}),r.forEach(function(n,t){r[t]=n.trim()}),t.push(r.join("\n"))}),t.join(G.STR.PARA)}function u(n,t){var r=n.replace(G.REGEX.IGNORE,""),e=t.replace(G.REGEX.IGNORE,"");return r.length+e.length<E}var c="Kein passender Begriff gefunden.",f="Keine Begriffe verfügbar.",s="Folgende Begriffe wurden gefunden:",l="Folgende Begriffe sind verfügbar",g="(dsa search $1 [phrase] [-f] [-g])",h="Thema existiert nicht, folgende sind verfügbar:",d="Folgende Themen sind verfügbar:",p="(dsa search [topic] [phrase] [-f] [-g])",m="Keine Daten gefunden!",L="(dsa update [topic] [-f])",v="(dsa update $1 [-f])",E=80,S=null;return{find:n}}();!function(){Program.version("0.0.1").description("CLI tools for The Dark Eye"),[3,4,6,8,10,12,20,100].forEach(function(n){Program.command("d"+n+" [n]").description("roll d"+n+" n times").option("-m, --mod <x>","modify sum by x").action(function(t,r){Dice.roll(n,t,r)})}),Program.command("skill <attributes> <value>").description("make skill check").option("-m, --mod <x>","modify check by x").option("-r, --repeat <n>","repeat check n times").option("-p, --probability","show probability of success").action(function(n,t,r){Dice.skill(n,t,r)}),Program.command("search [topic] [phrase]").description("search for phrase in topic").option("-f, --fuzzy","use fuzzy search").option("-g, --guess","guess correct result").action(function(n,t,r){Search.find(n,t,r)}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(n,t){Update.start(n,t)}),Program.parse(process.argv),Program.args.length||Program.help()}();