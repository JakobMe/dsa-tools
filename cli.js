#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),Terminal=require("terminal-kit").terminal,G=function(){return{MOD_MIN:0,SKILL_MIN:0,ATTR_MIN:0,ROLLS_MIN:1,ROLLS_ATTR:3,ROLLS_TO_CRIT:2,D_20:20,ROLL_SLIP:20,ROLL_CRIT:1,QUAL_MULTIPLY:2,QUAL_DIVIDE:3,QUAL_MAX:6,QUAL_MIN:0,QUAL_SUCCESS:1,CODE_T:"++",CODE_B:"==",CODE_P:"__",CODE_I:"--",REGEX_REPLACE:"$1",REGEX_H:/\+\+(.*?)\+\+/g,REGEX_B:/==(.*?)==/g,REGEX_I:/--(.*?)--/g,REGEX_P:/__/g,REGEX_HASH:/#(?!#)/g,REGEX_LVL:/ I-.*(I|V|X)/,REGEX_STAR:/ \(\*\)/,REGEX_DOTS:/ \.\.\./}}(),F=function(){function t(t,n){return Math.floor(Math.random()*(n-t+1))+t}function n(t,n){var r=parseInt(t);return isNaN(r)&&(r=n),r}function r(r,e){for(var i=[],o=0;o<n(e,G.ROLLS_MIN);o++)i.push(t(1,r));return i}function e(t){var r=[];return t.split("/").forEach(function(t){r.push(n(t,G.ATTR_MIN))}),r}function i(t,n){for(var r=t.toString().length,e=n.toString().length,i=0;i<e-r;i++)t=" "+t;return t.toString()}function o(t){Terminal((t||"")+"\n")}function a(t){for(var n=0;n<(t||1);n++)Terminal.previousLine(1),Terminal.eraseLine()}function u(t){for(var n=0;n<(t||1);n++)o("")}function c(t,n,r){o((i(t,n)+". ").grey.dim+r)}function s(t,n,r,e){var a=i("‼",n);r=r||!1,e=e||!1,a=r?a.red:e?a.green:a.grey.dim,o(a+"  "+t)}function l(t,n,r,e,i){return t=t.toString(),n===r?t.green:n===e?t.red:i===!0?t.grey:t}function p(t,n,r){var e=[];return t.forEach(function(t){e.push(l(t.toString(),t,n,r,!0))}),e.join("/".grey)}function f(t,n){return t.toString().yellow+"w"+n.toString()+" "}function g(t){return"("+t.join("/").magenta+") "}function d(t){return"["+t.toString().magenta+"] "}function m(t){var n=t.toString()+" ";return t<G.MOD_MIN?n.red:t>G.MOD_MIN?("+"+n).green:("±"+n).grey.dim}function E(t){var n="×"+t.toString();return t>G.ROLLS_MIN?n.yellow:n.grey.dim}function h(t,n,r,e){var o=i("Σ",r||0)+(n?": ":" ");return o.grey.dim+i(t,e||0).cyan}function F(t,n,r){var e=n||r?" ‼":"";e=n?e.green:r?e.red:e.grey.dim;var o="\tQS "+i(t,G.QUAL_MAX);return o=t<G.QUAL_SUCCESS?o.grey.dim:o,o+e+"\t"}function L(t){var n=(-(G.D_20*G.ROLLS_ATTR)).toString(),r="\t"+i(t,n);return t<G.SKILL_MIN?r.red:r.green}function _(t){return"„"+t.toString()+"“"}function y(t){return _(t).yellow+" — ".grey.dim}function M(t,n){var r=0;return t.forEach(function(t){r+=t===n?1:0}),r}function R(t,n,r,e){var i=Math.ceil(t/G.QUAL_DIVIDE),o=n?G.QUAL_SUCCESS:G.QUAL_MIN,a=n&&e?G.QUAL_MULTIPLY:r?0:1,u=t===G.SKILL_MIN?G.QUAL_SUCCESS:i;return Math.max(Math.min(u*a,G.QUAL_MAX),o)}function v(t){return t=t.replace(G.REGEX_P,"\n"),t=t.replace(G.REGEX_H,G.REGEX_REPLACE.green),t=t.replace(G.REGEX_B,G.REGEX_REPLACE.blue),t=t.replace(G.REGEX_I,G.REGEX_REPLACE.yellow)}function I(t,n,r){return n+t+r}function S(t,n){return t.localeCompare(n)}return{printEmpty:u,printLine:o,printList:c,printMsg:s,printUp:a,formatOutput:v,splitAttr:e,rollDice:r,countRolls:M,calcQuality:R,strQuote:_,strKeyword:y,strQuality:F,strPoints:L,strRepeat:E,strRolls:p,strDice:f,strRoll:l,strAttr:g,strVal:d,strSum:h,strMod:m,toInt:n,indent:i,enclose:I,sortAlpha:S}}(),Data=function(){function t(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+i),s=u.join(__dirname+o)}function n(n){t(),a.readFile(c,function(t,r){n(null!==t?{}:r)})}function r(n){t();a.writeFile(c,n)}function e(n){t(),a.readFile(s,function(t,r){n(null!==t?{}:r)})}var i="/data.json",o="/config.json",a=null,u=null,c=null,s=null;return{load:n,save:r,config:e}}(),Update=function(){function t(t,n){Data.config(function(e){x=require("dns"),Q=require("crawler"),q=e.config,j=n.force,B=s(t||""),B!==!1&&l(r)})}function n(t){F.printEmpty(2),o();var n={maxConnections:_,rateLimit:y},r=0,a=[],u=[],c=[],s=new Q(n),l=new Q(n);B.forEach(function(n,e){var o=n.name,s="undefined"==typeof t[o]||j;s&&(t[o]={}),Data.save(t),a[e]=[],n.urls.forEach(function(n,s){a[e][s]=0,c.push({uri:S+n+O,callback:function(n,c,l){if(!n){var g=c.$,d=g(C).filter(function(){var n=p(g(this).text().trim());return n=t[o][n],"undefined"==typeof n}),m=d.length;r=m>r?m:r,a[e][s]=m,d.each(function(n){var r=g(this).text().trim();r=p(r);var c=g(this).attr(N);c=encodeURI(c),u.push({uri:I+c,callback:function(u,c,l){u||(t[o][r]=f(c.$,c.$(A)),Data.save(t),i(n,e,s,a,o,r),l())}})}),l()}}})})}),e([l,s],[c,u])}function r(t){t&&Data.load(n)}function e(t,n){var r=t.length;r===n.length&&t.forEach(function(e,i){0===i&&e.queue(n[i]),e.on(D,function(){if(0===i){var e=n[i+1].length;0===e?c():a(e)}i+1<r&&t[i+1].queue(n[i+1]),i===r-1&&u(n[i].length)})})}function i(t,n,r,e,i,o){var a=0,u=1+t;e.forEach(function(t,e){t.forEach(function(t,i){u+=e===n&&i<r||e<n?t:0,a+=t})});var c=i+" "+F.strQuote(o);F.printUp(),F.printList(u,a,c.grey.dim)}function o(){var t=0;z=setInterval(function(){t=t>=M?0:t+1,F.printUp(),F.printLine(".".repeat(t).green)},R)}function a(t){clearInterval(z);var n=d.replace(G.REGEX_REPLACE,t);F.printUp(),F.printMsg(n.green,t,!1,!0),F.printEmpty()}function u(t){F.printUp(),F.printMsg(m.green,t,!1,!0),F.printEmpty()}function c(){clearInterval(z),F.printUp(),F.printMsg(E.green,0,!1,!0),F.printEmpty()}function s(t){var n=[],r=[];if(q.forEach(function(e){r.push(e),e.name===t.toLowerCase()&&n.push(e)}),0===t.length)return r;if(0===n.length){var e=r.length;return F.printEmpty(),F.printMsg(h.red,e,!0),F.printMsg(L.grey.dim,e),F.printEmpty(),r.forEach(function(t,n){F.printList(n+1,e,t.name)}),F.printEmpty(),!1}return n}function l(t){x.lookup(v,function(n){n?(F.printEmpty(),F.printMsg(g.red,0,!0),F.printMsg(v.grey.dim,0),F.printEmpty(),t(!1)):t(!0)})}function p(t){return t=t.replace(G.REGEX_LVL,""),t=t.replace(G.REGEX_STAR,""),t=t.replace(G.REGEX_DOTS,"")}function f(t,n){function r(){return 3===this.nodeType}function e(){return 0===t(this).text().trim().length}if(0===n.length)return"";n.contents().filter(r).remove(),n.children().filter(e).remove(),n.html(n.html().split(k).join(X)),n.find(T).each(function(){t(this).replaceWith(F.enclose(t(this).text(),G.CODE_T,G.CODE_T+G.CODE_P))}),n.find(P).each(function(){t(this).replaceWith(F.enclose(t(this).text(),G.CODE_B,G.CODE_B))}),n.find(w).each(function(){t(this).replaceWith(F.enclose(t(this).text(),G.CODE_I,G.CODE_I))}),n.find(b).each(function(){t(this).replaceWith(G.CODE_P)}),n.find(U).each(function(){t(this).replaceWith(F.enclose(t(this).text(),G.CODE_P,G.CODE_P))});var i=n.text().trim();return i=i.replace(G.REGEX_HASH,""),i.substr(0,i.length-G.CODE_P.length)}var g="Verbindungsfehler!",d="Update: $1 neue Begriffe gefunden",m="Update abgeschlossen",E="Begriffe sind auf dem aktuellen Stand",h="Thema existiert nicht, folgende sind verfügbar:",L="(dsa update [topic] [-f])",_=1,y=0,M=3,R=300,v="ulisses-regelwiki.de",I="http://www.ulisses-regelwiki.de/",S="http://www.ulisses-regelwiki.de/index.php/",O=".html",D="drain",C="td > a",A="#main .ce_text",T="h1",P="strong",w="em",U="p",b="br",N="href",k="<br>",X="<br/>",x=null,Q=null,B=!1,j=!1,q=null,z=null;return{start:t}}(),Dice=function(){function t(t,n,r){n=F.toInt(n,G.ROLLS_MIN);var e=F.toInt(r.plus,G.MOD_MIN),i=F.toInt(r.minus,G.MOD_MIN),o=e-i,a=t*n+o;F.printEmpty(),F.printLine(F.strDice(n,t)+F.strMod(e-i)),F.printEmpty(),F.rollDice(t,n).forEach(function(r,e){o+=r;var i=F.strRoll(F.indent(r,a),r,G.ROLL_CRIT,t);F.printList(e+1,n,i)}),F.printEmpty(),(n>G.ROLLS_MIN||e>G.MOD_MIN||i>G.MOD_MIN)&&(F.printLine(F.strSum(o,!0,n,a)),F.printEmpty())}function n(t,n,o){t=F.splitAttr(t),n=F.toInt(n,G.SKILL_MIN);var a=F.toInt(o.plus,G.MOD_MIN),u=F.toInt(o.minus,G.MOD_MIN),c=F.toInt(o.repeat,G.ROLLS_MIN),s=c>G.ROLLS_MIN,l=a-u,p=!1,f=!1,g=!1,d=0,m=0;if(t.length!==G.ROLLS_ATTR)F.printEmpty(),F.printMsg(i.red,0,!0),F.printMsg(e.grey.dim,0),F.printEmpty();else{F.printEmpty(),F.printLine(F.strDice(G.ROLLS_ATTR,G.D_20)+F.strAttr(t)+F.strMod(l)+F.strVal(n)+F.strRepeat(c)),F.printEmpty();for(var E=0;E<c;E++){for(var h=[],L=n+0,_=0;_<t.length;_++){h[_]=F.rollDice(G.D_20,G.ROLLS_MIN)[0];var y=Math.max(G.ATTR_MIN,t[_]+l-d),M=Math.max(G.ATTR_MIN,h[_]-y);L-=M}var R=F.countRolls(h,G.ROLL_SLIP)>=G.ROLLS_TO_CRIT,v=F.countRolls(h,G.ROLL_CRIT)>=G.ROLLS_TO_CRIT,I=F.calcQuality(L,v,R,s),S=I<G.QUAL_SUCCESS;if(f=!!f||R,g=!!g||v,p=!!p||S,m=R?I:m+I,d=v?G.MOD_MIN:S?d+1:d,F.printList(E+1,c,F.strRolls(h,G.ROLL_CRIT,G.ROLL_SLIP)+F.strPoints(L)+F.strQuality(I,v,R)+F.strSum(m,!1,0,G.QUAL_MAX*c)),R)break}F.printEmpty(),r(c,g,p,f)}}function r(t,n,r,e){var i=!1,l=!1,p=t>G.ROLLS_MIN,f=!p&&r,g=!p&&!r;p||r||(l=s.green),!p&&r&&(l=c.red),p&&r&&(l=a.grey.dim),n&&(i=u.green),e&&(i=o.red),l&&F.printMsg(l,t,f,g),i&&F.printMsg(i,t,e,n),(i||l)&&F.printEmpty()}var e="(z.B. 11/13/12)",i="Probe im falschen Format!",o="Patzer (automatisch misslungen)",a="Nach misslungenen Proben Malus kumulativ +1",u="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",c="Erfolgsprobe misslungen",s="Erfolgsprobe bestanden";return{roll:t,skill:n}}(),Search=function(){function t(t,r,e){E=require("didyoumean"),E.nullResultValue=!1,r=r||"",t=t||"";var i=e.lucky||!1,o=e.fuzzy||!1,a=0===t.length;Data.load(function(e){if(F.printEmpty(),Object.keys(e).length>0){var u=[],c=!1;Object.keys(e).forEach(function(n){u.push(n);var r=t.toLowerCase(),e=n.toLowerCase();r===e&&(c=n)}),u.sort(F.sortAlpha);var s=u.length;c=c?c:E(t,u),c?n(e[c],r,c,o,i):(a?F.printMsg(p.cyan,s):F.printMsg(l.red,s,!0),F.printEmpty(),u.forEach(function(t,n){F.printList(n+1,s,t)}),F.printEmpty(),F.printMsg(f.grey.dim,s),F.printEmpty())}else F.printMsg(g.red,0,!0),F.printMsg(d.grey.dim,0),F.printEmpty()})}function n(t,n,l,p,f){var g=0===n.length,d=F.strKeyword(n),E=n.toLowerCase(),h=!1,L=0,_=[],y=s.grey.dim,M=m.grey.dim;y=y.replace(G.REGEX_REPLACE,l),M=M.replace(G.REGEX_REPLACE,l),Object.keys(t).forEach(function(t){var n=t.toLowerCase();return E===n?void(h=t):void(r(E,n,p)&&(_.push(t),L++))}),h=h?h:e(E,_,f),_.sort(F.sortAlpha),h?i(t[h]):L>0?(g?F.printMsg(c.cyan,L):F.printMsg(d+u.cyan,L),F.printEmpty(),_.forEach(function(t,n){F.printList(n+1,L,t)}),F.printEmpty(),F.printMsg(y,L),F.printEmpty()):g?(F.printMsg(a.red,0,!0),F.printMsg(M,L),F.printEmpty()):(F.printMsg(d+o.red,0,!0),F.printMsg(y,L),F.printEmpty())}function r(t,n,r){var e=r?require("fuzzysearch"):function(){return!1};return t=t.toLowerCase(),n=n.toLowerCase(),t.indexOf(n)!==-1||e(t,n)||n.indexOf(t)!==-1||e(n,t)}function e(t,n,r){return E.threshold=null,E.thresholdAbsolute=100,!!r&&E(t,n)}function i(t){F.printLine(F.formatOutput(t)),F.printEmpty()}var o="Kein passender Begriff gefunden.",a="Keine Begriffe verfügbar.",u="Folgende Begriffe wurden gefunden:",c="Folgende Begriffe sind verfügbar",s="(dsa seach $1 [keyword] [-f] [-l])",l="Thema existiert nicht, folgende sind verfügbar:",p="Folgende Themen sind verfügbar:",f="(dsa search [topic] [keyword] [-f] [-l])",g="Keine Daten gefunden!",d="(dsa update [topic] [-f])",m="(dsa update $1 [-f])",E=null;return{find:t}}();!function(){Program.version("0.0.1").description("CLI tools for The Dark Eye"),[2,3,4,6,8,10,12,20,100].forEach(function(t){Program.command("d"+t+" [rolls]").description("roll d"+t).option("-m, --minus <x>","subtract x from sum").option("-p, --plus <x>","add x to sum").action(function(n,r){Dice.roll(t,n,r)})}),Program.command("skill <attributes> <value>").description("roll skill check").option("-m, --minus <x>","modify check by -x").option("-p, --plus <x>","modify check by +x").option("-r, --repeat <n>","repeat check n times").action(function(t,n,r){Dice.skill(t,n,r)}),Program.command("search [topic] [keyword]").description("search for keyword in topic").option("-f, --fuzzy","make fuzzy search").option("-l, --lucky","show best result immediately").action(function(t,n,r){Search.find(t,n,r)}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(t,n){Update.start(t,n)}),Program.parse(process.argv),Program.args.length||Program.help()}();