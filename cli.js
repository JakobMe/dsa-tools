#!/usr/bin/env node
/**
 * DSA-Tools CLI: github.com/JakobMe/dsa-tools
 * @author Jakob Metzger <jakob.me@gmail.com>
 * @copyright 2017 Jakob Metzger
 * @license MIT
 */
var Program=require("commander"),Colors=require("colors"),G=function(){return{STR:{PH:"$1",HEAD_L:"{{",HEAD_R:"}}",BOLD_L:"[[",BOLD_R:"]]",ITAL_L:"((",ITAL_R:"))",BULLET:". ",DELIMITER:"/"},REGEX:{HEAD:/\{\{([\s\S]*?)\}\}/g,BOLD:/\[\[([\s\S]*?)\]\]/g,ITAL:/\(\(([\s\S]*?)\)\)/g,IGNORE:/\[\[|\]\]|\{\{|\}\}|\(\(|\)\)/g,REMOVE:/I-.*(I|V|X)|\(\*\)|\.\.\.|\*/g}}}(),Util=function(){function n(n,r){return Math.floor(Math.random()*(r-n+1))+n}function r(n){var r=parseInt(n);return isNaN(r)?0:r}function t(n,r){return n.localeCompare(r)}return{randomInt:n,sortAlpha:t,toInt:r}}(),Str=function(){function n(n,r){for(var t=n.toString(),e=n.toString(),o=("undefined"==typeof r?"":r).toString(),i=0;i<o.length-e.length;i++)t=" "+t;return t}function r(n,r,t){return r+n.toString()+t}function t(n,r,t,e){var o=n.toString();return r===t?o.green:r===e?o.red:o}function e(n,r,e){var o=[];return n.forEach(function(n){o.push(t(n,n,r,e))}),o.join(G.STR.DELIMITER)}function o(n,r){return n.toString()+"d"+r.toString()+" "}function i(n){return r(n.join(G.STR.DELIMITER),"(",") ")}function a(n){return r(n,"[","] ")}function u(n){var r=n.toString()+" ";return n<0?r.red:n>0?("+"+r).green:("±"+r).grey.dim}function c(n){var r="×"+n.toString();return n>1?r.grey.dim:r.grey.dim}function f(r,t,e,o){var i=n(r,o),a=n("Σ",e),u=t?": ":" ";return(a+u).grey.dim+i.cyan}function s(r,t,e,o,i){var a=t||e?" ‼":"";a=t?a.green:e?a.red:a.grey.dim;var u="\tQS "+n(r,i);return u=r<o?u.grey.dim:u,u+a+"\t"}function l(r,t){var e="\t"+n(r,t*-1);return r<0?e.red:e.green}function g(n){return r(n,'"','"')}function h(n){return n.toString()+"%"}function d(n,r,t){var e=n/r,o=h(Math.round(100*e)),i=Math.round(e*t),a="=".repeat(i),u=" ".repeat(t-i);return Str.brackets(" "+a.cyan+u+" ")+o.magenta}return{percent:h,progressbar:d,indent:n,enclose:r,roll:t,rolls:e,dice:o,attr:i,brackets:a,mod:u,times:c,sum:f,quality:s,points:l,quote:g}}(),Log=function(){function n(n){f((n||"")+"\n")}function r(n){for(var r=0;r<(n||1);r++)f.previousLine(1),f.eraseLine()}function t(r){r="number"!=typeof r?1:r;for(var t=0;t<r;t++)n("")}function e(r,e,o){t(e),n(r),t(o)}function o(r){r.forEach(function(t,e){n((Str.indent(e+1,r.length)+G.STR.BULLET).grey.dim+t)})}function i(n,r,t,o,i,a){var u=" ".repeat(G.STR.BULLET.length),c=Str.indent("‼",r||0);t=t||!1,o=o||!1,c=t?c.red:o?c.green:c.grey.dim,e(c+u+n,i,a)}function a(n,r,t,e){i(n.red,r,!0,!1,t,e)}function u(n,r,t,e){i(n.toString().grey.dim,r,!1,!1,t,e)}function c(n,r,t,e){i(n.green,r,!1,!0,t,e)}var f=require("terminal-kit").terminal;return{spaced:e,success:c,empty:t,shout:i,error:a,hint:u,line:n,list:o,back:r}}(),Data=function(){function n(){u=require("path"),a=require("jsonfile"),c=u.join(__dirname+o),f=u.join(__dirname+i)}function r(r){n(),a.readFile(c,function(n,t){r(null!==n?{}:t)})}function t(r){n(),a.writeFile(c,r)}function e(r){n(),a.readFile(f,function(n,t){r(null!==n?{}:t)})}var o="/data.json",i="/config.json",a=null,u=null,c=null,f=null;return{config:e,load:r,save:t}}(),Update=function(){function n(n,r){Data.config(function(e){A=require("dns"),O=require("crawler"),B=e.config,q=r.force||!1,U=a(n||""),U!==!1&&u(t)})}function r(n){var r={maxConnections:L,rateLimit:v},t=[],a=[],u=[],s=new O(r),l=new O(r);U.forEach(function(r,e){var s=r.name,l="undefined"==typeof n[s]||q;l&&(n[s]={}),Data.save(n),t[e]=[],r.urls.forEach(function(r,l){t[e][l]=0,u.push({uri:R+r+b,callback:function(r,u,g){if(!r){var h=u.$,d=h(I).filter(function(){var r=c(h(this).text().trim());return r=n[s][r],"undefined"==typeof r});t[e][l]=d.length,o(e,l,t),d.each(function(r){var o=h(this).text().trim();o=c(o);var u=h(this).attr(_);u=encodeURI(u),a.push({uri:y+u,callback:function(a,u,c){a||(n[s][o]=f(u.$,u.$(D)),Data.save(n),i(r,e,l,t,s,o),c())}})}),g()}}})})}),e([l,s],[u,a])}function t(n){n&&Data.load(r)}function e(n,r){var t=n.length;t===r.length&&n.forEach(function(e,o){0===o&&e.queue(r[o]),e.on(T,function(){o+1<t&&n[o+1].queue(r[o+1])})})}function o(n,r,t){var e=0,o=0,i=1+r;t.forEach(function(r,t){e+=r.length,i+=t<n?r.length:0,r.forEach(function(n,r){o+=n})});var a=o+" "+d,u=Str.progressbar(i,e,E);Log.empty(1===i?2:0),Log.back(1===i?0:3),Log.success(a,0,0,0),Log.shout(u,0,!1,!1,0,1)}function i(n,r,t,e,o,i){var a=0,u=1+n;e.forEach(function(n,e){n.forEach(function(n,o){a+=n,u+=e===r&&o<t||e<r?n:0})});var c=u+"/"+a+" ",f=o+" "+Str.quote(i),s=Str.progressbar(u,a,E);Log.empty(1===u?1:0),Log.back(1===u?0:3),Log.success(c+f,0,0,0),Log.shout(s,0,!1,!1,0,1)}function a(n){var r=[],t=[],e=[];return B.forEach(function(o){r.push(o.name),e.push(o),o.name===n.toLowerCase()&&t.push(o)}),n.length?t.length?t:(Log.error(p,r.length,1,0),Log.hint(m,r.length,0,1),Log.list(r),Log.empty(),!1):e}function u(n){A.lookup(S,function(r){r?(Log.error(h,0,1,0),Log.hint(S,0,0,1),n(!1)):n(!0)})}function c(n){return n.replace(G.REGEX.REMOVE,"").trim()}function f(n,r){return r.length?(g(n,r),s(n,r,P,"\n"),l(n,r,x,G.STR.BOLD_L,G.STR.BOLD_R),l(n,r,w,G.STR.ITAL_L,G.STR.ITAL_R),l(n,r,k,G.STR.HEAD_L,G.STR.HEAD_R,"\n"),l(n,r,M,"\n","\n"),r.text().trim()):""}function s(n,r,t,e){r.find(t).replaceWith(e)}function l(n,r,t,e,o,i){r.find(t).each(function(){var r=n(this);r.replaceWith(Str.enclose(r.text(),e,o+(i||"")))})}function g(n,r){r.contents().filter(function(){var r=3===this.nodeType,t=0===n(this).text().trim().length;return t||r}).remove()}var h="Verbindungsfehler!",d="neue Begriffe gefunden",p="Thema existiert nicht, folgende sind verfügbar:",m="(dsa update [topic] [-f])",L=1,v=0,E=15,S="ulisses-regelwiki.de",y="http://www.ulisses-regelwiki.de/",R="http://www.ulisses-regelwiki.de/index.php/",b=".html",T="drain",I="td > a",D="#main .ce_text",k="h1",x="strong",w="em",M="p",P="br",_="href",A=null,O=null,U=!1,q=!1,B=null;return{start:n}}(),Dice=function(){function n(n,r,t){r=Math.max(Util.toInt(r),1);var e=Util.toInt(t.mod),i=r>1||e,a=[],u=0;o(r,n).forEach(function(r,t){u+=r;var e=Str.indent(r,n);a.push(Str.roll(e,r,y,n))}),Log.spaced(Str.dice(r,n)+Str.mod(e)),Log.list(a),Log.spaced(i?Str.sum(u+e,!0):"",i?1:0)}function r(n,r,o){r=Math.max(Util.toInt(r),0),n=e(n);var f=Util.toInt(o.mod),g=o.probability||!1,h=Math.max(Util.toInt(o.repeat),1);h=g?0:h;var d=u(n,r,f);d=Str.percent(d);var p=h>1,m=!1,v=!1,R=!1,b=[],G=0,I=0;if(n.length!==L)Log.error(l,0,1,0),Log.hint(s,0,0,1);else{for(var k=0;k<h;k++){var x=i(n,r,f,G),w=x.results,M=x.points,P=c(w,S),_=c(w,y),A=a(M,_,P,p),O=A<D;if(v=!!v||P,R=!!R||_,m=!!m||O,I=P?A:I+A,G=_?0:O?G+1:G,b.push(Str.rolls(w,y,E)+Str.points(M,L*E)+Str.quality(A,_,P,D,T)+Str.sum(I,!1,0,T*h)),P)break}if(Log.spaced(Str.dice(Str.indent(L,b.length),E)+Str.attr(n).magenta+Str.mod(f)+Str.brackets(r).magenta+Str.times(h)+" "+(g?d.cyan:d.grey.dim)),g)return;Log.list(b),t(b.length,R,m,v)}}function t(n,r,t,e){var o=!1,i=!1,a=n>1,u=!a&&t,c=!a&&!t;a||t||(i=m.green),!a&&t&&(i=p.red),a&&t&&(i=h.grey.dim),r&&(o=d.green),e&&(o=g.red),!i&&o&&Log.empty(),i&&Log.shout(i,n,u,c,1,0),o&&Log.shout(o,n,e,r,0,1),o||Log.empty()}function e(n){var r=[];return n.split(G.STR.DELIMITER).forEach(function(n){r.push(Math.max(Util.toInt(n),0))}),r}function o(n,r){for(var t=[],e=0;e<n;e++)t.push(Util.randomInt(1,r));return t}function i(n,r,t,e){var i=o(n.length,E),a=f(i,n,r,t,e);return{results:i,points:a}}function a(n,r,t,e){var o=Math.ceil(n/b),i=r?D:I,a=r&&e?R:t?0:1,u=0===n?D:o;return Math.max(Math.min(u*a,T),i)}function u(n,r,t){for(var e=0,o=1;o<=E;o++)for(var i=1;i<=E;i++)for(var a=1;a<=E;a++)if(c([o,i,a],y))e++;else if(!c([o,i,a],y)){var u=f([o,i,a],n,r,t,0);e+=u>=0?1:0}return Math.round(1/parseFloat(Math.pow(E,L))*e*100*100)/100}function c(n,r){var t=0;return n.forEach(function(n){t+=n===r?1:0}),t>=v}function f(n,r,t,e,o){var i=t+0;return n.forEach(function(n,t){i-=Math.max(0,n-(r[t]+e-o))}),i}var s="(z.B. 11/13/12)",l="Probe im falschen Format!",g="Patzer (automatisch misslungen)",h="Nach misslungenen Proben Malus kumulativ +1",d="Krit. Erfolg (bei Sammelprobe QS×2, Malus 0)",p="Erfolgsprobe misslungen",m="Erfolgsprobe bestanden",L=3,v=2,E=20,S=20,y=1,R=2,b=3,T=6,I=0,D=1;return{roll:n,skill:r}}(),Search=function(){function n(n,t,o){S=require("didyoumean"),S.nullResultValue=!1,t=(t||"").toLowerCase(),n=(n||"").toLowerCase();var i=o.guess||!1,a=o.fuzzy||!1;Data.load(function(o){var u=Object.keys(o).sort(Util.sortAlpha),c=e(n,u),f=0===n.length,s=u.length,l=f?d.green:h.red;s&&c?r(o[c],t,c,a,i):s?(Log.shout(l,s,!f,f),Log.list(u),Log.hint(p,s)):(Log.error(m,s,1,0),Log.hint(L,s,0,1))})}function r(n,r,e,a,u){var h=0===r.length,d=Object.keys(n),p=!1,m=[],L=h?l:s,E=g.replace(G.STR.PH,e),S=v.replace(G.STR.PH,e);d.forEach(function(n){r===n.toLowerCase()?p=n:t(r,n,a)&&m.push(n)}),m.sort(Util.sortAlpha);var y=p?p:o(r,m,u),R=m.length;y?Log.spaced(i(n[y])):R?(Log.success(L,R),Log.list(m),Log.hint(E,R)):h&&!R?(Log.error(f,R,1,0),Log.hint(S,R,0,1)):(Log.error(c,R,1,0),Log.hint(E,R,0,1))}function t(n,r,t){var e=t?require("fuzzysearch"):function(){return!1};return n=n.toLowerCase(),r=r.toLowerCase(),n.indexOf(r)!==-1||e(n,r)||r.indexOf(n)!==-1||e(r,n)}function e(n,r){return r.indexOf(n)>=0?n:S(n,r)}function o(n,r,t){return S.threshold=null,S.thresholdAbsolute=100,!!t&&S(n,r)}function i(n){return n=a(n),n=n.replace(G.REGEX.HEAD,G.STR.PH.green),n=n.replace(G.REGEX.BOLD,G.STR.PH.magenta),n=n.replace(G.REGEX.ITAL,G.STR.PH.cyan)}function a(n){var r=[];return n.split("\n").forEach(function(n){var t=[""],e=0;n.split(" ").forEach(function(n){u(n,t[e])||(t[++e]=""),t[e]+=n+" "}),t.forEach(function(n,r){t[r]=n.trim()}),r.push(t.join("\n"))}),r.join("\n")}function u(n,r){var t=n.replace(G.REGEX.IGNORE,""),e=r.replace(G.REGEX.IGNORE,"");return t.length+e.length<=E}var c="Kein passender Begriff gefunden.",f="Keine Begriffe verfügbar.",s="Folgende Begriffe wurden gefunden:",l="Folgende Begriffe sind verfügbar",g="(dsa search $1 [phrase] [-f] [-g])",h="Thema existiert nicht, folgende sind verfügbar:",d="Folgende Themen sind verfügbar:",p="(dsa search [topic] [phrase] [-f] [-g])",m="Keine Daten gefunden!",L="(dsa update [topic] [-f])",v="(dsa update $1 [-f])",E=80,S=null;return{find:n}}();!function(){Program.version("0.0.1").description("CLI tools for The Dark Eye"),[3,4,6,8,10,12,20,100].forEach(function(n){Program.command("d"+n+" [n]").description("roll d"+n+" n times").option("-m, --mod <x>","modify sum by x").action(function(r,t){Dice.roll(n,r,t)})}),Program.command("skill <attributes> <value>").description("make skill check").option("-m, --mod <x>","modify check by x").option("-r, --repeat <n>","repeat check n times").option("-p, --probability","show probability of success").action(function(n,r,t){Dice.skill(n,r,t)}),Program.command("search [topic] [phrase]").description("search for phrase in topic").option("-f, --fuzzy","use fuzzy search").option("-g, --guess","guess correct result").action(function(n,r,t){Search.find(n,r,t)}),Program.command("update [topic]").description("update search database").option("-f, --force","force update").action(function(n,r){Update.start(n,r)}),Program.parse(process.argv),Program.args.length||Program.help()}();