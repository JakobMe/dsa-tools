#!/usr/bin/env node
"use strict";var program=require("commander"),colors=require("colors"),VERSION="1.0.0",DICE_20="w20",DICE_6="w6",DICE_20_VALUE=20,DICE_6_VALUE=6,ROLLS_MIN=1,ROLL_RESULT_MIN=1,ROLL_CRIT_THRESH=2,MOD_DEFAULT=0,SKILL_MIN=0,SKILL_REST_LENGTH=3,SKILL_LEVEL_THRESH=3,SKILL_LEVEL_LENGTH=2,ATTR_ROLLS=3,ATTR_MIN=8,ATTR_DELIMITER="/",CHAR_TAB="\t",CHAR_BREAK="\r",CHAR_NEWLINE="\n",CHAR_PLACEHOLDER="%s",CHAR_DOT=".",CHAR_SPACE=" ",CHAR_PLUS="+",CHAR_PLUSMINUS="±",CHAR_TIMES="×",CHAR_SUM="Σ",CHAR_COLON=":",CHAR_PAREN_LEFT="(",CHAR_PAREN_RIGHT=")",CHAR_BRACKET_LEFT="[",CHAR_BRACKET_RIGHT="]",CHAR_LEVEL="QS",TEXT_ERROR_ATTR="Wrong attribute format!",TEXT_HINT_ATTR="e.g. 11/13/12",TEXT_HINT_FLOP="Misslungen: Folgeproben kumulativ -1.",TEXT_HINT_FAILURE="Patzer: Sammelprobe misslungen.",TEXT_HINT_SUCCESS="Krit. Erfolg: QS × 2, Erschwernis abgebaut.",Functions=function(){function _(_,R){return _=parseInt(_),isNaN(_)&&(_=R),_}function R(_,R){return Math.floor(Math.random()*(R-_+1))+_}function A(A,E){for(var L=[],o=0;o<_(E,ROLLS_MIN);o++)L.push(R(ROLL_RESULT_MIN,A));return L}return{rollDice:A,convertToInt:_}}(),Commands=function(){function _(_){_=Functions.convertToInt(_,ROLLS_MIN),console.log(CHAR_NEWLINE+CHAR_TAB+CHAR_PLACEHOLDER.yellow+DICE_20+CHAR_NEWLINE,_),Functions.rollDice(DICE_20_VALUE,_).forEach(function(_,R){var A=CHAR_PLACEHOLDER;_===DICE_20_VALUE?A=A.red:_===ROLL_RESULT_MIN&&(A=A.green),console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+CHAR_SPACE+A,R+1,_)}),console.log(CHAR_BREAK)}function R(_,R){_=Functions.convertToInt(_,ROLLS_MIN);var A=Functions.convertToInt(R.plus,MOD_DEFAULT),E=Functions.convertToInt(R.minus,MOD_DEFAULT),L=A-E,o=L+0,C=CHAR_PLACEHOLDER;C=L<0?C.red:L>0?(CHAR_PLUS+C).green:(CHAR_PLUSMINUS+C).grey.dim,console.log(CHAR_NEWLINE+CHAR_TAB+CHAR_PLACEHOLDER.yellow+DICE_6+CHAR_SPACE+C+CHAR_NEWLINE,_,L),Functions.rollDice(DICE_6_VALUE,_).forEach(function(_,R){var A=CHAR_SPACE+CHAR_PLACEHOLDER;_===DICE_6_VALUE?A=A.green:_===ROLL_RESULT_MIN&&(A=A.red),console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+A,R+1,_),o+=_}),_>ROLLS_MIN||L!==MOD_DEFAULT?console.log(CHAR_NEWLINE+CHAR_TAB+(CHAR_SUM+CHAR_COLON).grey.dim+CHAR_SPACE+CHAR_PLACEHOLDER.cyan+CHAR_NEWLINE,o):console.log(CHAR_BREAK)}function A(_,R,A){R=Functions.convertToInt(R,SKILL_MIN);var E=Functions.convertToInt(A.plus,MOD_DEFAULT),L=Functions.convertToInt(A.minus,MOD_DEFAULT),o=Functions.convertToInt(A.repeat,ROLLS_MIN),C=E-L;if(_=_.split(ATTR_DELIMITER),_.length<ATTR_ROLLS)console.log(CHAR_NEWLINE+CHAR_TAB+TEXT_ERROR_ATTR.red),console.log(CHAR_TAB+TEXT_HINT_ATTR.grey+CHAR_NEWLINE);else{_.forEach(function(R,A){_[A]=Functions.convertToInt(R,ATTR_MIN)});var n=CHAR_PLACEHOLDER;n=C<0?n.red:C>0?(CHAR_PLUS+n).green:(CHAR_PLUSMINUS+n).grey.dim;var H=0,T=0,r=CHAR_PLACEHOLDER;r=o>ROLLS_MIN?r.cyan:r.grey.dim,console.log(CHAR_NEWLINE+CHAR_TAB+ATTR_ROLLS.toString().yellow+DICE_20+CHAR_SPACE+CHAR_PAREN_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_PAREN_RIGHT+CHAR_SPACE+n+CHAR_SPACE+CHAR_BRACKET_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_BRACKET_RIGHT+CHAR_SPACE+(CHAR_TIMES+CHAR_PLACEHOLDER).grey.dim+CHAR_NEWLINE,_.join(ATTR_DELIMITER),C,R,o);for(var e=0;e<o;e++){for(var I=R+0,t=[],l=[],s=0,i=0,c=0,a=CHAR_LEVEL+CHAR_SPACE+CHAR_PLACEHOLDER,S=0;S<_.length;S++){var N=_[S],u=Functions.rollDice(DICE_20_VALUE,ROLLS_MIN)[0];t.push(u),I-=Math.max(0,u-Math.max(0,N+C+H));var m=CHAR_PLACEHOLDER;u===DICE_20_VALUE?(i++,l.push(m.red)):u===ROLL_RESULT_MIN?(s++,l.push(m.green)):l.push(m.grey)}var O=0;0===I?O=1:I>0&&(O=Math.ceil(I/SKILL_LEVEL_THRESH)),c=O,T+=O;var D=CHAR_PLACEHOLDER;D=I>=0?D.green:D.red,s>=ROLL_CRIT_THRESH&&(O=Math.max(1,O),c+=O,T+=O,H=0),i>=ROLL_CRIT_THRESH&&(c=0,T=0),I<0&&H--,O<=0&&(a=a.dim.grey.dim),I=I.toString();for(var g=SKILL_REST_LENGTH-I.length,M=0;M<g;M++)I=CHAR_SPACE+I;if(console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+CHAR_SPACE+l[0]+ATTR_DELIMITER.grey+l[1]+ATTR_DELIMITER.grey+l[2]+CHAR_TAB+D+CHAR_TAB+a+CHAR_TAB+CHAR_SUM.grey.dim+CHAR_SPACE+r,e+1,t[0],t[1],t[2],I,c,T),i>=ROLL_CRIT_THRESH)break}o>ROLLS_MIN&&console.log((CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FLOP+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_SUCCESS+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FAILURE).grey.dim),console.log(CHAR_BREAK)}}return{w20:_,w6:R,skill:A}}();program.command("w20 [rolls]").description("roll w20 dice").action(Commands.w20),program.command("w6 [rolls]").description("roll w6 dice").option("-p, --plus <bonus>","bonus to sum of rolls").option("-m, --minus <malus>","malus to sum of rolls").action(Commands.w6),program.command("skill <attr> <value>").description("make a skill-check").option("-r, --repeat <times>","repeat skill-check").option("-m, --minus <malus>","make skill-check harder by malus").option("-p, --plus <bonus>","make skill-check easier by bonus").action(Commands.skill),program.version(VERSION).parse(process.argv);