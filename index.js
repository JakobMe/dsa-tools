#!/usr/bin/env node
"use strict";var program=require("commander"),colors=require("colors"),VERSION="1.0.0",DICE_20="w20",DICE_6="w6",DICE_20_VALUE=20,DICE_6_VALUE=6,ROLLS_MIN=1,ROLL_RESULT_MIN=1,ROLL_CRIT_THRESH=2,MOD_DEFAULT=0,SKILL_MIN=0,SKILL_REST_LENGTH=3,SKILL_LEVEL_THRESH=3,SKILL_LEVEL_LENGTH=2,ATTR_ROLLS=3,ATTR_MIN=8,ATTR_DELIMITER="/",CHAR_TAB="\t",CHAR_BREAK="\r",CHAR_NEWLINE="\n",CHAR_PLACEHOLDER="%s",CHAR_DOT=".",CHAR_SPACE=" ",CHAR_PLUS="+",CHAR_PLUSMINUS="±",CHAR_TIMES="×",CHAR_SUM="Σ",CHAR_COLON=":",CHAR_PAREN_LEFT="(",CHAR_PAREN_RIGHT=")",CHAR_BRACKET_LEFT="[",CHAR_BRACKET_RIGHT="]",CHAR_LEVEL="QS",TEXT_ERROR_ATTR="Wrong attribute format!",TEXT_HINT_ATTR="e.g. 11/13/12",TEXT_HINT_FLOP="Misslungen: Folgeproben kumulativ -1.",TEXT_HINT_FAILURE="Patzer: Sammelprobe misslungen.",TEXT_HINT_SUCCESS="Krit. Erfolg: QS × 2, Erschwernis abgebaut.",Func=function(){function _(_,R){var A=parseInt(_);return isNaN(A)&&(A=R),A}function R(_,R){return Math.floor(Math.random()*(R-_+1))+_}function A(A,E){for(var L=[],C=0;C<_(E,ROLLS_MIN);C++)L.push(R(ROLL_RESULT_MIN,A));return L}return{rollDice:A,toInt:_}}(),Commands=function(){function _(_){_=Func.toInt(_,ROLLS_MIN),console.log(CHAR_NEWLINE+CHAR_TAB+CHAR_PLACEHOLDER.yellow+DICE_20+CHAR_NEWLINE,_),Func.rollDice(DICE_20_VALUE,_).forEach(function(_,R){var A=CHAR_PLACEHOLDER;_===DICE_20_VALUE?A=A.red:_===ROLL_RESULT_MIN&&(A=A.green),console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+CHAR_SPACE+A,R+1,_)}),console.log(CHAR_BREAK)}function R(_,R){_=Func.toInt(_,ROLLS_MIN);var A=Func.toInt(R.plus,MOD_DEFAULT),E=Func.toInt(R.minus,MOD_DEFAULT),L=A-E,C=L+0,H=CHAR_PLACEHOLDER;H=L<0?H.red:L>0?(CHAR_PLUS+H).green:(CHAR_PLUSMINUS+H).grey.dim,console.log(CHAR_NEWLINE+CHAR_TAB+CHAR_PLACEHOLDER.yellow+DICE_6+CHAR_SPACE+H+CHAR_NEWLINE,_,L),Func.rollDice(DICE_6_VALUE,_).forEach(function(_,R){var A=CHAR_SPACE+CHAR_PLACEHOLDER;_===DICE_6_VALUE?A=A.green:_===ROLL_RESULT_MIN&&(A=A.red),console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+A,R+1,_),C+=_}),_>ROLLS_MIN||L!==MOD_DEFAULT?console.log(CHAR_NEWLINE+CHAR_TAB+(CHAR_SUM+CHAR_COLON).grey.dim+CHAR_SPACE+CHAR_PLACEHOLDER.cyan+CHAR_NEWLINE,C):console.log(CHAR_BREAK)}function A(_,R,A){R=Func.toInt(R,SKILL_MIN);var E=Func.toInt(A.plus,MOD_DEFAULT),L=Func.toInt(A.minus,MOD_DEFAULT),C=Func.toInt(A.sammel,ROLLS_MIN),H=E-L;if(_=_.split(ATTR_DELIMITER),_.length<ATTR_ROLLS)console.log(CHAR_NEWLINE+CHAR_TAB+TEXT_ERROR_ATTR.red),console.log(CHAR_TAB+TEXT_HINT_ATTR.grey+CHAR_NEWLINE);else{_.forEach(function(R,A){_[A]=Func.toInt(R,ATTR_MIN)});var n=CHAR_PLACEHOLDER;n=H<0?n.red:H>0?(CHAR_PLUS+n).green:(CHAR_PLUSMINUS+n).grey.dim;var r=0,o=0,e=CHAR_PLACEHOLDER;e=C>ROLLS_MIN?e.cyan:e.grey.dim,console.log(CHAR_NEWLINE+CHAR_TAB+ATTR_ROLLS.toString().yellow+DICE_20+CHAR_SPACE+CHAR_PAREN_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_PAREN_RIGHT+CHAR_SPACE+n+CHAR_SPACE+CHAR_BRACKET_LEFT+CHAR_PLACEHOLDER.magenta+CHAR_BRACKET_RIGHT+CHAR_SPACE+(CHAR_TIMES+CHAR_PLACEHOLDER).grey.dim+CHAR_NEWLINE,_.join(ATTR_DELIMITER),H,R,C);for(var T=0;T<C;T++){for(var I=R+0,l=[],t=[],a=0,S=0,i=0,N=CHAR_LEVEL+CHAR_SPACE+CHAR_PLACEHOLDER,s=0;s<_.length;s++){var c=_[s],u=Func.rollDice(DICE_20_VALUE,ROLLS_MIN)[0];l.push(u),I-=Math.max(0,u-Math.max(0,c+H+r));var m=CHAR_PLACEHOLDER;u===DICE_20_VALUE?(S++,t.push(m.red)):u===ROLL_RESULT_MIN?(a++,t.push(m.green)):t.push(m.grey)}var O=0;0===I?O=1:I>0&&(O=Math.ceil(I/SKILL_LEVEL_THRESH)),i=O,o+=O;var g=CHAR_PLACEHOLDER;g=I>=0?g.green:g.red,a>=ROLL_CRIT_THRESH&&(O=Math.max(1,O),i+=O,o+=O,r=0),S>=ROLL_CRIT_THRESH&&(i=0,o=0),I<0&&r--,O<=0&&(N=N.dim.grey.dim),I=I.toString();for(var D=SKILL_REST_LENGTH-I.length,P=0;P<D;P++)I=CHAR_SPACE+I;if(console.log(CHAR_TAB+(CHAR_PLACEHOLDER+CHAR_DOT).grey.dim+CHAR_SPACE+t[0]+ATTR_DELIMITER.grey+t[1]+ATTR_DELIMITER.grey+t[2]+CHAR_TAB+g+CHAR_TAB+N+CHAR_TAB+CHAR_SUM.grey.dim+CHAR_SPACE+e,T+1,l[0],l[1],l[2],I,i,o),S>=ROLL_CRIT_THRESH)break}C>ROLLS_MIN&&console.log((CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FLOP+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_SUCCESS+CHAR_NEWLINE+CHAR_TAB+TEXT_HINT_FAILURE).grey.dim),console.log(CHAR_BREAK)}}return{w20:_,w6:R,skill:A}}();program.command("w20 [würfel]").description("Anzahl an W20 würfeln").action(Commands.w20),program.command("w6 [würfel]").description("Anzahl an W6 würfeln").option("-p, --plus <bonus>","Bonus zur Summe der Würfel").option("-m, --minus <malus>","Malus zur Summe der Würfel").action(Commands.w6),program.command("probe <eigenschaften> <fw>").description("Eine Fertigkeitsprobe würfeln").option("-s, --sammel <versuche>","Sammelprobe mit Anzahl an Versuchen").option("-m, --minus <malus>","Erschwernis auf Probe").option("-p, --plus <bonus>","Erleichterung auf Probe").action(Commands.skill),program.version(VERSION).parse(process.argv);